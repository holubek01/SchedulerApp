<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CreatePlanController.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Scheduler</a> &gt; <a href="index.source.html" class="el_package">com.example.scheduler.controller</a> &gt; <span class="el_source">CreatePlanController.kt</span></div><h1>CreatePlanController.kt</h1><pre class="source lang-java linenums">package com.example.scheduler.controller

import com.example.scheduler.controller.exceptions.EmptyPlanException
import com.example.scheduler.controller.exceptions.MissingValueException
import com.example.scheduler.controller.observers.PlansObserver
import com.example.scheduler.controller.observers.TabsObserver
import com.example.scheduler.models.PlansModel
import com.example.scheduler.models.ClassesToWrite
import com.example.scheduler.utils.*
import io.github.palexdev.materialfx.controls.*
import io.github.palexdev.materialfx.controls.cell.MFXDateCell
import io.github.palexdev.materialfx.dialogs.MFXStageDialog
import javafx.collections.FXCollections
import javafx.fxml.FXML
import javafx.scene.control.Label
import javafx.stage.Stage
import java.sql.SQLException
import java.time.DayOfWeek
import java.time.LocalDate
import java.util.function.Function

/**
 * Klasa kontrolera do tworzenia planu zajęć.
 */
<span class="fc" id="L25">class CreatePlanController: ICreatePlanController, PlansObserver, TabsObserver {</span>

    /**
     * Etykieta aktywnego planu.
     */
<span class="nc bnc" id="L30" title="All 2 branches missed.">    lateinit var activePlanLabel: Label</span>

    /**
     * Przycisk do dodawania zajęć.
     */
    @FXML
<span class="pc bpc" id="L36" title="1 of 2 branches missed.">    internal lateinit var addClassesButton: MFXButton</span>

    /**
     * Przycisk do zapisywania planu.
     */
    @FXML
<span class="pc bpc" id="L42" title="1 of 2 branches missed.">    internal lateinit var savePlanButton: MFXButton</span>

    /**
     * Przycisk do zamykania planu.
     */
    @FXML
<span class="pc bpc" id="L48" title="1 of 2 branches missed.">    internal lateinit var closePlanButton: MFXButton</span>

    /**
     * Przycisk do usuwania aktualnego planu.
     */
    @FXML
<span class="pc bpc" id="L54" title="1 of 2 branches missed.">    internal lateinit var deletePlanButton: MFXButton</span>

    /**
     * Kontrolka służąca do wyboru daty.
     */
    @FXML
<span class="pc bpc" id="L60" title="1 of 2 branches missed.">    internal lateinit var datepicker:MFXDatePicker</span>

    /**
     * Kontrolka wyboru kierunku kształcenia.
     */
    @FXML
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">    internal lateinit var fieldOfStudyChoiceBox: MFXComboBox&lt;String&gt;</span>

    /**
     * Pomocnicze okno dialogowe.
     */
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">    lateinit var dialog: MFXStageDialog</span>

    /**
     * Kontrolka wyboru planu, który użytkownik chce przywrócić.
     */
    @FXML
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">    internal lateinit var getPlanChoiceBox: MFXComboBox&lt;String&gt;</span>

    /**
     * Przycisk przywracania wybranego planu.
     */
    @FXML
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">    internal lateinit var getPlanButton: MFXButton</span>

    /**
     * Kontrolka wyboru grupy.
     */
    @FXML
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">    internal lateinit var  groupChoiceBox: MFXComboBox&lt;String&gt;</span>

    /**
     * Kontrolka wyboru godziny.
     */
    @FXML
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">    internal lateinit var hourChoiceBox: MFXComboBox&lt;String&gt;</span>

    /**
     * Kontrolka wyboru lokalizacji.
     */
    @FXML
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">    internal lateinit var locationChoiceBox: MFXComboBox&lt;String&gt;</span>

    /**
     * Kontrolka wyboru sali.
     */
    @FXML
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">    internal lateinit var roomChoicebox: MFXFilterComboBox&lt;String&gt;</span>

    /**
     * Kontrolka wyboru przedmiotu.
     */
    @FXML
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">    internal lateinit var subjectChoiceBox: MFXComboBox&lt;String&gt;</span>

    /**
     * Kontrolka wyboru nauczyciela.
     */
    @FXML
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">    internal lateinit var teacherChoiceBox: MFXFilterComboBox&lt;String&gt;</span>

    /**
     * Flaga informująca o edycji planu.
     */
<span class="pc" id="L124">    var wantToEdit = false</span>

    /**
     * Flaga informująca o usunięcia planu.
     */
    private var wantToDelete = false

    /**
     * Flaga informująca o istnieniu planu (tabeli w bazie).
     */
    private var tableExists = false

    /**
     * Scena aplikacji
     */
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">    lateinit var stage: Stage</span>

    /**
     * Flaga informująca o tym czy użytkownik aktualnie modyfikuje istniejący plan
     */
    private var inEditWeekMode = false

    /**
     * Flaga informująca o tym, że użytkownik jest w trakcie tworzenia nowego planu
     */
    private var activePlanExists = false

    /**
     * Lista proponowanych godzin w przypadku braku nauczycieli
     */
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">    lateinit var suggestedHours:List&lt;String&gt;</span>

    /**
     * Lista zajętych nauczycieli, spełniających warunki w przypadku braku nauczycieli
     */
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">    lateinit var suggestedBusyTeachers:List&lt;String&gt;</span>

    /**
     * Pomocniczy dymek informacyjny tooltip
     */
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">    lateinit var tooltip: MFXTooltip</span>
<span class="fc" id="L165">    var classesModel = ClassesToWrite()</span>
<span class="fc" id="L166">    val plansModel = PlansModel()</span>

    /**
     * Inicjalizacja kontrolera
     */
    @FXML
    fun initialize() {
<span class="fc" id="L173">        setupDatePicker()</span>
<span class="fc" id="L174">        setListeners()</span>
<span class="fc" id="L175">        setActions()</span>
<span class="fc" id="L176">        setTexts()</span>
<span class="fc" id="L177">        getPlanChoiceBox.items = plansModel.getAllPlansExceptCurrent()</span>
<span class="fc" id="L178">        TabObserver.addObserver(this)</span>
<span class="fc" id="L179">        PlansModel.addObserver(this)</span>
        /*
        fieldOfStudyChoiceBox.itemsProperty().bind(
            Bindings.createObjectBinding(
                { FXCollections.observableArrayList(classesModel.getFields()) },
                classesModel.date
            )
        )
        groupChoiceBox.itemsProperty().bind(
            Bindings.createObjectBinding(
                { FXCollections.observableArrayList(classesModel.getGroups()) },
                classesModel.fieldOfStudy
            )
        )

        fieldOfStudyChoiceBox.valueProperty().bindBidirectional(classesModel.fieldOfStudy)
         */
<span class="fc" id="L196">    }</span>

    /**
     * Ustawia etykiety dla komponentów
     */
    override fun setTexts(){
<span class="fc" id="L202">        getPlanButton.text = MessageBundle.getMess(&quot;label.restorePlan&quot;)</span>
<span class="fc" id="L203">        savePlanButton.text = MessageBundle.getMess(&quot;label.savePlan&quot;)</span>
<span class="fc" id="L204">        closePlanButton.text = MessageBundle.getMess(&quot;label.closePlan&quot;)</span>
<span class="fc" id="L205">        deletePlanButton.text = MessageBundle.getMess(&quot;label.deletePlan&quot;)</span>
<span class="fc" id="L206">        datepicker.promptText = MessageBundle.getMess(&quot;label.chooseDate&quot;)</span>
<span class="fc" id="L207">        fieldOfStudyChoiceBox.floatingText = MessageBundle.getMess(&quot;label.field&quot;)</span>
<span class="fc" id="L208">        groupChoiceBox.floatingText = MessageBundle.getMess(&quot;label.group&quot;)</span>
<span class="fc" id="L209">        subjectChoiceBox.floatingText = MessageBundle.getMess(&quot;label.subject&quot;)</span>
<span class="fc" id="L210">        locationChoiceBox.floatingText = MessageBundle.getMess(&quot;label.location&quot;)</span>
<span class="fc" id="L211">        hourChoiceBox.floatingText = MessageBundle.getMess(&quot;label.hour&quot;)</span>
<span class="fc" id="L212">        roomChoicebox.floatingText = MessageBundle.getMess(&quot;label.room&quot;)</span>
<span class="fc" id="L213">        teacherChoiceBox.floatingText = MessageBundle.getMess(&quot;label.teacher&quot;)</span>
<span class="fc" id="L214">        addClassesButton.text = MessageBundle.getMess(&quot;label.add&quot;)</span>
<span class="fc" id="L215">        datepicker.locale = MessageBundle.bundle.locale</span>
<span class="fc" id="L216">    }</span>

    /**
     * Ustawia akcje dla przycisków
     */
    override fun setActions()
    {
<span class="pc" id="L223">        getPlanButton.setOnAction { getPlanFromBox() }</span>
<span class="pc" id="L224">        deletePlanButton.setOnAction { deletePlan() }</span>

<span class="fc" id="L226">        addClassesButton.setOnAction {</span>
<span class="nc" id="L227">            try {</span>
<span class="nc" id="L228">                onAddClassesPressed()</span>
            }
<span class="nc" id="L230">            catch (e: MissingValueException) {</span>
<span class="nc" id="L231">                MessageUtil.showWarningMessage(MessageBundle.getMess(&quot;warning.planAddingError&quot;), e.message!!)</span>
            }
<span class="nc" id="L233">        }</span>
<span class="pc" id="L234">        savePlanButton.setOnAction { savePlan() }</span>
<span class="pc" id="L235">        closePlanButton.setOnAction { saveAndClosePlan() }</span>
<span class="fc" id="L236">    }</span>

    /**
     * Usuwa aktualny plan zajęć po potwierdzeniu przez użytkownika.
     * Jeśli użytkownik wyrazi chęć usunięcia, tabela z planem w bazie danych zostanie usunięta
     * a aktualny plan zresetowany
     */
    override fun deletePlan() {
<span class="nc" id="L244">        showDialogYesNoMessage(MessageBundle.getMess(&quot;question.plan.askBeforeDelete&quot;), ActionType.DELETE)</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (wantToDelete)</span>
        {
<span class="nc" id="L247">            try {</span>
<span class="nc" id="L248">                plansModel.deleteCurrentPlan()</span>
<span class="nc" id="L249">                MessageUtil.showInfoMessage(MessageBundle.getMess(&quot;label.operationSucceed&quot;), MessageBundle.getMess(&quot;success.plan.correctlyDeletedPlan&quot;))</span>
<span class="nc" id="L250">                setDefaultValues()</span>
<span class="nc" id="L251">            }catch (e: SQLException) {</span>
<span class="nc" id="L252">                MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.operationFailed&quot;), MessageBundle.getMess(&quot;warning.savePlanError&quot;))</span>
            }
<span class="nc" id="L254">            catch (e: EmptyPlanException) {</span>
<span class="nc" id="L255">                MessageUtil.showErrorMessage(e.message!!, MessageBundle.getMess(&quot;warning.emptyPlan&quot;))</span>
            }
<span class="nc" id="L257">            CommonUtils.clearDatePicker(datepicker)</span>
<span class="nc" id="L258">            classesModel.date = null</span>
        }
<span class="nc" id="L260">    }</span>

    /**
     * Pobiera plan zajęć z bazy danych na podstawie wybranej daty i ustawia etykietę aktywnego planu.
     *
     * @param startPlanDay Data rozpoczęcia planu (nazwa planu).
     */
    override fun getPlanFromDatepicker(startPlanDay: LocalDate) {
<span class="fc" id="L268">        val tableHoursLeft = &quot;group_subject_hours_left_$startPlanDay&quot;</span>
<span class="fc" id="L269">        val tablePlan = &quot;plan_$startPlanDay&quot;</span>

<span class="fc" id="L271">        try {</span>
<span class="fc" id="L272">            plansModel.refillFromOldPlan(tablePlan,tableHoursLeft)</span>
<span class="fc" id="L273">            setActivePlan(tablePlan)</span>
<span class="fc" id="L274">            getPlanChoiceBox.items = plansModel.getAllPlansExceptCurrent()</span>
<span class="nc" id="L275">        }catch (e: SQLException) {</span>
<span class="nc" id="L276">            MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.operationFailed&quot;), MessageBundle.getMess(&quot;warning.getPlanError&quot;))</span>
        }
<span class="fc" id="L278">    }</span>

    /**
     * Pobiera wybrany plan zajęć na podstawie wyboru użytkownika z listy planów z bazy danych.
     * Przed pobraniem wybranego planu wykonywane jest zapisanie i zamknięcie aktualnego planu jeśli taki istnieje.
     * Zapobiega to utracie danych
     */
    override fun getPlanFromBox() {
<span class="fc" id="L286">        val plan = getPlanChoiceBox.value</span>
<span class="pc bpc" id="L287" title="1 of 2 branches missed.">        if (plan == null)</span>
        {
<span class="nc" id="L289">            MessageUtil.showWarningMessage(MessageBundle.getMess(&quot;warning.noPlan&quot;), MessageBundle.getMess(&quot;warning.shouldChoosePlanFirst&quot;))</span>
        }
        else
        {
<span class="fc" id="L293">            val date = plan.split(&quot;_&quot;)[1]</span>
<span class="fc" id="L294">            val tableHoursLeft = &quot;group_subject_hours_left_$date&quot;</span>

<span class="fc" id="L296">            val shouldSaveOldPlan = plansModel.shouldSaveOldPlan()</span>

            //najpierw trzeba zapisać stary plan
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">            if (shouldSaveOldPlan) {</span>
<span class="nc" id="L300">                showDialogYesNoMessage(MessageBundle.getMess(&quot;question.askBeforeGetAnotherPlan&quot;), ActionType.EDIT)</span>

                //Jeśli użytkownik chce zapisać stary plan i przywrócić wybrany
<span class="nc bnc" id="L303" title="All 2 branches missed.">                if (wantToEdit) saveAndClosePlan() else return</span>
            }

<span class="fc" id="L306">            plansModel.refillFromOldPlan(plan,tableHoursLeft)</span>
<span class="fc" id="L307">            setActivePlan(plan)</span>
<span class="fc" id="L308">            CommonUtils.clearBox(getPlanChoiceBox)</span>
<span class="fc" id="L309">            clearAllBoxes()</span>
<span class="fc" id="L310">            setupDatePickerActivePlan(LocalDate.parse(plan.split(&quot;_&quot;)[1]))</span>
<span class="fc" id="L311">            PlansModel.notifyObservers()</span>
        }
<span class="fc" id="L313">    }</span>

    /**
     * Ustawia wartości gdy istnieje aktywny plan i wyświetla wiadomość czy aktywkny plan jest w pełni ułożony
     */
    private fun setActivePlan(plan: String)
    {
<span class="fc" id="L320">        inEditWeekMode = true</span>
<span class="fc" id="L321">        activePlanExists = true</span>
<span class="pc bpc" id="L322" title="1 of 2 branches missed.">        if (this::activePlanLabel.isInitialized) activePlanLabel.text = &quot;${MessageBundle.getMess(&quot;label.currentPlan&quot;)} $plan&quot;</span>
<span class="pc bpc" id="L323" title="1 of 2 branches missed.">        if (!plansModel.isPlanFull()) MessageUtil.showWarningMessage(MessageBundle.getMess(&quot;warning.warning&quot;), MessageBundle.getMess(&quot;warning.planIsNotFull&quot;))</span>
<span class="fc" id="L324">    }</span>

    /**
     * Wyświetla okno dialogowe z przyciskami &quot;Tak&quot; lub &quot;Nie&quot;.
     *
     * @param content Wiadomość do wyświetlenia.
     * @param type Typ wykonywanej akcji
     */
    override fun showDialogYesNoMessage(content: String, type: ActionType) {

<span class="fc" id="L334">        val buttons = listOf(</span>
<span class="fc" id="L335">            MessageBundle.getMess(&quot;label.yes&quot;) to {</span>
<span class="nc bnc" id="L336" title="All 3 branches missed.">                when (type) {</span>
<span class="nc" id="L337">                    ActionType.EDIT -&gt; wantToEdit = true</span>
<span class="nc" id="L338">                    ActionType.DELETE -&gt; wantToDelete = true</span>
                }
<span class="nc" id="L340">            },</span>
<span class="fc" id="L341">            MessageBundle.getMess(&quot;label.no&quot;) to {</span>
<span class="nc bnc" id="L342" title="All 3 branches missed.">                when (type) {</span>
<span class="nc" id="L343">                    ActionType.EDIT -&gt; wantToEdit = false</span>
<span class="nc" id="L344">                    ActionType.DELETE -&gt; wantToDelete = false</span>
                }
<span class="nc" id="L346">            }</span>
        )

<span class="fc" id="L349">        dialog = DialogUtils.showMessageDialogWithButtons(content, stage, buttons)</span>
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">        if (dialog.owner.isShowing) dialog.showAndWait()</span>
<span class="fc" id="L351">    }</span>


    /**
     *  Ustawia nasłuchiwanie kontrolki, aby monitorować ich zmiany
     *  i wywoływać odpowiednie akcje w zależności od tych zmian.
     */
    override fun setListeners() {
<span class="fc" id="L359">        datepicker.valueProperty().addListener { _, _, date -&gt;</span>
<span class="fc" id="L360">            fieldOfStudyChoiceBox.items.clear()</span>
<span class="fc" id="L361">            classesModel.fieldOfStudy = null</span>
<span class="fc bfc" id="L362" title="All 2 branches covered.">            if (date!==null) onDatePickerChanged(date)</span>
<span class="fc" id="L363">        }</span>


<span class="fc" id="L366">        fieldOfStudyChoiceBox.valueProperty().addListener { _, _, field -&gt;</span>
<span class="fc" id="L367">            groupChoiceBox.items.clear()</span>
<span class="fc" id="L368">            classesModel.group = null</span>
<span class="pc bpc" id="L369" title="1 of 6 branches missed.">            if (!field.isNullOrBlank())</span>
            {
<span class="fc" id="L371">                classesModel.fieldOfStudy = field</span>
<span class="fc" id="L372">                groupChoiceBox.items = classesModel.getGroups()</span>
            }
<span class="fc" id="L374">        }</span>

<span class="fc" id="L376">        groupChoiceBox.valueProperty().addListener { _, _, group -&gt;</span>
<span class="fc" id="L377">            subjectChoiceBox.items.clear()</span>
<span class="fc" id="L378">            classesModel.subject=null</span>
<span class="pc bpc" id="L379" title="1 of 6 branches missed.">            if (!group.isNullOrBlank())</span>
            {
<span class="fc" id="L381">                classesModel.group = group</span>
<span class="fc" id="L382">                subjectChoiceBox.items = classesModel.getSubjects()</span>
            }
<span class="fc" id="L384">        }</span>

<span class="fc" id="L386">        subjectChoiceBox.valueProperty().addListener { _, _, subject -&gt;</span>
<span class="fc" id="L387">            locationChoiceBox.items.clear()</span>
<span class="fc" id="L388">            classesModel.location = null</span>
<span class="pc bpc" id="L389" title="1 of 6 branches missed.">            if (!subject.isNullOrBlank())</span>
            {
<span class="fc" id="L391">                classesModel.subject = subject</span>
<span class="fc" id="L392">                installHoursLeftTooltip()</span>
<span class="fc" id="L393">                locationChoiceBox.items = classesModel.getLocations()</span>
            }
<span class="fc" id="L395">        }</span>

<span class="fc" id="L397">        locationChoiceBox.valueProperty().addListener { _, _, location -&gt;</span>
<span class="fc" id="L398">            hourChoiceBox.items.clear()</span>
<span class="fc" id="L399">            classesModel.hour=null</span>
<span class="pc bpc" id="L400" title="1 of 6 branches missed.">            if (!location.isNullOrBlank())</span>
            {
<span class="fc" id="L402">                classesModel.location = location</span>
<span class="fc" id="L403">                hourChoiceBox.items = classesModel.getHours()</span>
            }
<span class="fc" id="L405">        }</span>


<span class="fc" id="L408">        hourChoiceBox.valueProperty().addListener { _, _, hour -&gt;</span>
<span class="fc" id="L409">            roomChoicebox.items.clear()</span>
<span class="fc" id="L410">            classesModel.room = null</span>
<span class="pc bpc" id="L411" title="1 of 6 branches missed.">            if (!hour.isNullOrBlank())</span>
            {
<span class="fc" id="L413">                classesModel.hour = hour</span>
<span class="pc bpc" id="L414" title="1 of 2 branches missed.">                roomChoicebox.items = if (locationChoiceBox.value.equals(MessageBundle.getMess(&quot;label.platform&quot;)))</span>
<span class="nc" id="L415">                    FXCollections.observableArrayList(MessageBundle.getMess(&quot;label.virtual&quot;))</span>
<span class="fc" id="L416">                    else classesModel.getRooms()</span>


<span class="fc" id="L419">                val canGroupMoveBetweenClasses = classesModel.canGroupMoveBetweenClasses()</span>
<span class="pc bpc" id="L420" title="1 of 2 branches missed.">                if (!canGroupMoveBetweenClasses)</span>
                {
<span class="nc" id="L422">                    CommonUtils.clearBox(roomChoicebox)</span>
<span class="nc" id="L423">                    classesModel.room = null</span>

<span class="nc" id="L425">                    showDialogOkMessage(MessageBundle.getMess(&quot;warning.noBreakBetweenChangeLocationForGroup&quot;))</span>
                }

            }
<span class="fc" id="L429">        }</span>

<span class="fc" id="L431">        roomChoicebox.valueProperty().addListener { _, _, room -&gt;</span>
<span class="fc" id="L432">            teacherChoiceBox.items.clear()</span>
<span class="fc" id="L433">            classesModel.teacher = null</span>
<span class="pc bpc" id="L434" title="1 of 6 branches missed.">            if (!room.isNullOrBlank())</span>
            {
<span class="fc" id="L436">                classesModel.room = room</span>
<span class="fc" id="L437">                teacherChoiceBox.items = classesModel.getTeachers()</span>
<span class="fc bfc" id="L438" title="All 2 branches covered.">                if (teacherChoiceBox.items.isEmpty())</span>
                {
<span class="fc" id="L440">                    showHint()</span>
                }
            }
<span class="fc" id="L443">        }</span>

<span class="fc" id="L445">        teacherChoiceBox.valueProperty().addListener { _, _, teacher -&gt;</span>

<span class="nc bnc" id="L447" title="All 6 branches missed.">            if (!teacher.isNullOrBlank())</span>
            {
<span class="nc" id="L449">                classesModel.teacher = teacher</span>
<span class="nc" id="L450">                val canTeacherMoveBetweenClasses = classesModel.canTeacherMoveBetweenClasses()</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">                if (!canTeacherMoveBetweenClasses)</span>
                {
<span class="nc" id="L453">                    CommonUtils.clearBox(teacherChoiceBox)</span>
<span class="nc" id="L454">                    classesModel.teacher = null</span>
<span class="nc" id="L455">                    showDialogOkMessage(MessageBundle.getMess(&quot;warning.noBreakBetweenChangeLocationForTeacher&quot;))</span>
                }
            }
<span class="nc" id="L458">        }</span>
<span class="fc" id="L459">    }</span>

    /**
     * Tworzy dymek informujący o liczbie godzin danego przedmiotu, która została do zrealizowania dla wybranej grupy
     */
    private fun installHoursLeftTooltip()
    {
<span class="fc" id="L466">        val hoursLeft = classesModel.getHowManyHoursLeft()</span>
<span class="fc bfc" id="L467" title="All 2 branches covered.">        if (this::tooltip.isInitialized) tooltip.uninstall()</span>
<span class="fc" id="L468">        tooltip = MFXTooltip.of(subjectChoiceBox, &quot;${MessageBundle.getMess(&quot;label.leftHours&quot;)} $hoursLeft&quot;)</span>
<span class="fc" id="L469">        tooltip.install()</span>
<span class="fc" id="L470">    }</span>


    /**
     * Zapisuje plan zajęć
     */
    override fun savePlan() {
<span class="nc" id="L477">        try {</span>
<span class="nc" id="L478">            createPlanTable()</span>
<span class="nc" id="L479">            clearAllBoxes()</span>
<span class="nc" id="L480">            MessageUtil.showInfoMessage(MessageBundle.getMess(&quot;label.operationSucceed&quot;), MessageBundle.getMess(&quot;success.plan.correctlySaved&quot;))</span>

<span class="nc" id="L482">        }catch (e: SQLException) {</span>
<span class="nc" id="L483">            MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.operationFailed&quot;), MessageBundle.getMess(&quot;warning.createTableError&quot;))</span>
        }
<span class="nc" id="L485">        catch (e: EmptyPlanException) {</span>
<span class="nc" id="L486">            MessageUtil.showErrorMessage(e.message!!, MessageBundle.getMess(&quot;warning.emptyPlan&quot;))</span>
        }

<span class="nc" id="L489">    }</span>

    /**
     * Metoda generująca podpowiedź co można zrobić w przypadku braku nauczycieli do wyboru
     */
    private fun showHint()
    {
        //Pobierz listę nauczycieli, którzy uczą tego przedmiotu oraz godziny, w których mogliby poprowadzić zajęcia
<span class="fc" id="L497">        suggestedHours = classesModel.getHoursHint(hourChoiceBox.items)</span>

        //Pobierz listę zajętych nauczycieli, którzy uczą przemdiotu
<span class="fc" id="L500">        suggestedBusyTeachers = classesModel.getBusyTeachersHints()</span>

<span class="fc bfc" id="L502" title="All 4 branches covered.">        if (suggestedHours.isNotEmpty()) showDialogOkMessage(MessageBundle.getMess(&quot;warning.noTeachersHint&quot;) +  suggestedHours)</span>
<span class="fc bfc" id="L503" title="All 4 branches covered.">        else if (suggestedBusyTeachers.isNotEmpty()) showDialogOkMessage(MessageBundle.getMess(&quot;warning.noTeachersNoHoursHint&quot;) + suggestedBusyTeachers)</span>
<span class="fc" id="L504">        else  showDialogOkMessage(MessageBundle.getMess(&quot;warning.noTeachers.tryChangeDay&quot;))</span>
<span class="fc" id="L505">    }</span>

    /**
     * Zapisuje i zamyka aktualny plan zajęć oraz resetuje plan
     */
    override fun saveAndClosePlan() {
<span class="fc" id="L511">        try {</span>
<span class="fc" id="L512">            createPlanTable()</span>
<span class="fc" id="L513">            resetPlan()</span>
<span class="fc" id="L514">            MessageUtil.showInfoMessage(MessageBundle.getMess(&quot;label.operationSucceed&quot;), MessageBundle.getMess(&quot;success.plan.correctlySavedAndClose&quot;))</span>

<span class="nc" id="L516">        }catch (e: SQLException) {</span>
<span class="nc" id="L517">            MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.operationFailed&quot;), MessageBundle.getMess(&quot;warning.createTableError&quot;))</span>
        }
<span class="nc" id="L519">        catch (e: EmptyPlanException) {</span>
<span class="nc" id="L520">            MessageUtil.showErrorMessage(e.message!!, MessageBundle.getMess(&quot;warning.emptyPlan&quot;))</span>
        }
<span class="fc" id="L522">    }</span>


    /**
     * Usuwa wszystkie zajęcia z aktualnego planu i czyści kontrolki.
     */
    override fun resetPlan()
    {
<span class="fc" id="L530">        try {</span>
<span class="fc" id="L531">            plansModel.refillHours()</span>
<span class="fc" id="L532">            setDefaultValues()</span>
<span class="fc" id="L533">            clearAllBoxes()</span>
<span class="fc" id="L534">            PlansModel.notifyObservers()</span>
<span class="nc" id="L535">        }catch (e: SQLException) {</span>
<span class="nc" id="L536">            MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.operationFailed&quot;), MessageBundle.getMess(&quot;warning.resetPlanError&quot;))</span>
        }
<span class="fc" id="L538">    }</span>


    /**
     * Tworzy nową tabelę planu zajęć w bazie danych o nazwie opartej na piątkowej dacie.
     * Tworzy również tabelę przechowującą liczbę godzin, która została do stworzenia pełnego planu i wypełnia ją.
     */
    @Throws(SQLException::class, EmptyPlanException::class)
    override fun createPlanTable() {
<span class="fc" id="L547">        plansModel.createNewPlan()</span>
<span class="fc" id="L548">        CommonUtils.clearDatePicker(datepicker)</span>
<span class="fc" id="L549">    }</span>

    /**
     * Konfiguruje datepicker, tak aby umożliwiać użytkownikowi wybór tylko dat weekendowych oraz piątku oraz blokować
     * daty wcześniejsze niż obecna data.
     */
    override fun setupDatePicker() {

<span class="fc" id="L557">        this.datepicker.cellFactory = Function { t -&gt;</span>
<span class="nc" id="L558">            object : MFXDateCell(datepicker, t) {</span>
                override fun updateItem(item: LocalDate) {
<span class="nc" id="L560">                    super.updateItem(item)</span>

<span class="nc bnc" id="L562" title="All 4 branches missed.">                    isDisable = item.isBefore(LocalDate.now()) || item.dayOfWeek !in setOf(DayOfWeek.FRIDAY, DayOfWeek.SATURDAY, DayOfWeek.SUNDAY)</span>

<span class="nc" id="L564">                    styleClass.setAll(</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">                        if (isDisable) {</span>
<span class="nc" id="L566">                            &quot;disabled-date&quot;</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">                        } else if (!plansModel.checkIfPlanExists(item)) {</span>
<span class="nc" id="L568">                            &quot;enabled-date&quot;</span>
                        } else {
<span class="nc" id="L570">                            &quot;plan-exists-date&quot;</span>
                        }
                    )
<span class="nc" id="L573">                }</span>
            }
        }
<span class="fc" id="L576">    }</span>

    /**
     * Wyświetla okno dialogowe z przyciskiem &quot;OK&quot;.
     *
     * @param content Wiadomość do wyświetlenia.
     */
    override fun showDialogOkMessage(content: String) {

<span class="pc" id="L585">        val buttons = listOf(&quot;OK&quot; to {})</span>
<span class="fc" id="L586">        dialog = DialogUtils.showMessageDialogWithButtons(content, stage, buttons)</span>
<span class="pc bpc" id="L587" title="1 of 2 branches missed.">        if (dialog.owner.isShowing) dialog.showAndWait()</span>
<span class="fc" id="L588">    }</span>


    /**
     * Obsługuje zmianę daty w datepicker. W zależności od trybu (edycja lub nowy plan) oraz tego czy dla wybranej daty istnieje już plan
     * wyświetla odpowiednie komunikaty i podejmuje odpowiednie akcje.
     * @param new Wybrana data w kalendarzu
     */
    override fun onDatePickerChanged(new: LocalDate) {
<span class="fc" id="L597">        fieldOfStudyChoiceBox.items.clear()</span>
<span class="fc" id="L598">        classesModel.fieldOfStudy = null</span>
<span class="fc" id="L599">        tableExists = plansModel.checkIfPlanExists(new)</span>

        //Jeśli plan istnieje
<span class="fc bfc" id="L602" title="All 4 branches covered.">        if(tableExists &amp;&amp; !inEditWeekMode)</span>
        {
<span class="fc" id="L604">            showPlanExistsDialog()</span>
<span class="pc bpc" id="L605" title="1 of 2 branches missed.">            if (wantToEdit)</span>
            {
<span class="nc" id="L607">                inEditWeekMode = true</span>
<span class="nc" id="L608">                classesModel.date = new</span>
<span class="nc" id="L609">                val startPlanDay = CommonUtils.getPlanStartDay(datepicker.value)</span>
<span class="nc" id="L610">                setupDatePickerActivePlan(startPlanDay)</span>
<span class="nc" id="L611">                getPlanFromDatepicker(startPlanDay)</span>
<span class="nc" id="L612">                fieldOfStudyChoiceBox.items = classesModel.getFields()</span>

            }
            else
            {
<span class="fc" id="L617">                CommonUtils.clearDatePicker(datepicker)</span>
<span class="fc" id="L618">                classesModel.date = null</span>
<span class="fc" id="L619">                inEditWeekMode=false</span>
            }
        }
        //Jeśli w trybie edit to nie sprawdzaj czy tabela istnieje
<span class="fc bfc" id="L623" title="All 2 branches covered.">        else if (inEditWeekMode)</span>
        {
<span class="fc" id="L625">            classesModel.date = new</span>
<span class="fc" id="L626">            fieldOfStudyChoiceBox.items = classesModel.getFields()</span>
        }
        //Tworzenie nowego planu
        else
        {
<span class="fc" id="L631">            stage = getPlanButton.scene.window as Stage</span>
<span class="fc" id="L632">            MessageUtil.showInfoMessage(MessageBundle.getMess(&quot;label.newPlan&quot;),MessageBundle.getMess(&quot;label.startNewPlan&quot;))</span>
<span class="fc" id="L633">            classesModel.date = new</span>
<span class="fc" id="L634">            fieldOfStudyChoiceBox.items = classesModel.getFields()</span>
        }
<span class="fc" id="L636">    }</span>


    /**
     * Wyświetla okno dialogowe informujące o istnieniu planu dla wybranej daty
     * i pyta, czy użytkownik chce go edytować
     */
    override fun showPlanExistsDialog() {
<span class="pc bpc" id="L644" title="4 of 6 branches missed.">        if (!inEditWeekMode &amp;&amp; this::activePlanLabel.isInitialized &amp;&amp; !activePlanLabel.text.contains(&quot;plan_&quot;)) {</span>
<span class="nc" id="L645">            showDialogYesNoMessage( MessageBundle.getMess(&quot;question.plan.exists.askIfWantCreate&quot;), ActionType.EDIT)</span>
        }
<span class="fc" id="L647">    }</span>

    /**
     * Ustawia domyślne wartości
     */
    private fun setDefaultValues()
    {
<span class="pc bpc" id="L654" title="1 of 2 branches missed.">        if (this::activePlanLabel.isInitialized) activePlanLabel.text = MessageBundle.getMess(&quot;label.currentPlan&quot;)</span>
<span class="fc" id="L655">        activePlanExists = false</span>
<span class="fc" id="L656">        inEditWeekMode=false</span>
<span class="fc" id="L657">        setupDatePicker()</span>
<span class="fc" id="L658">    }</span>

    /**
     * Konfiguruje datepicker, tak aby umożliwiać użytkownikowi wybór dat tylko z aktualnego planu
     * @param startPlanDay początkowa data planu
     */
    override fun setupDatePickerActivePlan(startPlanDay: LocalDate) {
<span class="fc" id="L665">        datepicker.cellFactory = Function { t -&gt;</span>
<span class="nc" id="L666">            object : MFXDateCell(datepicker, t) {</span>
                override fun updateItem(item: LocalDate) {
<span class="nc" id="L668">                    super.updateItem(item)</span>
<span class="nc bnc" id="L669" title="All 6 branches missed.">                    isDisable = (item != startPlanDay &amp;&amp; item != startPlanDay.plusDays(1) &amp;&amp; item != startPlanDay.plusDays(2))</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">                    styleClass.setAll(if (isDisable) &quot;disabled-date&quot; else &quot;enabled-date&quot;)</span>
<span class="nc" id="L671">                }</span>
            }
        }
<span class="fc" id="L674">    }</span>


    /**
     * Obsługuje akcję dodawania zajęć do planu w bazie danych. Sprawdza, czy dane są kompletnie wprowadzone,
     * a następnie dodaje zajęcia do planu i aktualizuje interfejs użytkownika.
     *
     * @throws MissingValueException Jeśli brakuje jakiejś wartości.
     */
    override fun onAddClassesPressed() {
<span class="fc" id="L684">        val messContent = classesModel.getMissingFieldContentIfError()</span>
<span class="pc bpc" id="L685" title="1 of 2 branches missed.">        if (messContent != null)</span>
        {
<span class="nc" id="L687">            throw MissingValueException(&quot;$messContent&quot;)</span>
        }

<span class="fc" id="L690">        try {</span>
            //Tutaj bez powiadomienia o poprawnie dodanych zajęciach, żeby nie było to irytujące, gdy niepowodzenie dodania planu to wtedy powiadom
<span class="fc" id="L692">            classesModel.addToPlan()</span>
<span class="fc" id="L693">            val startPlanDay = CommonUtils.getPlanStartDay(classesModel.date!!)</span>
<span class="fc" id="L694">            setupDatePickerActivePlan(startPlanDay)</span>
<span class="fc" id="L695">            activePlanExists = true</span>
<span class="fc" id="L696">            inEditWeekMode = true</span>
<span class="pc bpc" id="L697" title="1 of 2 branches missed.">            if (this::activePlanLabel.isInitialized) activePlanLabel.text = &quot;${MessageBundle.getMess(&quot;label.currentPlan&quot;)} plan_$startPlanDay&quot;</span>
<span class="fc" id="L698">            clearAllBoxes()</span>
<span class="pc bpc" id="L699" title="1 of 2 branches missed.">            if (this::tooltip.isInitialized) tooltip.uninstall()</span>
<span class="fc" id="L700">        }catch (e: SQLException) {</span>
<span class="fc" id="L701">            MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.operationFailed&quot;), MessageBundle.getMess(&quot;warning.addToPlanError&quot;))</span>
        }
<span class="fc" id="L703">    }</span>


    /**
     * Czyści kontrolki z ich zawartości w interfejsie użytkownika.
     */
    override fun clearAllBoxes() {
<span class="fc" id="L710">        fieldOfStudyChoiceBox.items.clear()</span>
<span class="fc" id="L711">        groupChoiceBox.items.clear()</span>
<span class="fc" id="L712">        subjectChoiceBox.items.clear()</span>
<span class="fc" id="L713">        locationChoiceBox.items.clear()</span>
<span class="fc" id="L714">        hourChoiceBox.items.clear()</span>
<span class="fc" id="L715">        roomChoicebox.items.clear()</span>
<span class="fc" id="L716">        teacherChoiceBox.items.clear()</span>

<span class="fc" id="L718">        CommonUtils.clearDatePicker(datepicker)</span>
<span class="fc" id="L719">        CommonUtils.clearBox(fieldOfStudyChoiceBox)</span>
<span class="fc" id="L720">        CommonUtils.clearBox(groupChoiceBox)</span>
<span class="fc" id="L721">        CommonUtils.clearBox(subjectChoiceBox)</span>
<span class="fc" id="L722">        CommonUtils.clearBox(locationChoiceBox)</span>
<span class="fc" id="L723">        CommonUtils.clearBox(hourChoiceBox)</span>
<span class="fc" id="L724">        CommonUtils.clearBox(roomChoicebox)</span>
<span class="fc" id="L725">        CommonUtils.clearBox(teacherChoiceBox)</span>

<span class="fc" id="L727">        classesModel.date = null</span>
        //classesModel.fieldOfStudy = null
<span class="fc" id="L729">    }</span>

    /**
     * Aktualizuje listę dostępnych planów po zmianie w bazie danych i ustawia kalendarz
     */
    override fun onPlansChanged() {
<span class="fc" id="L735">        getPlanChoiceBox.items = plansModel.getAllPlansExceptCurrent()</span>
<span class="fc bfc" id="L736" title="All 2 branches covered.">        if (!activePlanExists) setupDatePicker()</span>
<span class="fc" id="L737">    }</span>

    /**
     * Obsługuje zmianę zakładek w interfejsie użytkownika - czyści panel
     */
    override fun onTabsChanged() {
<span class="nc" id="L743">        CommonUtils.clearBox(getPlanChoiceBox)</span>
<span class="nc" id="L744">        clearAllBoxes()</span>
<span class="nc bnc" id="L745" title="All 2 branches missed.">        if (this::tooltip.isInitialized) tooltip.uninstall()</span>
<span class="nc" id="L746">    }</span>

}


</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>