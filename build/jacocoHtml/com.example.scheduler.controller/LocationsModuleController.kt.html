<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LocationsModuleController.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Scheduler</a> &gt; <a href="index.source.html" class="el_package">com.example.scheduler.controller</a> &gt; <span class="el_source">LocationsModuleController.kt</span></div><h1>LocationsModuleController.kt</h1><pre class="source lang-java linenums">package com.example.scheduler.controller

import com.example.scheduler.controller.exceptions.DuplicatesException
import com.example.scheduler.controller.exceptions.IdenticalObjectExistsException
import com.example.scheduler.controller.exceptions.IllegalValueException
import com.example.scheduler.controller.observers.AdminTabsObserver
import com.example.scheduler.controller.observers.TabsObserver
import com.example.scheduler.models.LocationsModel
import com.example.scheduler.models.RoomsModel
import com.example.scheduler.objects.Location
import com.example.scheduler.objects.Room
import com.example.scheduler.utils.*
import io.github.palexdev.materialfx.controls.*
import io.github.palexdev.materialfx.controls.MFXStepper.MFXStepperEvent
import io.github.palexdev.materialfx.controls.cell.MFXTableRowCell
import io.github.palexdev.materialfx.dialogs.MFXGenericDialog
import io.github.palexdev.materialfx.dialogs.MFXStageDialog
import io.github.palexdev.materialfx.filter.StringFilter
import io.github.palexdev.mfxresources.fonts.MFXFontIcon
import javafx.fxml.FXML
import javafx.geometry.Pos
import javafx.scene.control.Label
import javafx.scene.layout.VBox
import javafx.scene.paint.Color
import javafx.stage.Stage
import org.apache.poi.xssf.usermodel.XSSFWorkbook
import java.io.File
import java.io.FileInputStream
import java.io.IOException
import java.sql.SQLException
import java.util.*
import java.util.function.Function
import kotlin.reflect.KProperty1

/**
 * Klasa kontrolera modułu LocationModule do zarządzania lokalizacjami
 */
<span class="fc" id="L38">class LocationsModuleController: ILocationsModuleController, AdminTabsObserver, TabsObserver {</span>

    /**
     * Przycisk służący do wyświetlania listy lokalizacji.
     */
    @FXML
    private lateinit var showLocationsButton: MFXButton

    /**
     * Tabela służąca do wyświetlania listy lokalizacji.
     */
    @FXML
<span class="pc bpc" id="L50" title="1 of 2 branches missed.">    lateinit var locationTableView: MFXTableView&lt;Location&gt;</span>

    /**
     * Stepper odpowiedzialny za proces dodawania lokalizacji wraz z walidacją danych.
     */
    @FXML
    private lateinit var stepper: MFXStepper

    /**
     * Flaga informująca o chęci edycji lokalizacji.
     */
<span class="pc" id="L61">    var wantToEdit = false</span>

    /**
     * Flaga informująca o tym czy lokalizacja jest w trybie edycji
     */
    private var inEditMode = false

    /**
     * Flaga informująca o wyświetleniu okna dialogowego z komunikatem.
     */
    private var messageShown = false

    /**
     * Scena aplikacji
     */
<span class="pc bnc" id="L76" title="All 2 branches missed.">    lateinit var stage: Stage</span>

    /**
     * Etykieta informująca o kroku 1 podczas dodawania lokalizacji
     */
<span class="fc" id="L81">    private var fillDataLabel: Label = Label()</span>

    /**
     * Pole tekstowe do wprowadzania nazwy lokalizacji podczas dodawania lokalizacji
     */
<span class="fc" id="L86">    private var locationNameTextField: MFXTextField = MFXTextField()</span>

    /**
     * Pole tekstowe do wprowadzania nazwy miasta podczas dodawania lokalizacji
     */
<span class="fc" id="L91">    private var cityTextField: MFXTextField = MFXTextField()</span>

    /**
     * Pole tekstowe do wprowadzania nazwy ulicy podczas dodawania lokalizacji
     */
<span class="fc" id="L96">    private var streetTextField: MFXTextField = MFXTextField()</span>

    /**
     * Pole tekstowe do wprowadzania kodu pocztowego podczas dodawania lokalizacji
     */
<span class="fc" id="L101">    private var postcodeTextField: MFXTextField = MFXTextField()</span>

    /**
     * Etykieta informująca o kroku 2 podczas dodawania lokalizacji
     */
<span class="fc" id="L106">    private var uploadRoomsLabel: Label = Label()</span>

    /**
     * Przycisk służący do ładowania pliku z salami
     */
<span class="fc" id="L111">    private var uploadButton: MFXButton = MFXButton(MessageBundle.getMess(&quot;label.loadFile&quot;))</span>

    /**
     * Przycisk typu toggle umożliwiający wybranie pliku z salami
     */
<span class="fc" id="L116">    private var uploadRoomsToggle: MFXRectangleToggleNode = MFXRectangleToggleNode()</span>

    /**
     * Lista sal, które należy przypisać do dodawanej lokalizacji
     */
<span class="fc" id="L121">    var roomsToAdd: MutableList&lt;Room&gt; = mutableListOf()</span>

    /**
     * Pole tekstowe do wprowadzania nazwy lokalizacji podczas edycji lokalizacji
     */
<span class="pc" id="L126">    var locationNameTextFieldEdit: MFXTextField = MFXTextField()</span>

    /**
     * Pole tekstowe do wprowadzania nazwy miasta podczas edycji lokalizacji
     */
<span class="pc" id="L131">    var cityTextFieldEdit: MFXTextField = MFXTextField()</span>

    /**
     * Pole tekstowe do wprowadzania nazwy ulicy podczas edycji lokalizacji
     */
<span class="pc" id="L136">    var streetTextFieldEdit: MFXTextField = MFXTextField()</span>

    /**
     * Pole tekstowe do wprowadzania kodu pocztowego lokalizacji podczas edycji lokalizacji
     */
<span class="pc" id="L141">    var postcodeTextFieldEdit: MFXTextField = MFXTextField()</span>

    /**
     * Etykieta informująca o edycji lokalizacji
     */
<span class="fc" id="L146">    private var editDataLabel: Label = Label()</span>

    /**
     * Menu kontekstowe wyświetlające się po kliknięciu na wiersz tabeli z lokalizacjami
     */
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">    internal lateinit var menu: MFXContextMenu</span>

    /**
     * Obiekt reprezentujący ostatnio wybraną lokalizację z tabeli
     */
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">    lateinit var lastSelectedLocation: Location</span>

    /**
     * Pomocnicze okno dialogowe do menu kontekstowego.
     */
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">    lateinit var dialog: MFXStageDialog</span>

    /**
     * Pomocnicze okno dialogowe do wyświetlania wiadomości.
     */
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">    lateinit var dialogMess: MFXStageDialog</span>

<span class="fc" id="L168">    val locationsModel = LocationsModel()</span>
<span class="fc" id="L169">    val roomsModel = RoomsModel()</span>


    /**
     * Inicjalizacja kontrolera
     */
    @FXML
    fun initialize()
    {
<span class="fc" id="L178">        setupTable()</span>
<span class="fc" id="L179">        AdminTabObserver.addObserver(this)</span>
<span class="fc" id="L180">        TabObserver.addObserver(this)</span>
<span class="fc" id="L181">        menu = MFXContextMenu(locationTableView)</span>

<span class="fc" id="L183">        setOnLocationSelected()</span>
<span class="fc" id="L184">        setupLocationForm()</span>

<span class="fc" id="L186">        setConstraints(locationNameTextField, cityTextField, streetTextField, postcodeTextField)</span>
<span class="fc" id="L187">        setConstraints(locationNameTextFieldEdit, cityTextFieldEdit, streetTextFieldEdit, postcodeTextFieldEdit)</span>

<span class="fc" id="L189">        createSteps()</span>
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">        stepper.styleClass.add(&quot;stepper&quot;)</span>

<span class="pc" id="L192">        uploadRoomsToggle.setOnAction { ExcelUtils.searchFile(uploadRoomsToggle, uploadButton.scene.window as Stage) }</span>
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">        showLocationsButton.setOnAction { showLocations() }</span>
<span class="pc" id="L194">        uploadButton.setOnAction { uploadFileRooms(uploadRoomsToggle.text, locationNameTextField.text) }</span>

<span class="pc bpc" id="L196" title="1 of 2 branches missed.">        showLocationsButton.text = MessageBundle.getMess(&quot;label.showLocations&quot;)</span>
<span class="fc" id="L197">    }</span>


    /**
     * Obsługuje akcje wywoływane po kliknięciu na lokalizację w tabeli.
     */
    override fun setOnLocationSelected() {
<span class="fc" id="L204">        CommonUtils.setOnItemSelected(locationTableView, menu) { selectedRowIndex -&gt;</span>
<span class="nc" id="L205">            lastSelectedLocation = locationTableView.items[selectedRowIndex]</span>
<span class="nc" id="L206">            showContextMenu(selectedRowIndex, lastSelectedLocation)</span>
<span class="nc" id="L207">        }</span>
<span class="fc" id="L208">    }</span>

    /**
     * Konfiguruje pierwszy krok formularza dodawania lub edycji lokalizacji.
     */
    override fun setUpFirstStepForm() {
<span class="fc" id="L214">        fillDataLabel.text = MessageBundle.getMess(&quot;label.fillNameAndAddress&quot;)</span>
<span class="fc" id="L215">        fillDataLabel.styleClass.add(&quot;header-label&quot;)</span>

<span class="fc" id="L217">        editDataLabel.styleClass.add(&quot;header-label-big&quot;)</span>
<span class="fc" id="L218">        editDataLabel.text = MessageBundle.getMess(&quot;label.updateLocation&quot;)</span>

<span class="fc" id="L220">        locationNameTextField.floatingText = MessageBundle.getMess(&quot;label.enterLocationName&quot;)</span>
<span class="fc" id="L221">        cityTextField.floatingText = MessageBundle.getMess(&quot;label.enterCity&quot;)</span>
<span class="fc" id="L222">        streetTextField.floatingText = MessageBundle.getMess(&quot;label.enterStreet&quot;)</span>
<span class="fc" id="L223">        postcodeTextField.floatingText = MessageBundle.getMess(&quot;label.enterPostcode&quot;)</span>
<span class="fc" id="L224">        postcodeTextField.textLimit = 6</span>

<span class="fc" id="L226">        locationNameTextFieldEdit.floatingText = locationNameTextField.floatingText</span>
<span class="fc" id="L227">        cityTextFieldEdit.floatingText = cityTextField.floatingText</span>
<span class="fc" id="L228">        streetTextFieldEdit.floatingText =  streetTextField.floatingText</span>
<span class="fc" id="L229">        postcodeTextFieldEdit.floatingText = postcodeTextField.floatingText</span>
<span class="fc" id="L230">        postcodeTextFieldEdit.textLimit = postcodeTextField.textLimit</span>

<span class="fc" id="L232">        CommonUtils.setTextFieldStyle(locationNameTextField, cityTextField, streetTextField, postcodeTextField)</span>
<span class="fc" id="L233">        CommonUtils.setTextFieldStyle(locationNameTextFieldEdit, cityTextFieldEdit, streetTextFieldEdit, postcodeTextFieldEdit)</span>
<span class="fc" id="L234">    }</span>

    /**
     * Konfiguruje drugi krok formularza dodawania lokalizacji.
     */
    override fun setUpSecondStepForm() {
        //step 2
<span class="fc" id="L241">        uploadRoomsLabel.text = MessageBundle.getMess(&quot;label.loadRoomsNowOrLater&quot;)</span>
<span class="fc" id="L242">        uploadRoomsLabel.styleClass.add(&quot;header-label-small&quot;)</span>
<span class="fc" id="L243">        uploadRoomsToggle.labelTrailingIcon = MFXFontIcon(&quot;fas-list-ul&quot;, 16.0, Color.BLACK)</span>
<span class="fc" id="L244">        uploadRoomsToggle.text = MessageBundle.getMess(&quot;label.chooseFile&quot;)</span>

<span class="fc" id="L246">        MFXTooltip.of(uploadRoomsToggle, MessageBundle.getMess(&quot;label.patternInfo&quot;)).install()</span>

<span class="fc" id="L248">        uploadRoomsLabel.prefWidth = 380.0</span>
<span class="fc" id="L249">        uploadRoomsToggle.prefWidth = 380.0</span>

<span class="fc" id="L251">        uploadButton.id = &quot;customButton&quot;</span>
<span class="fc" id="L252">    }</span>

    /**
     * Konfiguruje formularz dodawania lub edycji lokalizacji.
     */
    override fun setupLocationForm() {
<span class="fc" id="L258">        setUpFirstStepForm()</span>
<span class="fc" id="L259">        setUpSecondStepForm()</span>
<span class="fc" id="L260">    }</span>


    /**
     * Ustawia ograniczenia na pola tekstowe walidujące poprawność danych.
     *
     * @param locationName         Pole tekstowe do wprowadzania nazwy lokalizacji.
     * @param city                 Pole tekstowe do wprowadzania nazwy miasta.
     * @param street               Pole tekstowe do wprowadzania nazwy ulicy.
     * @param postcode             Pole tekstowe do wprowadzania kodu pocztowego.
     */
    override fun setConstraints(locationName: MFXTextField, city: MFXTextField, street: MFXTextField, postcode: MFXTextField) {
<span class="fc" id="L272">        locationName.validator.constraint(ValidatorUtil.createMoreThanOneLetterConstraint(locationName.textProperty(), MessageBundle.getMess(&quot;location.validation.moreThanOneLetter&quot;)))</span>
<span class="fc" id="L273">        locationName.validator.constraint(ValidatorUtil.createLettersSmallExceptFirstConstraint(locationName.textProperty(), MessageBundle.getMess(&quot;location.validation.allLettersLowercaseExceptFirst&quot;)))</span>
<span class="fc" id="L274">        locationName.validator.constraint(ValidatorUtil.createFirstLetterBigConstraint(locationName.textProperty(), MessageBundle.getMess(&quot;location.validation.startWithUppercase&quot;)))</span>
<span class="fc" id="L275">        locationName.validator.constraint(ValidatorUtil.createNoSpecialCharsConstraint(locationName.textProperty(), MessageBundle.getMess(&quot;location.validation.noSpecialChars&quot;)))</span>

<span class="fc" id="L277">        city.validator.constraint(ValidatorUtil.createMoreThanOneLetterConstraint(city.textProperty(), MessageBundle.getMess(&quot;city.validation.moreThanOneLetter&quot;)))</span>
<span class="fc" id="L278">        city.validator.constraint(ValidatorUtil.createFirstLetterBigConstraint(city.textProperty(), MessageBundle.getMess(&quot;city.validation.startWithUppercase&quot;)))</span>
<span class="fc" id="L279">        city.validator.constraint(ValidatorUtil.createNoSpecialCharsConstraintSpceAllowed(city.textProperty(),MessageBundle.getMess(&quot;city.validation.noSpecialChars&quot;) ))</span>


<span class="fc" id="L282">        street.validator.constraint(ValidatorUtil.createMoreThanOneLetterConstraint(street.textProperty(), MessageBundle.getMess(&quot;street.validation.moreThanOneLetter&quot;)))</span>
<span class="fc" id="L283">        street.validator.constraint(ValidatorUtil.createFirstLetterBigConstraint(street.textProperty(), MessageBundle.getMess(&quot;street.validation.startWithUppercase&quot;)))</span>

<span class="fc" id="L285">        postcode.validator.constraint(ValidatorUtil.createPostalCodeConstraint(postcode.textProperty(), MessageBundle.getMess(&quot;postcode.validation.correctForm&quot;)))</span>
<span class="fc" id="L286">        postcode.validator.constraint(ValidatorUtil.createNotEmptyConstraint(postcode.textProperty(), MessageBundle.getMess(&quot;postcode.validation.notEmpty&quot;)))</span>
<span class="fc" id="L287">    }</span>


    /**
     * Wczytuje sale z pliku Excel i dodaje je do listy sal do późniejszego dodania do lokalizacji.
     *
     * @param filePath Ścieżka do pliku Excel zawierającego dane o salach.
     * @param location Nazwa lokalizacji, do której należy przypisać wczytywane sale
     */
    override fun uploadFileRooms(filePath: String, location: String)
    {
<span class="fc" id="L298">        roomsToAdd.clear()</span>
<span class="pc bpc" id="L299" title="2 of 4 branches missed.">        if (filePath.isNotEmpty())</span>
        {
<span class="fc" id="L301">            val file = File(filePath)</span>
<span class="fc" id="L302">            var myWorkBook: XSSFWorkbook?=null</span>
<span class="fc" id="L303">            var fis:FileInputStream?=null</span>

<span class="fc" id="L305">            try {</span>
<span class="fc" id="L306">                fis = FileInputStream(file)</span>
<span class="fc" id="L307">                myWorkBook = XSSFWorkbook(fis)</span>
<span class="fc" id="L308">                val sheet = myWorkBook.getSheetAt(0)</span>

<span class="fc" id="L310">                var startRowNr = 1</span>
<span class="fc" id="L311">                val startCellNr = 1</span>

<span class="fc bfc" id="L313" title="All 2 branches covered.">                while (sheet.getRow(startRowNr)!=null)</span>
                {
<span class="fc" id="L315">                    val roomName = sheet.getRow(startRowNr).getCell(startCellNr).stringCellValue</span>
<span class="fc" id="L316">                    val volume = sheet.getRow(startRowNr).getCell(startCellNr+1).numericCellValue.toInt()</span>
<span class="fc" id="L317">                    val floor = sheet.getRow(startRowNr).getCell(startCellNr+2).numericCellValue.toInt()</span>

<span class="pc bpc" id="L319" title="2 of 8 branches missed.">                    if (roomName.isEmpty() || volume==0 || floor==0) throw java.lang.NullPointerException()</span>
<span class="pc bpc" id="L320" title="2 of 4 branches missed.">                    if (volume &lt; 0 || floor&lt;0) throw IllegalValueException(MessageBundle.getMess(&quot;warning.shouldBeGreaterThanZero&quot;))</span>

<span class="fc" id="L322">                    val roomToAdd = Room(</span>
<span class="fc" id="L323">                        roomName = roomName,</span>
<span class="fc" id="L324">                        volume = volume,</span>
<span class="fc" id="L325">                        floor = floor,</span>
<span class="fc" id="L326">                        location = location</span>
                    )

<span class="fc" id="L329">                    roomsToAdd.add(roomToAdd)</span>
<span class="fc" id="L330">                    startRowNr++</span>
                }

<span class="fc" id="L333">                MessageUtil.showInfoMessage(MessageBundle.getMess(&quot;label.fileLoaded&quot;), MessageBundle.getMess(&quot;success.rooms.fileLoadedCorrectly&quot;))</span>
            }
            //nieprawidłowa wartość
<span class="fc" id="L336">            catch (e: IllegalStateException)</span>
            {
<span class="fc" id="L338">                MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.readError&quot;), MessageBundle.getMess(&quot;warning.incorrectExcelForm&quot;))</span>
            }
            //Pusta komórka
<span class="fc" id="L341">            catch (e: NullPointerException)</span>
            {
<span class="fc" id="L343">                MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.readError&quot;), MessageBundle.getMess(&quot;warning.incorrectExcelForm&quot;))</span>
            }
<span class="nc" id="L345">            catch (e: IllegalValueException)</span>
            {
<span class="nc" id="L347">                MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.readError&quot;), e.message!!)</span>
            }
<span class="nc" id="L349">            catch (e: IOException) {</span>
<span class="nc" id="L350">                MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.readError&quot;), MessageBundle.getMess(&quot;warning.fileAlreadyOpened&quot;))</span>
            }
            finally {
<span class="fc" id="L353">                myWorkBook!!.close()</span>
<span class="fc" id="L354">                fis!!.close()</span>
<span class="fc" id="L355">            }</span>
        }
        else{
<span class="nc" id="L358">            MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.fileLoadingError&quot;), MessageBundle.getMess(&quot;warning.shouldChooseFileFirst&quot;))</span>
        }
<span class="fc" id="L360">    }</span>


    /**
     * Wyświetla listę lokalizacji w tabeli
     */
    override fun showLocations() {
<span class="pc bpc" id="L367" title="1 of 2 branches missed.">        stage = showLocationsButton.scene.window as Stage</span>

<span class="fc" id="L369">        val locations = locationsModel.getLocationsExceptPlatform()</span>

<span class="pc bpc" id="L371" title="1 of 2 branches missed.">        if (locations.isEmpty())</span>
        {
<span class="nc" id="L373">            MessageUtil.showInfoMessage(MessageBundle.getMess(&quot;warning.noLocations&quot;), MessageBundle.getMess(&quot;warning.noLocationsToShow&quot;))</span>
<span class="nc" id="L374">            locationTableView.items.clear()</span>
        }
<span class="fc" id="L376">        else locationTableView.items = locations</span>
<span class="fc" id="L377">    }</span>


    /**
     * Tworzy pierwszy krok formularza dodawania lokalizacji.
     */
    override fun createFirstStep(): MFXStepperToggle {
<span class="fc" id="L384">        val step1 = MFXStepperToggle(MessageBundle.getMess(&quot;label.data&quot;), MFXFontIcon(&quot;fas-paperclip&quot;, 16.0, Color.web(&quot;#40F6F6&quot;)))</span>

<span class="fc" id="L386">        val step1Box = VBox(</span>
<span class="fc" id="L387">            15.0,</span>
<span class="fc" id="L388">            fillDataLabel,</span>
<span class="pc bpc" id="L389" title="1 of 2 branches missed.">            ValidationWrapper.wrapNodeForValidationStepper(locationNameTextField, stepper),</span>
<span class="pc bpc" id="L390" title="1 of 2 branches missed.">            ValidationWrapper.wrapNodeForValidationStepper(cityTextField, stepper),</span>
<span class="pc bpc" id="L391" title="1 of 2 branches missed.">            ValidationWrapper.wrapNodeForValidationStepper(streetTextField, stepper),</span>
<span class="pc bpc" id="L392" title="1 of 2 branches missed.">            ValidationWrapper.wrapNodeForValidationStepper(postcodeTextField, stepper)</span>
        )

<span class="fc" id="L395">        step1Box.alignment = Pos.CENTER</span>
<span class="fc" id="L396">        step1.content = step1Box</span>


<span class="fc" id="L399">        step1.validator</span>
<span class="fc" id="L400">            .dependsOn(locationNameTextField.validator)</span>
<span class="fc" id="L401">            .dependsOn(cityTextField.validator)</span>
<span class="fc" id="L402">            .dependsOn(streetTextField.validator)</span>
<span class="fc" id="L403">            .dependsOn(postcodeTextField.validator)</span>

<span class="fc" id="L405">        return step1</span>
    }

    /**
     * Tworzy drugi krok formularza dodawania lokalizacji.
     */
    override fun createSecondStep(): MFXStepperToggle {
<span class="fc" id="L412">        val step2 = MFXStepperToggle(MessageBundle.getMess(&quot;label.rooms&quot;), MFXFontIcon(&quot;fas-pen&quot;, 16.0, Color.web(&quot;#40F6F6&quot;)))</span>
<span class="fc" id="L413">        val step2Box = VBox(30.0, uploadRoomsLabel, uploadRoomsToggle, uploadButton)</span>
<span class="fc" id="L414">        uploadRoomsToggle.text = &quot;&quot;</span>

<span class="fc" id="L416">        step2Box.alignment = Pos.CENTER</span>
<span class="fc" id="L417">        step2.content = step2Box</span>

<span class="fc" id="L419">        return step2</span>
    }

    /**
     * Tworzy kroki dla stepper procesu dodawania lokalizacji.
     */
    override fun createSteps() {
<span class="fc" id="L426">        val step1 = createFirstStep()</span>
<span class="fc" id="L427">        val step2 = createSecondStep()</span>

<span class="pc bpc" id="L429" title="1 of 2 branches missed.">        stepper.stepperToggles.addAll(listOf(step1, step2))</span>
<span class="fc" id="L430">        performActionsBetweenSteps()</span>
<span class="fc" id="L431">    }</span>

    /**
     * Obsługuje akcje wywoływane po pierwszym kroku podczas dodawania lokalizacji.
     */
    override fun handleActionsAfterFirstStep() {
<span class="nc bnc" id="L437" title="All 6 branches missed.">        if (stepper.currentStepperNode == stepper.stepperToggles[1])</span>
        {
<span class="nc" id="L439">            val location = Location(</span>
<span class="nc" id="L440">                locationName = locationNameTextField.text,</span>
<span class="nc" id="L441">                city = cityTextField.text,</span>
<span class="nc" id="L442">                street = streetTextField.text,</span>
<span class="nc" id="L443">                postcode = postcodeTextField.text</span>
            )
<span class="nc" id="L445">            checkDbWhileAdding(location)</span>
        }
<span class="nc" id="L447">    }</span>


    /**
     * Metoda sprawdza czy w bazie nie istnieją już lokalizacje o podobnych danych podczas dodawania
     * @param location  Lokalizacja do dodania
     */
    fun checkDbWhileAdding(location: Location)
    {
<span class="fc" id="L456">        try {</span>
<span class="nc" id="L457">            locationsModel.checkDBwhileAdding(location)</span>
<span class="fc" id="L458">        }catch (e: DuplicatesException)</span>
        {
<span class="pc bpc" id="L460" title="1 of 2 branches missed.">            stepper.previous()</span>
<span class="fc" id="L461">            MessageUtil.showWarningMessage(MessageBundle.getMess(&quot;warning.locationAddingError&quot;), e.message!!)</span>
        }
<span class="fc" id="L463">    }</span>

    /**
     * Obsługuje akcje wywoływane po ostatnim kroku podczas dodawania lokalizacji.
     */
    override fun handleActionsAfterLastStep() {
<span class="nc bnc" id="L469" title="All 2 branches missed.">        stepper.setOnLastNext {</span>
<span class="nc" id="L470">            val location = Location(</span>
<span class="nc" id="L471">                locationName = locationNameTextField.text,</span>
<span class="nc" id="L472">                city = cityTextField.text,</span>
<span class="nc" id="L473">                street = streetTextField.text,</span>
<span class="nc" id="L474">                postcode = postcodeTextField.text</span>
            )

<span class="nc" id="L477">            try {</span>
<span class="nc" id="L478">                locationsModel.addLocation(location)</span>
<span class="nc" id="L479">                val duplicatesExists = roomsModel.removeDuplicatesAndAddRooms(roomsToAdd)</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">                if (duplicatesExists) MessageUtil.showWarningMessage(MessageBundle.getMess(&quot;warning.deleteDuplicates&quot;), MessageBundle.getMess(&quot;warning.roomExistsInDB&quot;))</span>

<span class="nc" id="L482">                createCompletedStep()</span>
<span class="nc" id="L483">                showLocations()</span>

<span class="nc" id="L485">                MessageUtil.showInfoMessage(MessageBundle.getMess(&quot;label.operationSucceed&quot;), MessageBundle.getMess(&quot;success.location.correctlyAdded&quot;))</span>
<span class="nc" id="L486">            }catch (e: SQLException) {</span>
<span class="nc" id="L487">                MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.operationFailed&quot;), MessageBundle.getMess(&quot;warning.addLocationError&quot;))</span>
<span class="nc" id="L488">                locationsModel.deleteLocation(location)</span>
            }

<span class="nc" id="L491">        }</span>
<span class="nc" id="L492">    }</span>


    /**
     * Tworzy layout informujący o powodzeniu dodania lokalizacji
     */
    override fun createCompletedStep() {
<span class="nc" id="L499">        val completedLabel = CommonUtils.createCompletedLabel(MessageBundle.getMess(&quot;label.locationAdded&quot;))</span>
<span class="nc" id="L500">        val resetButton = CommonUtils.createResetButton()</span>

<span class="nc" id="L502">        resetButton.setOnAction {</span>
<span class="nc" id="L503">            setOnResetButton()</span>
<span class="nc" id="L504">        }</span>

<span class="nc" id="L506">        val vbox = VBox(20.0, completedLabel, resetButton)</span>
<span class="nc" id="L507">        vbox.alignment = Pos.CENTER</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">        (stepper.stepperToggles[1].content as VBox).children.setAll(vbox)</span>
<span class="nc" id="L509">    }</span>

    /**
     * Obsługuje akcje wywoływane po naciśnięciu przycisku &quot;Reset&quot; na formularzu dodawania lub edycji lokalizacji.
     */
    override fun setOnResetButton()
    {
<span class="nc bnc" id="L516" title="All 2 branches missed.">        CommonUtils.removeStepDependencies(stepper, locationNameTextField, cityTextField, streetTextField, postcodeTextField)</span>
<span class="nc" id="L517">        createSteps()</span>
<span class="nc" id="L518">        clearAllLocationForm()</span>
<span class="nc" id="L519">        roomsToAdd.clear()</span>
<span class="nc" id="L520">    }</span>


    /**
     * Wykonuje akcje między krokami formularza.
     */
    override fun performActionsBetweenSteps() {

<span class="pc bpc" id="L528" title="1 of 2 branches missed.">        stepper.addEventHandler(MFXStepperEvent.NEXT_EVENT) {</span>
<span class="nc" id="L529">            handleActionsAfterFirstStep()</span>
<span class="nc" id="L530">            handleActionsAfterLastStep()</span>
<span class="nc" id="L531">        }</span>
<span class="fc" id="L532">    }</span>

    /**
     * Czyści pola formularza
     */
    override fun clearAllLocationForm() {
<span class="nc" id="L538">        locationNameTextField.clear()</span>
<span class="nc" id="L539">        cityTextField.clear()</span>
<span class="nc" id="L540">        streetTextField.clear()</span>
<span class="nc" id="L541">        postcodeTextField.clear()</span>
<span class="nc" id="L542">    }</span>

    /**
     * Tworzy i wyświetla menu kontekstowe dla wybranej lokalizacji z tabeli (oprócz Platformy).
     *
     * @param selectedRowIndex Indeks zaznaczonego wiersza w tabeli.
     * @param selectedItem       Wybrana lokalizacja.
     */
    override fun showContextMenu(selectedRowIndex: Int, selectedItem: Location) {

<span class="fc" id="L552">        val deleteButton = MFXContextMenuItem(MessageBundle.getMess(&quot;label.deleteLocation&quot;))</span>
<span class="fc" id="L553">        val editButton = MFXContextMenuItem(MessageBundle.getMess(&quot;label.editLocation&quot;))</span>

<span class="fc" id="L555">        deleteButton.graphic =  MFXFontIcon(&quot;fas-trash-can&quot;, 16.0, Color.BLACK)</span>
<span class="fc" id="L556">        editButton.graphic = MFXFontIcon(&quot;fas-wrench&quot;, 16.0, Color.BLACK)</span>

<span class="fc" id="L558">        deleteButton.setOnAction {</span>
<span class="nc" id="L559">            showDialogYesNoMessage(MessageBundle.getMess(&quot;question.location.askBeforeDelete&quot;))</span>
<span class="nc" id="L560">            deleteLocation(selectedItem)</span>
<span class="nc" id="L561">        }</span>

<span class="fc" id="L563">        editButton.setOnAction {</span>
<span class="nc" id="L564">            inEditMode = true</span>
<span class="nc" id="L565">            editLocation(selectedItem)</span>
<span class="nc" id="L566">        }</span>

<span class="fc" id="L568">        CommonUtils.showContextMenu(selectedRowIndex, locationTableView, menu, listOf(deleteButton,editButton))</span>
<span class="fc" id="L569">    }</span>


    /**
     * Usuwa lokalizację z bazy danych wraz z przypisanymi do niej salami.
     *
     * @param locationToDelete  lokalizacja do usunięcia z bazy danych.
     */
    override fun deleteLocation(locationToDelete: Location) {
<span class="fc" id="L578">        locationTableView.selectionModel.clearSelection()</span>
<span class="fc" id="L579">        menu.hide()</span>

<span class="pc bpc" id="L581" title="1 of 2 branches missed.">        if (wantToEdit) {</span>
<span class="fc" id="L582">            try {</span>
<span class="fc" id="L583">                locationsModel.deleteLocation(locationToDelete)</span>
<span class="pc bpc" id="L584" title="1 of 2 branches missed.">                if (locationTableView.items.size&gt;1) showLocations()</span>
<span class="nc" id="L585">                else locationTableView.items.clear()</span>
<span class="fc" id="L586">                MessageUtil.showInfoMessage(MessageBundle.getMess(&quot;label.operationSucceed&quot;), MessageBundle.getMess(&quot;success.plan.correctlyDeletedLocation&quot;))</span>
<span class="nc" id="L587">            }catch (e: SQLException) {</span>
<span class="nc" id="L588">                MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.operationFailed&quot;), MessageBundle.getMess(&quot;warning.deleteLocationError&quot;))</span>
            }
        }

<span class="fc" id="L592">    }</span>

    /**
     * Metoda sprawdza czy w bazie nie istnieją już lokalizacje o podobnych danych podczas edycji
     * @param location  Lokalizacja do edycji
     */
    fun checkDbWhileEditing(location: Location)
    {
<span class="fc" id="L600">        try {</span>
<span class="nc" id="L601">            locationsModel.checkDBWhileEditing(location, lastSelectedLocation, messageShown)</span>
<span class="nc" id="L602">            updateLocation(location)</span>

<span class="fc" id="L604">        }catch (e: DuplicatesException)</span>
        {
<span class="fc" id="L606">            MessageUtil.showWarningMessage(MessageBundle.getMess(&quot;warning.locationEditingError&quot;), e.message!!)</span>
        }
<span class="nc" id="L608">        catch (e: IdenticalObjectExistsException)</span>
        {
<span class="nc" id="L610">            showDialogYesNoMessage(e.message!!)</span>
<span class="nc bnc" id="L611" title="All 2 branches missed.">            if (wantToEdit) dialog.close()</span>
<span class="nc" id="L612">            inEditMode=false</span>
        }
<span class="fc" id="L614">    }</span>

    /**
     * Tworzy, konfiguruje i zwraca przycisk aktualizacji lokalizacji.
     *
     * @param errorLocation Etykieta do wyświetlania błędów związanych z polem lokalizacji.
     * @param errorCity Etykieta do wyświetlania błędów związanych z polem miasta.
     * @param errorStreet Etykieta do wyświetlania błędów związanych z polem ulicy.
     * @param errorPostcode Etykieta do wyświetlania błędów związanych z polem kodu pocztowego.
     * @return Przycisk aktualizacji lokalizacji.
     */
    override fun createUpdateButton(errorLocation: Label, errorCity: Label, errorStreet: Label, errorPostcode: Label): MFXButton {

<span class="fc" id="L627">        val updateButton = MFXButton(MessageBundle.getMess(&quot;label.update&quot;))</span>
<span class="fc" id="L628">        updateButton.id = &quot;customButton&quot;</span>
<span class="fc" id="L629">        updateButton.prefWidth = 200.0</span>

<span class="fc" id="L631">        updateButton.setOnAction {</span>
<span class="nc" id="L632">            onUpdateButtonPressed(errorLocation, errorCity, errorStreet, errorPostcode)</span>
<span class="nc" id="L633">        }</span>

<span class="fc" id="L635">        return updateButton</span>
    }

    /**
     * Ustawia walidacje na przycisku aktualizacji
     */
    fun onUpdateButtonPressed(errorLocation: Label, errorCity: Label, errorStreet: Label, errorPostcode: Label)
    {
<span class="fc" id="L643">        ValidationWrapper.validationAction(locationNameTextFieldEdit, errorLocation)</span>
<span class="fc" id="L644">        ValidationWrapper.validationAction(cityTextFieldEdit, errorCity)</span>
<span class="fc" id="L645">        ValidationWrapper.validationAction(streetTextFieldEdit, errorStreet)</span>
<span class="fc" id="L646">        ValidationWrapper.validationAction(postcodeTextFieldEdit, errorPostcode)</span>

<span class="pc bpc" id="L648" title="6 of 16 branches missed.">        if (errorLocation.text.isEmpty() &amp;&amp; errorCity.text.isEmpty() &amp;&amp; errorStreet.text.isEmpty() &amp;&amp;errorPostcode.text.isEmpty()) {</span>

<span class="fc" id="L650">            val location = Location(</span>
<span class="fc" id="L651">                locationName = locationNameTextFieldEdit.text,</span>
<span class="fc" id="L652">                city = cityTextFieldEdit.text,</span>
<span class="fc" id="L653">                street = streetTextFieldEdit.text,</span>
<span class="fc" id="L654">                postcode = postcodeTextFieldEdit.text</span>
            )

            //Sprawdź czy lokalizacja o podanych danych istnieje w bazie (oprócz samej siebie)
<span class="fc" id="L658">            checkDbWhileEditing(location)</span>
        }
<span class="fc" id="L660">    }</span>

    /**
     * Tworzy i wyświetla formularz pozwalający na edycję nauczyciela.
     *
     * @param locationToEdit Wybrana lokalizacja.
     */
    override fun editLocation(locationToEdit: Location) {
<span class="fc" id="L668">        locationNameTextFieldEdit.text = locationToEdit.locationName</span>
<span class="fc" id="L669">        cityTextFieldEdit.text = locationToEdit.city</span>
<span class="fc" id="L670">        streetTextFieldEdit.text = locationToEdit.street</span>
<span class="fc" id="L671">        postcodeTextFieldEdit.text = locationToEdit.postcode</span>

<span class="fc" id="L673">        val errorLocation = ValidationWrapper.createErrorLabel()</span>
<span class="fc" id="L674">        val errorCity = ValidationWrapper.createErrorLabel()</span>
<span class="fc" id="L675">        val errorStreet = ValidationWrapper.createErrorLabel()</span>
<span class="fc" id="L676">        val errorPostcode = ValidationWrapper.createErrorLabel()</span>

<span class="fc" id="L678">        val updateButton = createUpdateButton(errorLocation, errorCity, errorStreet, errorPostcode)</span>

<span class="fc" id="L680">        val vbox = VBox(20.0,</span>
<span class="fc" id="L681">            editDataLabel,</span>
<span class="fc" id="L682">            ValidationWrapper.createWrapper(locationNameTextFieldEdit, errorLocation),</span>
<span class="fc" id="L683">            ValidationWrapper.createWrapper(cityTextFieldEdit, errorCity),</span>
<span class="fc" id="L684">            ValidationWrapper.createWrapper(streetTextFieldEdit, errorStreet),</span>
<span class="fc" id="L685">            ValidationWrapper.createWrapper(postcodeTextFieldEdit, errorPostcode),</span>
<span class="fc" id="L686">            updateButton)</span>

<span class="fc" id="L688">        vbox.alignment = Pos.CENTER</span>
<span class="fc" id="L689">        createAndShowDialog(vbox)</span>
<span class="fc" id="L690">    }</span>

    /**
     * Aktualizuje lokalizację w bazie danych.
     *
     * @param location     lokalizacja do aktualizacji.
     */
    override fun updateLocation(location: Location) {
<span class="nc" id="L698">        val locationID = locationsModel.getLocationID(lastSelectedLocation)</span>

<span class="nc" id="L700">        val completedLabel = CommonUtils.createCompletedLabel(MessageBundle.getMess(&quot;label.locationUpdated&quot;))</span>

<span class="nc" id="L702">        val okButton = MFXButton(&quot;OK&quot;)</span>
<span class="nc" id="L703">        okButton.id = &quot;customButton&quot;</span>

<span class="nc" id="L705">        val vbox = VBox(20.0, completedLabel, okButton)</span>
<span class="nc" id="L706">        vbox.alignment = Pos.CENTER</span>

<span class="nc" id="L708">        okButton.setOnAction { dialog.close() }</span>

<span class="nc" id="L710">        try {</span>
<span class="nc" id="L711">            locationsModel.updateLocation(locationID, location)</span>
<span class="nc" id="L712">            showLocations()</span>
<span class="nc" id="L713">            (dialog.content as MFXGenericDialog).content = vbox</span>
<span class="nc" id="L714">            MessageUtil.showInfoMessage(MessageBundle.getMess(&quot;label.operationSucceed&quot;), MessageBundle.getMess(&quot;success.location.correctlyUpdated&quot;))</span>

<span class="nc" id="L716">        }catch (e: SQLException) {</span>
<span class="nc" id="L717">            MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.operationFailed&quot;), MessageBundle.getMess(&quot;warning.updateLocationError&quot;))</span>
        }
<span class="nc" id="L719">    }</span>


    /**
     * Wyświetla okno dialogowe z przyciskami &quot;Tak&quot; lub &quot;Nie&quot;.
     *
     * @param content Wiadomość do wyświetlenia.
     */
    fun showDialogYesNoMessage(content: String) {

<span class="fc" id="L729">        val buttons = listOf(</span>
<span class="pc" id="L730">            MessageBundle.getMess(&quot;label.yes&quot;) to { wantToEdit = true },</span>
<span class="pc" id="L731">            MessageBundle.getMess(&quot;label.no&quot;) to { wantToEdit = false}</span>
        )

<span class="pc bpc" id="L734" title="1 of 2 branches missed.">        dialogMess = DialogUtils.showMessageDialogWithButtons(content, showLocationsButton.scene.window as Stage, buttons)</span>
<span class="pc bpc" id="L735" title="1 of 2 branches missed.">        if (dialogMess.owner.isShowing) dialogMess.showAndWait()</span>
<span class="fc" id="L736">    }</span>

    /**
     * Tworzy i wyświetla customowe okno dialogowe.
     *
     * @param vBox Kontener z zawartością okna dialogowego.
     */
    override fun createAndShowDialog(vBox: VBox) {
<span class="fc" id="L744">        vBox.alignment = Pos.CENTER</span>


<span class="pc bpc" id="L747" title="1 of 2 branches missed.">        dialog = DialogUtils.showCustomDialog(showLocationsButton.scene.window as Stage, vBox) {</span>
<span class="nc" id="L748">            locationTableView.selectionModel.clearSelection()</span>
<span class="nc" id="L749">            menu.hide()</span>
<span class="nc" id="L750">            messageShown=false</span>
<span class="nc" id="L751">            inEditMode=false</span>
<span class="nc" id="L752">        }</span>

<span class="pc bpc" id="L754" title="1 of 2 branches missed.">        if (dialog.owner.isShowing) dialog.showAndWait()</span>
<span class="fc" id="L755">    }</span>


    /**
     * Tworzy i konfiguruje tabelę z lokalizacjami.
     */
    override fun setupTable() {
<span class="fc" id="L762">        val columns = mapOf&lt;MFXTableColumn&lt;Location&gt;, KProperty1&lt;Location, *&gt;&gt;(</span>
<span class="pc" id="L763">            MFXTableColumn(MessageBundle.getMess(&quot;label.name&quot;), false, Comparator.comparing(Location::locationName)) to Location::locationName,</span>
<span class="pc" id="L764">            MFXTableColumn(MessageBundle.getMess(&quot;label.city&quot;), false, Comparator.comparing(Location::city)) to Location::city,</span>
<span class="pc" id="L765">            MFXTableColumn(MessageBundle.getMess(&quot;label.street&quot;), false, Comparator.comparing(Location::street)) to Location::street,</span>
<span class="pc" id="L766">            MFXTableColumn(MessageBundle.getMess(&quot;label.postcode&quot;), false, Comparator.comparing(Location::postcode)) to Location::postcode</span>
        )
        
<span class="fc" id="L769">        columns.forEach{ column -&gt;</span>
<span class="fc" id="L770">            column.key.rowCellFactory = Function&lt;Location, MFXTableRowCell&lt;Location?, *&gt;&gt;</span>
            {
<span class="nc" id="L772">                val cell = MFXTableRowCell&lt;Location?, Any?&gt;(column.value)</span>
<span class="nc" id="L773">                cell.styleClass.add(&quot;table-cell&quot;)</span>
<span class="nc" id="L774">                cell</span>
            }
<span class="fc" id="L776">        }</span>

<span class="fc" id="L778">        locationTableView.filters.addAll(</span>
<span class="pc" id="L779">            StringFilter(MessageBundle.getMess(&quot;label.name&quot;), Location::locationName),</span>
<span class="pc" id="L780">            StringFilter(MessageBundle.getMess(&quot;label.city&quot;), Location::city),</span>
<span class="pc" id="L781">            StringFilter(MessageBundle.getMess(&quot;label.street&quot;), Location::street),</span>
<span class="pc" id="L782">            StringFilter(MessageBundle.getMess(&quot;label.postcode&quot;), Location::postcode)</span>
        )

<span class="fc" id="L785">        locationTableView.tableColumns.addAll(columns.keys)</span>

<span class="fc bfc" id="L787" title="All 2 branches covered.">        for (i in 0 until locationTableView.tableColumns.size) {</span>
<span class="fc" id="L788">            locationTableView.tableColumns[i].styleClass.add(&quot;table-header&quot;)</span>

        }
<span class="fc" id="L791">        locationTableView.tableColumns[0].minWidth = 150.0</span>
<span class="fc" id="L792">        locationTableView.tableColumns[1].minWidth = 150.0</span>
<span class="fc" id="L793">        locationTableView.tableColumns[2].minWidth = 150.0</span>
<span class="fc" id="L794">        locationTableView.tableColumns[3].minWidth = 80.0</span>
<span class="fc" id="L795">        locationTableView.isFooterVisible = true</span>
<span class="fc" id="L796">    }</span>


    /**
     * Metoda wywoływana podczas zmiany zakładek przed użytkownika - czyści panel.
     */
    override fun onTabsChanged() {
<span class="nc" id="L803">        locationTableView.items.clear()</span>
<span class="nc" id="L804">        locationTableView.selectionModel.clearSelection()</span>
<span class="nc" id="L805">        locationTableView.update()</span>
<span class="nc bnc" id="L806" title="All 2 branches missed.">        CommonUtils.removeStepDependencies(stepper, locationNameTextField, cityTextField, streetTextField, postcodeTextField)</span>
<span class="nc" id="L807">        createSteps()</span>
<span class="nc" id="L808">        clearAllLocationForm()</span>
<span class="nc" id="L809">        roomsToAdd.clear()</span>
<span class="nc" id="L810">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>