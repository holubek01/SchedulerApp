<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SchoolCurriculumUploaderController.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Scheduler</a> &gt; <a href="index.source.html" class="el_package">com.example.scheduler.controller</a> &gt; <span class="el_source">SchoolCurriculumUploaderController.kt</span></div><h1>SchoolCurriculumUploaderController.kt</h1><pre class="source lang-java linenums">package com.example.scheduler.controller

import com.example.scheduler.SchedulerApp
import com.example.scheduler.controller.observers.AdminTabsObserver
import com.example.scheduler.controller.observers.TabsObserver
import com.example.scheduler.models.FieldsModel
import com.example.scheduler.objects.Subject
import com.example.scheduler.utils.*
import io.github.palexdev.materialfx.controls.MFXButton
import io.github.palexdev.materialfx.controls.MFXListView
import io.github.palexdev.materialfx.dialogs.MFXStageDialog
import javafx.fxml.FXML
import javafx.scene.control.Label
import javafx.scene.image.Image
import javafx.scene.image.ImageView
import javafx.stage.FileChooser
import javafx.stage.Stage
import java.sql.SQLException
import java.util.Locale

/**
 * Klasa kontrolera modułu szkolnych planów nauczania do zarządzania szkolnymi planami nauczania
 */
<span class="nc" id="L24">class SchoolCurriculumUploaderController: AdminTabsObserver, ISchoolCurriculumUploaderController, TabsObserver{</span>

    /**
     * Przycisk do wybierania plików z systemu
     */
    @FXML
<span class="nc bnc" id="L30" title="All 2 branches missed.">    lateinit var chooseFilesButton: MFXButton</span>

    /**
     * Przycisk do załadowywania plików wybranych przez użytkownika
     */
    @FXML
<span class="nc bnc" id="L36" title="All 2 branches missed.">    lateinit var uploadSPNsButton: MFXButton</span>

    @FXML
<span class="nc bnc" id="L39" title="All 2 branches missed.">    lateinit var label: Label</span>

    /**
     * Pomocnicze okno dialogowe.
     */
    private lateinit var dialog: MFXStageDialog

    /**
     * Tabela, przechowująca ścieżki do plików ze szkolnymi planami nauczania, wybranymi przez użytkownika
     */
    @FXML
<span class="nc bnc" id="L50" title="All 2 branches missed.">    lateinit var chosenFilesListView: MFXListView&lt;String&gt;</span>

    /**
     * Przykładowy wzór ze szkolnym planem nauczania
     */
    @FXML
<span class="nc bnc" id="L56" title="All 2 branches missed.">    lateinit var spnExampleImage: ImageView</span>

    /**
     * Flaga informująca o chęci edycji szkolnego planu nauczania.
     */
<span class="nc" id="L61">    var wantToEdit = false</span>

    /**
     * Lista obiektów Subject reprezentujących plan nauczania
     */
<span class="nc" id="L66">    private  var subjectsToAdd: MutableList&lt;Subject&gt; = mutableListOf()</span>

<span class="nc" id="L68">    val fieldsModel = FieldsModel()</span>

    /**
     * Inicjalizacja kontrolera
     */
    @FXML
    fun initialize() {
<span class="nc" id="L75">        AdminTabObserver.addObserver(this)</span>
<span class="nc" id="L76">        TabObserver.addObserver(this)</span>
<span class="nc" id="L77">        chooseFilesButton.setOnAction { chooseFiles() }</span>
<span class="nc" id="L78">        uploadSPNsButton.setOnAction { uploadSPNs() }</span>

<span class="nc" id="L80">        uploadSPNsButton.text = MessageBundle.getMess(&quot;label.loadPlans&quot;)</span>
<span class="nc" id="L81">        chooseFilesButton.text = MessageBundle.getMess(&quot;label.chooseFiles&quot;)</span>
<span class="nc" id="L82">        label.text = MessageBundle.getMess(&quot;label.spnExample&quot;)</span>
<span class="nc" id="L83">        spnExampleImage.image =</span>
<span class="nc bnc" id="L84" title="All 4 branches missed.">            if(MessageBundle.bundle.locale == Locale(&quot;pl&quot;, &quot;PL&quot;)) Image(SchedulerApp::class.java.getResource(&quot;photos/excelSPNexample.png&quot;)?.toExternalForm())</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">            else Image(SchedulerApp::class.java.getResource(&quot;photos/excelSPNexampleEnglish.png&quot;)?.toExternalForm())</span>
<span class="nc" id="L86">    }</span>

    /**
     * Metoda nadpisująca szkolny plan nauczania nowym planem dla kierunku związanego z nazwą pliku
     * Nadpisanie SPN powoduje usunięcie aktualnego SPN oraz usunięcie z planu
     * wszystkich zajęć związanych z tym kierunkiem, czyli zajęć dla wszystkich grup z kierunku
     */
    override fun uploadSPNs()
    {
<span class="nc" id="L95">        val message = MessageBundle.getMess(&quot;warning.showBeforeOverridingSPN&quot;)</span>
<span class="nc" id="L96">        showDialogYesNoMessage(message)</span>

<span class="nc bnc" id="L98" title="All 2 branches missed.">        if (wantToEdit)</span>
        {
<span class="nc bnc" id="L100" title="All 2 branches missed.">            for (spn in chosenFilesListView.items) {</span>

<span class="nc" id="L102">                val fieldName = spn.split(&quot;\\&quot;).last().split(&quot;.&quot;)[0]</span>
<span class="nc" id="L103">                val fieldExists = fieldsModel.checkIfFieldExists(fieldName)</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">                if (fieldExists)</span>
                {
<span class="nc" id="L106">                    try {</span>
<span class="nc" id="L107">                        deleteExistingSPN(fieldName)</span>
<span class="nc" id="L108">                        uploadSPNsButton.scene.window as Stage</span>
<span class="nc" id="L109">                        ExcelUtils.uploadSingleSPN(spn, subjectsToAdd)</span>

<span class="nc bnc" id="L111" title="All 4 branches missed.">                        if (subjectsToAdd.isNotEmpty())</span>
                        {
<span class="nc" id="L113">                            try {</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">                                for (subject in subjectsToAdd)</span>
                                {
<span class="nc" id="L116">                                    fieldsModel.addSubjectToSem(subject.subjectName, fieldName, subject.semester, subject.hoursInSemester)</span>
                                }

<span class="nc" id="L119">                                MessageUtil.showInfoMessage(MessageBundle.getMess(&quot;label.operationSucceed&quot;), &quot;${MessageBundle.getMess(&quot;success.spn.planOverwrittenCorrectly&quot;)}: $fieldName&quot;)</span>
<span class="nc" id="L120">                            }catch (e: SQLException) {</span>
<span class="nc" id="L121">                                MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.operationFailed&quot;), MessageBundle.getMess(&quot;warning.addSPNError&quot;))</span>
<span class="nc" id="L122">                                subjectsToAdd.clear()</span>
                            }
                        }

<span class="nc" id="L126">                    }catch (e: SQLException) {</span>
<span class="nc" id="L127">                        MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.operationFailed&quot;), MessageBundle.getMess(&quot;warning.deleteSPNError&quot;))</span>
                    }


                }
                else
                {
                    //Kierunek nie istnieje (Nazwa kierunku pobierana jest z końca nazwy pliku - w bazie nie ma takiego kierunku)
<span class="nc" id="L135">                    MessageUtil.showWarningMessage(MessageBundle.getMess(&quot;warning.noFieldInDB&quot;), &quot;${MessageBundle.getMess(&quot;warning.badFieldNameInFile&quot;)}: $fieldName&quot;)</span>
                }
            }
<span class="nc" id="L138">            chosenFilesListView.items.clear()</span>
        }
<span class="nc" id="L140">    }</span>

    /**
     * Metoda wywoływana podczas zmiany zakładek przez użytkownika
     */
    override fun onTabsChanged() {
<span class="nc" id="L146">        chosenFilesListView.items.clear()</span>
<span class="nc" id="L147">    }</span>

    /**
     * Metoda pozwalająca na wybór przez użytkownika plików excel z systemu
     */
    override fun chooseFiles()
    {
<span class="nc" id="L154">        chosenFilesListView.items.clear()</span>
<span class="nc" id="L155">        val fileChooser = FileChooser()</span>
<span class="nc" id="L156">        fileChooser.extensionFilters.addAll(</span>
<span class="nc" id="L157">            FileChooser.ExtensionFilter(MessageBundle.getMess(&quot;label.OnlyXLSX&quot;), &quot;*.xlsx&quot;),</span>
            //FileChooser.ExtensionFilter(MessageBundle.getMess(&quot;label.OnlyXLS&quot;), &quot;*.xls&quot;)
        )
<span class="nc" id="L160">        val selectedFiles = fileChooser.showOpenMultipleDialog(chooseFilesButton.scene.window)</span>

<span class="nc bnc" id="L162" title="All 2 branches missed.">        selectedFiles?.forEach { file -&gt; chosenFilesListView.items.add(file.toString()) }</span>
<span class="nc" id="L163">    }</span>

    /**
     * Wyświetla okno dialogowe z przyciskami &quot;Tak&quot; lub &quot;Nie&quot;.
     *
     * @param content Wiadomość do wyświetlenia.
     */
    override fun showDialogYesNoMessage(content: String) {

<span class="nc" id="L172">        val stage = uploadSPNsButton.scene.window as Stage</span>
<span class="nc" id="L173">        val buttons = listOf(</span>
<span class="nc" id="L174">            MessageBundle.getMess(&quot;label.yes&quot;) to { wantToEdit = true },</span>
<span class="nc" id="L175">            MessageBundle.getMess(&quot;label.no&quot;) to { wantToEdit = false}</span>
        )

<span class="nc" id="L178">        dialog = DialogUtils.showMessageDialogWithButtons(content, stage, buttons)</span>
<span class="nc bnc" id="L179" title="All 6 branches missed.">        if(dialog.owner.isShowing) dialog.showAndWait()</span>
<span class="nc" id="L180">    }</span>


    /**
     * Metoda usuwająca istniejący szkolny plan nauczania związany z danym kierunkiem
     * @param fieldName Nazwa przedmiotu, dla którego usuwany jest szkolny plan nauczania
     */
    override fun deleteExistingSPN(fieldName: String) {
<span class="nc" id="L188">        fieldsModel.deleteSPN(fieldName)</span>
<span class="nc" id="L189">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>