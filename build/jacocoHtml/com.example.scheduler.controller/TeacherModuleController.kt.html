<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TeacherModuleController.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Scheduler</a> &gt; <a href="index.source.html" class="el_package">com.example.scheduler.controller</a> &gt; <span class="el_source">TeacherModuleController.kt</span></div><h1>TeacherModuleController.kt</h1><pre class="source lang-java linenums">package com.example.scheduler.controller

import com.example.scheduler.SchedulerApp
import com.example.scheduler.controller.exceptions.DuplicatesException
import com.example.scheduler.controller.exceptions.IdenticalObjectExistsException
import com.example.scheduler.controller.observers.AdminTabsObserver
import com.example.scheduler.controller.observers.TabsObserver
import com.example.scheduler.models.HoursModel
import com.example.scheduler.models.SubjectsModel
import com.example.scheduler.models.TeachersModel
import com.example.scheduler.objects.Teacher
import com.example.scheduler.utils.*
import io.github.palexdev.materialfx.controls.*
import io.github.palexdev.materialfx.controls.cell.MFXTableRowCell
import io.github.palexdev.materialfx.dialogs.MFXStageDialog
import io.github.palexdev.materialfx.effects.DepthLevel
import io.github.palexdev.materialfx.filter.StringFilter
import io.github.palexdev.mfxresources.fonts.MFXFontIcon
import javafx.collections.FXCollections
import javafx.fxml.FXML
import javafx.geometry.Insets
import javafx.geometry.Pos
import javafx.scene.control.Label
import javafx.scene.layout.VBox
import javafx.scene.paint.Color
import javafx.stage.Stage
import org.apache.poi.ss.usermodel.DataFormatter
import org.apache.poi.xssf.usermodel.XSSFWorkbook
import java.io.File
import java.io.FileInputStream
import java.io.IOException
import java.sql.SQLException
import java.util.*
import java.util.function.Function
import kotlin.reflect.KProperty1

/**
 * Klasa kontrolera modułu TeacherModule do zarządzania danymi nauczycieli
 */
<span class="fc" id="L40">class TeacherModuleController: ITeacherModuleController, AdminTabsObserver, TabsObserver {</span>
    /**
     * Przycisk służący do wyświetlania listy nauczycieli.
     */
    @FXML
    private lateinit var showTeachersButton: MFXButton

    /**
     * Tabela służąca do wyświetlania listy nauczycieli.
     */
    @FXML
<span class="pc bpc" id="L51" title="1 of 2 branches missed.">    lateinit var teacherTableView: MFXTableView&lt;Teacher&gt;</span>

    /**
     * Stepper odpowiedzialny za proces dodawania nauczyciela wraz z walidacją danych.
     */
    @FXML
<span class="pc bpc" id="L57" title="1 of 2 branches missed.">    lateinit var stepper: MFXStepper</span>

    /**
     * Stepper odpowiedzialny za proces edytowania nauczyciela wraz z walidacją danych.
     */
<span class="pc" id="L62">    var stepperEdit: MFXStepper = MFXStepper()</span>

    /**
     * Obiekt reprezentujący ostatnio wybranego nauczyciela z tabeli
     */
<span class="pc bpc" id="L67" title="1 of 2 branches missed.">    lateinit var lastSelectedTeacher: Teacher</span>

    /**
     * Flaga informująca o edycji nauczyciela.
     */
<span class="pc" id="L72">    var wantToEdit = false</span>

    /**
     * Flaga informująca o usunięcia nauczyciela.
     */
<span class="pc" id="L77">    var wantToDelete = false</span>

    /**
     * Flaga informująca o tym czy nauczyciel jest w trybie edycji
     */
<span class="nc" id="L82">    var inEditMode = false</span>

    /**
     * Flaga informująca o wyświetleniu okna dialogowego z komunikatem.
     */
    private var messageShown = false


    /**
     * Pomocnicze okno dialogowe do wiadomości.
     */
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">    lateinit var dialogMess: MFXStageDialog</span>


    /**
     * Pomocnicze okno dialogowe do menu kontekstowego.
     */
<span class="pc bpc" id="L99" title="1 of 2 branches missed.">    lateinit var dialog: MFXStageDialog</span>

    /**
     * Pole tekstowe do wprowadzania imienia podczas dodawania nauczyciela
     */
<span class="pc" id="L104">    var firstNameTextField: MFXTextField = MFXTextField()</span>

    /**
     * Pole tekstowe do wprowadzania nazwiska podczas dodawania nauczyciela
     */
<span class="pc" id="L109">    var lastNameTextField: MFXTextField = MFXTextField()</span>

    /**
     * Pole tekstowe do wprowadzania adresu email podczas dodawania nauczyciela
     */
<span class="pc" id="L114">    var emailTextField: MFXTextField = MFXTextField()</span>

    /**
     * Pole tekstowe do wprowadzania numeru telefonu podczas dodawania nauczyciela
     */
<span class="pc" id="L119">    var phoneTextField: MFXTextField = MFXTextField()</span>

    /**
     * Pole tekstowe do wprowadzania imienia podczas edycji nauczyciela
     */
<span class="pc" id="L124">    var firstNameTextFieldEdit: MFXTextField = MFXTextField()</span>

    /**
     * Pole tekstowe do wprowadzania nazwiska podczas edycji nauczyciela
     */
<span class="pc" id="L129">    var lastNameTextFieldEdit: MFXTextField = MFXTextField()</span>

    /**
     * Pole tekstowe do wprowadzania adresu email podczas edycji nauczyciela
     */
<span class="pc" id="L134">    var emailTextFieldEdit: MFXTextField = MFXTextField()</span>

    /**
     * Pole tekstowe do wprowadzania numeru telefonu podczas edycji nauczyciela
     */
<span class="pc" id="L139">    var phoneTextFieldEdit: MFXTextField = MFXTextField()</span>


    /**
     * Lista wybranych przedmiotów nauczyciela w trybie dodawania.
     */
<span class="pc" id="L145">    var subjectCheckList: MFXCheckListView&lt;String&gt; = MFXCheckListView()</span>

    /**
     * Etykieta przedmiotów w trybie dodawania
     */
<span class="pc" id="L150">    var subjectLabel: Label = Label()</span>

    /**
     * Lista wybranych przedmiotów nauczyciela w trybie edycji.
     */
<span class="pc" id="L155">    var subjectCheckListEdit: MFXCheckListView&lt;String&gt; = MFXCheckListView()</span>

    /**
     * Etykieta przedmiotów w trybie edycji
     */
<span class="fc" id="L160">    private var subjectLabelEdit: Label = Label()</span>

    /**
     * Lista dni do wybrania dla dyspozycyjności w trybie dodawania
     */
<span class="pc" id="L165">    var dayChoiceBox: MFXComboBox&lt;String&gt; = MFXComboBox()</span>

    /**
     * Lista godzin dyspozycyjności do wybrania w trybie dodawania
     */
<span class="pc" id="L170">    var hourCheckList: MFXCheckListView&lt;String&gt; = MFXCheckListView()</span>

    /**
     * Etykieta dyspozycyjności w trybie dodawania
     */
<span class="pc" id="L175">    var availabilityLabel: Label = Label()</span>

    /**
     * Etykieta nauczyciela w trybie dodawania
     */
<span class="pc" id="L180">    var teacherLabel: Label = Label()</span>

    /**
     * Przycisk typu toggle zaznaczania wszystkich godzin w trybie dodawania
     */
<span class="pc" id="L185">    var allHoursCheckBox: MFXToggleButton = MFXToggleButton()</span>

    /**
     * Etykieta dyspozycyjności w trybie edycji
     */
<span class="pc" id="L190">    var availabilityLabelEdit: Label = Label()</span>

    /**
     * Etykieta nauczyciela w trybie edycji
     */
<span class="fc" id="L195">    private var teacherLabelEdit: Label = Label()</span>

    /**
     * Lista dni do wybrania dla dyspozycyjności w trybie dodawania
     */
<span class="pc" id="L200">    var dayChoiceBoxEdit: MFXComboBox&lt;String&gt; = MFXComboBox()</span>

    /**
     * Lista godzin dyspozycyjności do wybrania w trybie edycji
     */
<span class="pc" id="L205">    var hourCheckListEdit: MFXCheckListView&lt;String&gt; = MFXCheckListView()</span>

    /**
     * Przycisk typu toggle zaznaczania wszystkich godzin w trybie edycji
     */
<span class="fc" id="L210">    private var allHoursCheckBoxEdit: MFXToggleButton = MFXToggleButton()</span>

    /**
     * Menu kontekstowe wyświetlające się po kliknięciu na wiersz tabeli z nauczycielami
     */
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">    lateinit var menu: MFXContextMenu</span>

    private var messageShownSubjects = false

    /**
     * Przycisk do dodawania nauczycieli z pliku
     */
    @FXML
    private lateinit var addTeacherFromFileButton : MFXButton


    /**
     * Mapa przechowująca dyspozycyjność nauczyciela
     */
<span class="fc" id="L229">    var availabilityList = mutableMapOf&lt;String, MutableList&lt;String&gt;&gt;().apply {</span>
<span class="fc" id="L230">        this[&quot;Friday&quot;] = mutableListOf()</span>
<span class="fc" id="L231">        this[&quot;Saturday&quot;] = mutableListOf()</span>
<span class="fc" id="L232">        this[&quot;Sunday&quot;] = mutableListOf()</span>
<span class="fc" id="L233">    }</span>

<span class="fc" id="L235">    val teachersModel = TeachersModel()</span>
<span class="fc" id="L236">    private val hoursModel = HoursModel()</span>
<span class="fc" id="L237">    private val subjectsModel = SubjectsModel()</span>

    /**
     * Inicjalizacja kontrolera
     */
    @FXML
    fun initialize() {
<span class="fc" id="L244">        TabObserver.addObserver(this)</span>
<span class="fc" id="L245">        AdminTabObserver.addObserver(this)</span>
        //I18N.setLanguage(Language.SIMPLIFIED_POLISH)
<span class="fc" id="L247">        setupTable()</span>
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">        showTeachersButton.setOnAction { showTeachers() }</span>
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">        addTeacherFromFileButton.setOnAction { showAddTeacherFromFileDialog()}</span>
<span class="fc" id="L250">        menu = MFXContextMenu(teacherTableView)</span>
<span class="fc" id="L251">        setOnTeacherSelected()</span>
<span class="fc" id="L252">        setUpUIComponents()</span>
<span class="fc" id="L253">    }</span>

    /**
     * Konfiguruje komponenty GUI
     */
    override fun setUpUIComponents() {
<span class="fc" id="L259">        setOnDaySelected(dayChoiceBox, hourCheckList)</span>
<span class="fc" id="L260">        setOnDaySelected(dayChoiceBoxEdit, hourCheckListEdit)</span>

<span class="fc" id="L262">        setupTeacherForm(teacherLabel, firstNameTextField, lastNameTextField, emailTextField, phoneTextField, subjectCheckList, subjectLabel, availabilityLabel, hourCheckList, dayChoiceBox, allHoursCheckBox)</span>
<span class="fc" id="L263">        setupTeacherForm(teacherLabelEdit, firstNameTextFieldEdit, lastNameTextFieldEdit, emailTextFieldEdit, phoneTextFieldEdit, subjectCheckListEdit, subjectLabelEdit, availabilityLabelEdit, hourCheckListEdit, dayChoiceBoxEdit, allHoursCheckBoxEdit)</span>

<span class="fc" id="L265">        setConstraints(firstNameTextField, lastNameTextField, phoneTextField, emailTextField)</span>
<span class="fc" id="L266">        setConstraints(firstNameTextFieldEdit, lastNameTextFieldEdit, phoneTextFieldEdit, emailTextFieldEdit)</span>

<span class="fc" id="L268">        createSteps(firstNameTextField, lastNameTextField, phoneTextField, emailTextField, subjectCheckList, dayChoiceBox, hourCheckList, stepper, teacherLabel, subjectLabel, availabilityLabel, allHoursCheckBox)</span>
<span class="fc" id="L269">        createSteps(firstNameTextFieldEdit, lastNameTextFieldEdit, phoneTextFieldEdit, emailTextFieldEdit, subjectCheckListEdit, dayChoiceBoxEdit, hourCheckListEdit, stepperEdit, teacherLabelEdit, subjectLabelEdit, availabilityLabelEdit, allHoursCheckBoxEdit)</span>

<span class="fc" id="L271">        stepper.styleClass.add(&quot;stepper&quot;)</span>
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">        showTeachersButton.text = MessageBundle.getMess(&quot;label.showTeachers&quot;)</span>
<span class="fc" id="L273">    }</span>

    /**
     * Wyświetla listę nauczycieli w tabeli
     */
    override fun showTeachers() {
<span class="fc" id="L279">        teacherTableView.items.clear()</span>
<span class="fc" id="L280">        val teachers = teachersModel.getTeachers()</span>
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">        if (teachers.isEmpty()) {</span>
<span class="nc" id="L282">            MessageUtil.showInfoMessage(MessageBundle.getMess(&quot;warning.noTeachers&quot;), MessageBundle.getMess(&quot;warning.teacherNotInDB&quot;))</span>
<span class="nc" id="L283">            teacherTableView.items.clear()</span>
<span class="fc" id="L284">        } else teacherTableView.items = teachers</span>
<span class="fc" id="L285">    }</span>


    /**
     * Dodaje nowego nauczyciela wraz z przedmiotami oraz dyspozycyjnością do bazy danych.
     *
     * @param teacher   Nauczyciel do dodania.
     * @param subjects  Lista przedmiotów nauczanych przez nauczyciela.
     */
    override fun addTeacher(teacher: Teacher, subjects: List&lt;String&gt;) {
<span class="fc" id="L295">        try {</span>
<span class="fc" id="L296">            teachersModel.addTeacher(teacher, subjects, availabilityList)</span>
<span class="fc" id="L297">            MessageUtil.showInfoMessage(MessageBundle.getMess(&quot;label.operationSucceed&quot;), MessageBundle.getMess(&quot;success.teacher.correctlyAdded&quot;))</span>
<span class="nc" id="L298">        }catch (e: SQLException) {</span>
<span class="nc" id="L299">            MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.operationFailed&quot;), MessageBundle.getMess(&quot;warning.teacherAddingError&quot;))</span>
<span class="nc" id="L300">            teachersModel.deleteTeacher(teacher)</span>
        }

<span class="fc" id="L303">        showTeachers()</span>
<span class="fc" id="L304">        availabilityList.values.forEach { it.clear() }</span>
<span class="fc" id="L305">    }</span>

    /**
     * Aktualizuje nauczyciela w bazie danych.
     *
     * @param teacher     Nauczyciel po aktualizacji.
     * @param subjects    Lista przedmiotów nauczyciela do aktualizacji.
     * @param deletedAvailability Lista dyspozycyjności, której nie ma na nowej liście dyspozycyjności, a która znajdowała się na starej
     */
    override fun updateTeacher(
        teacher: Teacher,
        subjects: List&lt;String&gt;,
        deletedAvailability: MutableMap&lt;String, MutableList&lt;String&gt;&gt;
    ) {
<span class="fc" id="L319">        val teacherID = teachersModel.getTeacherID(lastSelectedTeacher)</span>

<span class="fc" id="L321">        try {</span>
<span class="fc" id="L322">            teachersModel.handleDeleteSubjects(teacherID, lastSelectedTeacher, subjects)</span>
<span class="fc" id="L323">            teachersModel.handleDeleteAvailabulity(teacherID, deletedAvailability)</span>
<span class="fc" id="L324">            teachersModel.updateTeacher(teacherID, teacher, subjects)</span>
<span class="fc" id="L325">            try {</span>
<span class="fc" id="L326">                teachersModel.updateTeacherAvailability(availabilityList, teacherID)</span>
<span class="fc" id="L327">                MessageUtil.showInfoMessage(MessageBundle.getMess(&quot;label.operationSucceed&quot;), MessageBundle.getMess(&quot;success.teacher.correctlyUpdated&quot;))</span>
<span class="nc" id="L328">            }catch (e: SQLException) {</span>
<span class="nc" id="L329">                MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.operationFailed&quot;), MessageBundle.getMess(&quot;warning.updateTeacherAvailabilityError&quot;))</span>
            }
        }
<span class="nc" id="L332">        catch (e: SQLException) {</span>
<span class="nc" id="L333">            MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.operationFailed&quot;), MessageBundle.getMess(&quot;warning.updateTeacherError&quot;))</span>
        }

<span class="fc" id="L336">        availabilityList.values.forEach{it.clear()}</span>
<span class="fc" id="L337">        showTeachers()</span>
<span class="fc" id="L338">    }</span>

    /**
     * Usuwa nauczyciela z bazy danych.
     *
     * @param teacher  Nauczyciel do usunięcia z bazy danych.
     */
    override fun deleteTeacher(teacher: Teacher) {
<span class="fc" id="L346">        teacherTableView.selectionModel.clearSelection()</span>
<span class="fc" id="L347">        menu.hide()</span>

<span class="pc bpc" id="L349" title="1 of 2 branches missed.">        if (wantToDelete) {</span>
<span class="fc" id="L350">            try {</span>
<span class="fc" id="L351">                teachersModel.deleteTeacher(teacher)</span>
<span class="fc" id="L352">                MessageUtil.showInfoMessage(MessageBundle.getMess(&quot;label.operationSucceed&quot;), MessageBundle.getMess(&quot;success.plan.correctlyDeletedTeacher&quot;))</span>
<span class="nc" id="L353">            }catch (e: SQLException) {</span>
<span class="nc" id="L354">                MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.operationFailed&quot;), MessageBundle.getMess(&quot;warning.deleteTeacherError&quot;))</span>
            }
        }
<span class="pc bpc" id="L357" title="1 of 2 branches missed.">        if (teacherTableView.items.size&gt;1) showTeachers() else teacherTableView.items.clear()</span>
<span class="fc" id="L358">    }</span>


    /**
     * Tworzy pierwszy krok formularza dodawania lub edycji nauczyciela.
     *
     * @param firstName      Pole tekstowe do wprowadzania imienia.
     * @param lastName       Pole tekstowe do wprowadzania nazwiska.
     * @param phone          Pole tekstowe do wprowadzania numeru telefonu.
     * @param email          Pole tekstowe do wprowadzania adresu email.
     * @param stepper        Stepper dodawania lub edycji nauczyciela.
     * @param labelTeacher   Etykieta nauczyciela.
     * @return               Pierwszy krok formularza.
     */
    override fun createStep1(firstName: MFXTextField, lastName: MFXTextField, phone: MFXTextField, email: MFXTextField, stepper: MFXStepper, labelTeacher: Label): MFXStepperToggle {
<span class="fc" id="L373">        val step = MFXStepperToggle(MessageBundle.getMess(&quot;label.data&quot;), MFXFontIcon(&quot;fas-user&quot;, 16.0, Color.web(&quot;#40F6F6&quot;)))</span>
<span class="fc" id="L374">        val step1Box = VBox(</span>
<span class="fc" id="L375">            10.0,</span>
<span class="fc" id="L376">            labelTeacher,</span>
<span class="fc" id="L377">            ValidationWrapper.wrapNodeForValidationStepper(firstName, stepper),</span>
<span class="fc" id="L378">            ValidationWrapper.wrapNodeForValidationStepper(lastName, stepper),</span>
<span class="fc" id="L379">            ValidationWrapper.wrapNodeForValidationStepper(phone, stepper),</span>
<span class="fc" id="L380">            ValidationWrapper.wrapNodeForValidationStepper(email, stepper),</span>
        )

<span class="fc" id="L383">        step1Box.alignment = Pos.CENTER</span>
<span class="fc" id="L384">        step.content = step1Box</span>

<span class="fc" id="L386">        step.validator</span>
<span class="fc" id="L387">            .dependsOn(firstName.validator)</span>
<span class="fc" id="L388">            .dependsOn(lastName.validator)</span>
<span class="fc" id="L389">            .dependsOn(phone.validator)</span>
<span class="fc" id="L390">            .dependsOn(email.validator)</span>
<span class="fc" id="L391">        return step</span>
    }

    /**
     * Tworzy drugi krok formularza.
     *
     * @param labelSubjects  Etykieta przedmiotów.
     * @param subjects       Lista przedmiotów.
     * @return               Drugi krok formularza.
     */
    override fun createStep2(labelSubjects: Label, subjects: MFXCheckListView&lt;String&gt;): MFXStepperToggle {
<span class="fc" id="L402">        val step = MFXStepperToggle(MessageBundle.getMess(&quot;label.subjects&quot;), MFXFontIcon(&quot;fas-pen&quot;, 16.0, Color.web(&quot;#40F6F6&quot;)))</span>
<span class="fc" id="L403">        val step2Box = VBox(30.0, labelSubjects, subjects)</span>

<span class="fc" id="L405">        step2Box.alignment = Pos.CENTER</span>
<span class="fc" id="L406">        step.content = step2Box</span>
<span class="fc" id="L407">        step2Box.padding = Insets(30.0)</span>
<span class="fc" id="L408">        return step</span>
    }

    /**
     * Tworzy trzeci krok formularza.
     *
     * @param labelAvailability  Etykieta dyspozycyjności.
     * @param days              Lista dni do wyboru.
     * @param hours             Lista godzin dyspozycyjności.
     * @param allHoursToggle     Przycisk do zaznaczania wszystkich godzin.
     * @return                  Trzeci krokformularza.
     */
    override fun createStep3(labelAvailability: Label, days: MFXComboBox&lt;String&gt;, hours: MFXCheckListView&lt;String&gt;, allHoursToggle: MFXToggleButton): MFXStepperToggle {
<span class="fc" id="L421">        val step = MFXStepperToggle(MessageBundle.getMess(&quot;label.availabilityShort&quot;), MFXFontIcon(&quot;fas-clock&quot;, 16.0, Color.web(&quot;#40F6F6&quot;)))</span>
<span class="fc" id="L422">        val step3Box = VBox(20.0, labelAvailability, days, allHoursToggle, hours)</span>

<span class="fc" id="L424">        CommonUtils.clearBox(days)</span>
<span class="fc" id="L425">        allHoursToggle.isSelected = false</span>
<span class="fc" id="L426">        allHoursToggle.isDisable = true</span>

<span class="fc" id="L428">        allHoursToggle.setOnAction {</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">            for (hour in hours.items) {</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">                if (allHoursToggle.isSelected) {</span>
<span class="nc" id="L431">                    hours.selectionModel.selectItem(hour)</span>
                }
            }

<span class="nc bnc" id="L435" title="All 2 branches missed.">            if (!allHoursToggle.isSelected) {</span>
<span class="nc" id="L436">                hours.selectionModel.clearSelection()</span>
            }
<span class="nc" id="L438">        }</span>

<span class="fc" id="L440">        step3Box.padding = Insets(20.0)</span>
<span class="fc" id="L441">        step3Box.alignment = Pos.CENTER</span>
<span class="fc" id="L442">        step.content = step3Box</span>
<span class="fc" id="L443">        return step</span>
    }


    override fun showAddTeacherFromFileDialog() {
<span class="nc" id="L448">        val vbox = createAddTeacherFromFileVBox()</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">        dialog = DialogUtils.showCustomDialog(showTeachersButton.scene.window as Stage, vbox, true) {}</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">        dialog.content.stylesheets.add(SchedulerApp::class.java.getResource(&quot;css/customStyles.css&quot;)?.toExternalForm()!!)</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">        if (dialog.owner.isShowing) dialog.showAndWait()</span>
<span class="nc" id="L452">    }</span>

    /**
     * Wczytuje nauczycieli z pliku Excel.
     *
     * @param filePath Ścieżka do pliku Excel zawierającego dane o nauczycielach.
     */
    override fun uploadFileTeachers(filePath: String)
    {
<span class="pc bpc" id="L461" title="2 of 4 branches missed.">        if (filePath.isNotEmpty())</span>
        {
<span class="fc" id="L463">            val teachersToAdd = mutableMapOf&lt;Teacher, List&lt;String&gt;&gt;()</span>
<span class="fc" id="L464">            val dataFormatter = DataFormatter()</span>
<span class="fc" id="L465">            val file = File(filePath)</span>
<span class="fc" id="L466">            var myWorkBook:XSSFWorkbook?=null</span>
<span class="fc" id="L467">            var fis:FileInputStream?=null</span>

<span class="fc" id="L469">            try {</span>
<span class="fc" id="L470">                fis = FileInputStream(file)</span>
<span class="fc" id="L471">                myWorkBook = XSSFWorkbook(fis)</span>
<span class="fc" id="L472">                val sheet = myWorkBook.getSheetAt(0)</span>

<span class="fc" id="L474">                var startRowNr = 1</span>
<span class="fc" id="L475">                val startCellNr = 1</span>

<span class="fc bfc" id="L477" title="All 2 branches covered.">                while (sheet.getRow(startRowNr)!=null)</span>
                {
<span class="fc" id="L479">                    val firstname = dataFormatter.formatCellValue(sheet.getRow(startRowNr).getCell(startCellNr))</span>
<span class="fc" id="L480">                    val lastname = dataFormatter.formatCellValue(sheet.getRow(startRowNr).getCell(startCellNr+1))</span>
<span class="fc" id="L481">                    val phone = dataFormatter.formatCellValue(sheet.getRow(startRowNr).getCell(startCellNr+2))</span>
<span class="fc" id="L482">                    val email = dataFormatter.formatCellValue(sheet.getRow(startRowNr).getCell(startCellNr+3))</span>

<span class="fc" id="L484">                    var error = &quot;&quot;</span>
<span class="fc" id="L485">                    val subjects = mutableListOf&lt;String&gt;()</span>
<span class="fc" id="L486">                    var cellNum = startCellNr+4</span>
<span class="fc bfc" id="L487" title="All 2 branches covered.">                    while (sheet.getRow(startRowNr).getCell(cellNum)!=null)</span>
                    {
<span class="fc" id="L489">                        val subject = sheet.getRow(startRowNr).getCell(cellNum).stringCellValue</span>
                        //Sprawdź czy przedmiot istnieje
<span class="pc bpc" id="L491" title="1 of 2 branches missed.">                        if (subjectsModel.checkIfSubjectExists(subject)) subjects.add(subject)</span>
                        else
                        {
<span class="nc" id="L494">                            error = &quot;${MessageBundle.getMess(&quot;warning.subjectNotExists&quot;)}: $subject&quot;</span>
<span class="nc" id="L495">                            break</span>
                        }
<span class="fc" id="L497">                        cellNum++</span>
                    }

<span class="fc" id="L500">                    val teacher = Teacher(firstname, lastname, email, phone)</span>
<span class="pc bpc" id="L501" title="2 of 4 branches missed.">                    if (error.isEmpty()) error = teachersModel.validateTeacher(teacher)</span>
<span class="fc bfc" id="L502" title="All 4 branches covered.">                    if (email.isEmpty()) throw java.lang.NullPointerException()</span>

<span class="fc" id="L504">                    try {</span>
<span class="fc" id="L505">                        teachersModel.checkDBwhileAdding(teacher)</span>
<span class="nc" id="L506">                    }catch (e:DuplicatesException)</span>
                    {
<span class="nc" id="L508">                        error = &quot;${e.message!!}: (${teacher.firstname} ${teacher.lastname})&quot;</span>
                    }

<span class="pc bpc" id="L511" title="2 of 4 branches missed.">                    if (error.isNotEmpty()){</span>
<span class="nc" id="L512">                        MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.fixExcelFile&quot;), error)</span>
<span class="pc" id="L513">                        return</span>
                    }

<span class="fc" id="L516">                    teachersToAdd[teacher] = subjects</span>
<span class="fc" id="L517">                    startRowNr++</span>
                }

                //Spróbuj dodać nauczycieli
<span class="fc" id="L521">                try {</span>
<span class="fc" id="L522">                    teachersModel.checkDuplicatesAndAddTeachers(teachersToAdd)</span>
<span class="fc" id="L523">                    MessageUtil.showInfoMessage(MessageBundle.getMess(&quot;label.fileLoaded&quot;), MessageBundle.getMess(&quot;success.teachers.fileLoadedCorrectly&quot;))</span>
<span class="pc bpc" id="L524" title="1 of 2 branches missed.">                    if (this::dialog.isInitialized) dialog.close()</span>
<span class="fc" id="L525">                }catch (e: DuplicatesException)</span>
                {
<span class="fc" id="L527">                    MessageUtil.showWarningMessage(MessageBundle.getMess(&quot;warning.fixExcelFile&quot;), e.message!!)</span>
<span class="fc" id="L528">                    return</span>
                }

            }
            //nieprawidłowa wartość
<span class="nc" id="L533">            catch (e: IllegalStateException)</span>
            {
<span class="nc" id="L535">                MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.readError&quot;), MessageBundle.getMess(&quot;warning.incorrectExcelForm&quot;))</span>
            }
            //Pusta komórka
<span class="fc" id="L538">            catch (e: NullPointerException)</span>
            {
<span class="fc" id="L540">                MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.readError&quot;), MessageBundle.getMess(&quot;warning.incorrectExcelForm&quot;))</span>
            }
<span class="nc" id="L542">            catch (e: IOException) {</span>
<span class="nc" id="L543">                MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.readError&quot;), MessageBundle.getMess(&quot;warning.fileAlreadyOpened&quot;))</span>
            }
            finally {
<span class="pc bpc" id="L546" title="1 of 2 branches missed.">                myWorkBook?.close()</span>
<span class="pc bpc" id="L547" title="1 of 2 branches missed.">                fis?.close()</span>
<span class="fc" id="L548">            }</span>
        }
        else{
<span class="nc" id="L551">            MessageUtil.showErrorMessage(MessageBundle.getMess(&quot;warning.fileLoadingError&quot;), MessageBundle.getMess(&quot;warning.shouldChooseFileFirst&quot;))</span>
        }
<span class="fc" id="L553">    }</span>

    /**
     * Tworzy layout informujący o powodzeniu dodania lub edycji nauczyciela
     *
     * @param firstName        Pole tekstowe do wprowadzania imienia.
     * @param lastName         Pole tekstowe do wprowadzania nazwiska.
     * @param phone            Pole tekstowe do wprowadzania numeru telefonu.
     * @param email            Pole tekstowe do wprowadzania adresu email.
     * @param subjects         Lista przedmiotów.
     * @param days             Lista dni do wyboru.
     * @param hours            Lista godzin dyspozycyjności.
     * @param labelTeacher     Etykieta nauczyciela.
     * @param labelSubjects    Etykieta przedmiotów.
     * @param labelAvailability Etykieta dyspozycyjności.
     * @param allHoursToggle    Przycisk do zaznaczania wszystkich godzin.
     * @param step3             Trzeci krok formularza.
     * @param stepper           Stepper dodawania lub edycji nauczyciela.
     */
    override fun createCompletedStep(firstName: MFXTextField, lastName: MFXTextField, phone: MFXTextField, email: MFXTextField, subjects: MFXCheckListView&lt;String&gt;, days: MFXComboBox&lt;String&gt;, hours: MFXCheckListView&lt;String&gt;, labelTeacher: Label, labelSubjects: Label, labelAvailability: Label, allHoursToggle: MFXToggleButton, step3: MFXStepperToggle, stepper: MFXStepper) {
<span class="fc" id="L573">        val completedLabel = CommonUtils.createCompletedLabel(MessageBundle.getMess(&quot;label.teacherAdded&quot;))</span>
<span class="fc" id="L574">        val resetButton = CommonUtils.createResetButton()</span>

<span class="fc" id="L576">        resetButton.setOnAction {</span>
<span class="nc" id="L577">            setOnResetButton(firstName, lastName, phone, email, subjects, days, hours, labelTeacher, labelSubjects, labelAvailability, allHoursToggle, stepper)</span>
<span class="nc" id="L578">        }</span>

<span class="fc" id="L580">        stepper.setOnLastNext {</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">            if (!inEditMode) {availabilityList.values.forEach { it.clear() }}</span>
<span class="nc" id="L582">            checkLastStep(firstName, lastName, phone, email, subjects, days, hours, completedLabel, step3, resetButton, stepper)</span>
<span class="nc" id="L583">        }</span>
<span class="fc" id="L584">    }</span>


    /**
     * Dokonuje walidacji danych przy ostatnim kroku oraz sprawdza, które
     * terminy dyspozycyjności zostały usunięte z listy dyspozycyjności nauczyciela
     */
    fun checkLastStep(firstName: MFXTextField, lastName: MFXTextField, phone: MFXTextField, email: MFXTextField, subjects: MFXCheckListView&lt;String&gt;, days: MFXComboBox&lt;String&gt;, hours: MFXCheckListView&lt;String&gt;, completedLabel: Label, step3: MFXStepperToggle, resetButton: MFXButton, stepper: MFXStepper)
    {
        //Jeśli dzień został wybrany to dodaj godziny
<span class="pc bpc" id="L594" title="1 of 6 branches missed.">        if (!days.value.isNullOrEmpty()) {</span>
<span class="pc bpc" id="L595" title="1 of 2 branches missed.">            val dayValue = if (MessageBundle.bundle.locale.equals(Locale(&quot;pl&quot;, &quot;PL&quot;))) EnglishDayConverter.fromPolishName(days.value) else days.value</span>
<span class="fc" id="L596">            availabilityList[dayValue]!!.clear()</span>
<span class="fc bfc" id="L597" title="All 2 branches covered.">            for (hour in hours.selectionModel.selectedValues) {</span>
<span class="fc" id="L598">                availabilityList[dayValue]!!.add(hour)</span>
            }
        }

        //Jeśli nie dodano dyspozycyjności
<span class="fc bfc" id="L603" title="All 4 branches covered.">        if (availabilityList.values.all { it.isEmpty() }) {</span>
<span class="fc" id="L604">            MessageUtil.showWarningMessage(MessageBundle.getMess(&quot;warning.availabilityError&quot;), MessageBundle.getMess(&quot;warning.noAvailabilityChosen&quot;))</span>
        }

<span class="fc bfc" id="L607" title="All 6 branches covered.">        if (availabilityList.values.any { it.isNotEmpty() }) {</span>
<span class="fc" id="L608">            val teacher = Teacher(firstName.text,lastName.text, email.text, phone.text)</span>

<span class="pc bpc" id="L610" title="1 of 2 branches missed.">            if (inEditMode) {</span>
<span class="nc" id="L611">                completedLabel.text = MessageBundle.getMess(&quot;label.teacherUpdated&quot;)</span>
<span class="nc" id="L612">                val deletedAvailability = getDeletedAvailability()</span>

<span class="nc bnc" id="L614" title="All 4 branches missed.">                if (deletedAvailability.values.all { it.isEmpty() })</span>
                {
<span class="nc" id="L616">                    updateTeacher(teacher, subjectCheckListEdit.selectionModel.selectedValues, deletedAvailability)</span>
<span class="nc" id="L617">                    val vbox = step3.content as VBox</span>
<span class="nc" id="L618">                    vbox.children.setAll(completedLabel, resetButton)</span>
                }
                else
                {
<span class="nc" id="L622">                    val translatedKeysMap = deletedAvailability.mapKeys { (key, _) -&gt;</span>
<span class="nc bnc" id="L623" title="All 4 branches missed.">                        when (key) {</span>
<span class="nc" id="L624">                            &quot;Friday&quot; -&gt; MessageBundle.getMess(&quot;label.friday&quot;)</span>
<span class="nc" id="L625">                            &quot;Saturday&quot; -&gt; MessageBundle.getMess(&quot;label.saturday&quot;)</span>
<span class="nc" id="L626">                            &quot;Sunday&quot; -&gt; MessageBundle.getMess(&quot;label.sunday&quot;)</span>
<span class="nc" id="L627">                            else -&gt; key</span>
                        }
<span class="nc" id="L629">                    }.toMutableMap()</span>

<span class="nc" id="L631">                    showDialogYesNoMessage(&quot;${MessageBundle.getMess(&quot;warning.askBeforeDeleteAvailability&quot;)} $translatedKeysMap&quot;, ActionType.EDIT)</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">                    if (!wantToEdit)</span>
                    {
<span class="nc" id="L634">                        stepperEdit.previous()</span>
<span class="nc" id="L635">                        hourCheckListEdit.selectionModel.clearSelection()</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">                        for (day in listOf(&quot;Friday&quot;, &quot;Saturday&quot;, &quot;Sunday&quot;)) {</span>
<span class="nc" id="L637">                            availabilityList[day] = teachersModel.getAvailabilityByDay(lastSelectedTeacher, day.uppercase(Locale.getDefault())).toMutableList()</span>
                        }

<span class="nc" id="L640">                        CommonUtils.clearBox(dayChoiceBoxEdit)</span>
                    }
                    else
                    {
<span class="nc" id="L644">                        updateTeacher(teacher, subjectCheckListEdit.selectionModel.selectedValues, deletedAvailability)</span>
<span class="nc" id="L645">                        val vbox = step3.content as VBox</span>
<span class="nc" id="L646">                        vbox.children.setAll(completedLabel, resetButton)</span>
                    }
                }
            } else {
<span class="fc" id="L650">                addTeacher(teacher, subjectCheckList.selectionModel.selectedValues)</span>
            }

<span class="fc" id="L653">            val vbox = step3.content as VBox</span>
<span class="fc" id="L654">            vbox.children.setAll(completedLabel, resetButton)</span>
        } else {
<span class="fc" id="L656">            stepper.previous()</span>
        }
<span class="fc" id="L658">    }</span>


    /**
     * Pobiera terminy dyspozycyjności, które nie zostały wybrane przez użytkownika w
     * nowej liście dyspozycyjności, a które znajdowały się na starej liście.
     * @return Terminy dyspozycyjności nauczyciela do usunięcia
     */
    private fun getDeletedAvailability(): MutableMap&lt;String, MutableList&lt;String&gt;&gt;
    {
        //pobierz dyspozycyjność lastTeacherSelected i porównaj z availablity

<span class="nc" id="L670">        val availabilityOld = mutableMapOf&lt;String, MutableList&lt;String&gt;&gt;().apply {</span>
<span class="nc" id="L671">            this[&quot;Friday&quot;] = mutableListOf()</span>
<span class="nc" id="L672">            this[&quot;Saturday&quot;] = mutableListOf()</span>
<span class="nc" id="L673">            this[&quot;Sunday&quot;] = mutableListOf()</span>
<span class="nc" id="L674">        }</span>

<span class="nc" id="L676">        var availabilityDeleted = mutableMapOf&lt;String, MutableList&lt;String&gt;&gt;().apply {</span>
<span class="nc" id="L677">            this[&quot;Friday&quot;] = mutableListOf()</span>
<span class="nc" id="L678">            this[&quot;Saturday&quot;] = mutableListOf()</span>
<span class="nc" id="L679">            this[&quot;Sunday&quot;] = mutableListOf()</span>
<span class="nc" id="L680">        }</span>

<span class="nc bnc" id="L682" title="All 2 branches missed.">        for (day in listOf(&quot;Friday&quot;, &quot;Saturday&quot;, &quot;Sunday&quot;)) {</span>
<span class="nc" id="L683">            availabilityOld[day] = teachersModel.getAvailabilityByDay(lastSelectedTeacher, day.uppercase(Locale.getDefault())).toMutableList()</span>
        }

<span class="nc bnc" id="L686" title="All 2 branches missed.">        for (day in listOf(&quot;Friday&quot;, &quot;Saturday&quot;, &quot;Sunday&quot;)) {</span>
<span class="nc" id="L687">            availabilityDeleted[day] = availabilityOld[day]!!.subtract(availabilityList[day]!!).toMutableList()</span>
        }

<span class="nc" id="L690">        var wasAvailabilityDeleted = false</span>
<span class="nc bnc" id="L691" title="All 4 branches missed.">        if (availabilityDeleted.values.any { it.isEmpty() }) {</span>
<span class="nc" id="L692">            wasAvailabilityDeleted = true</span>
        }

<span class="nc bnc" id="L695" title="All 2 branches missed.">        if (wasAvailabilityDeleted)</span>
        {
<span class="nc bnc" id="L697" title="All 4 branches missed.">            availabilityDeleted = availabilityDeleted.filterValues { it.isNotEmpty() }.toMutableMap()</span>
        }
<span class="nc" id="L699">        return availabilityDeleted</span>


    }

    /**
     * Obsługuje akcje wywoływane po naciśnięciu przycisku &quot;Reset&quot; na formularzu dodawania lub edycji nauczyciela.
     *
     * @param firstName         Pole tekstowe do wprowadzania imienia.
     * @param lastName          Pole tekstowe do wprowadzania nazwiska.
     * @param phone             Pole tekstowe do wprowadzania numeru telefonu.
     * @param email             Pole tekstowe do wprowadzania adresu email.
     * @param subjects          Lista przedmiotów.
     * @param days              Lista dni do wyboru.
     * @param hours             Lista godzin dyspozycyjności.
     * @param labelTeacher      Etykieta nauczyciela.
     * @param labelSubjects     Etykieta przedmiotów.
     * @param labelAvailability Etykieta dyspozycyjności.
     * @param allHoursToggle    Przycisk do zaznaczania wszystkich godzin.
     * @param stepper           Stepper dodawania lub edycji nauczyciela.
     */
    override fun setOnResetButton(firstName: MFXTextField, lastName: MFXTextField, phone: MFXTextField, email: MFXTextField, subjects: MFXCheckListView&lt;String&gt;, days: MFXComboBox&lt;String&gt;, hours: MFXCheckListView&lt;String&gt;, labelTeacher: Label, labelSubjects: Label, labelAvailability: Label, allHoursToggle: MFXToggleButton, stepper: MFXStepper) {
<span class="pc bpc" id="L721" title="1 of 2 branches missed.">        if (this::dialog.isInitialized) dialog.close()</span>
<span class="fc" id="L722">        CommonUtils.removeStepDependencies(stepper, firstName, lastName, phone, email)</span>
<span class="fc" id="L723">        createSteps(firstName, lastName, phone, email, subjects, days, hours, stepper, labelTeacher, labelSubjects, labelAvailability, allHoursToggle)</span>
<span class="pc bpc" id="L724" title="1 of 2 branches missed.">        if (!inEditMode) clearBoxes()</span>
<span class="fc" id="L725">        inEditMode = false</span>
<span class="fc" id="L726">    }</span>

    /**
     * Tworzy kroki dla stepper procesu dodawania lub edycji nauczyciela.
     *
     * @param firstName         Pole tekstowe do wprowadzania imienia.
     * @param lastName          Pole tekstowe do wprowadzania nazwiska.
     * @param phone             Pole tekstowe do wprowadzania numeru telefonu.
     * @param email             Pole tekstowe do wprowadzania adresu email.
     * @param subjects          Lista przedmiotów.
     * @param days              Lista dni do wyboru.
     * @param hours             Lista godzin dyspozycyjności.
     * @param stepper           Stepper dodawania lub edycji.
     * @param labelTeacher      Etykieta nauczyciela.
     * @param labelSubjects     Etykieta przedmiotów.
     * @param labelAvailability Etykieta dyspozycyjności.
     * @param allHoursToggle    Przycisk do zaznaczania wszystkich godzin.
     */
    override fun createSteps(firstName: MFXTextField, lastName: MFXTextField, phone: MFXTextField, email: MFXTextField, subjects: MFXCheckListView&lt;String&gt;, days: MFXComboBox&lt;String&gt;, hours: MFXCheckListView&lt;String&gt;, stepper: MFXStepper, labelTeacher: Label, labelSubjects: Label, labelAvailability: Label, allHoursToggle: MFXToggleButton) {

<span class="fc" id="L746">        val step1 = createStep1(firstName, lastName, phone, email, stepper, labelTeacher)</span>
<span class="fc" id="L747">        val step2 = createStep2(labelSubjects, subjects)</span>
<span class="fc" id="L748">        val step3 = createStep3(labelAvailability, days, hours, allHoursToggle)</span>
<span class="fc" id="L749">        createCompletedStep(firstName, lastName, phone, email, subjects, days, hours, labelTeacher, labelSubjects, labelAvailability, allHoursToggle, step3, stepper)</span>

<span class="fc" id="L751">        stepper.stepperToggles.addAll(listOf(step1, step2, step3))</span>
<span class="fc" id="L752">        performActionsBetweenSteps(subjects, firstName, lastName, phone, email, stepper)</span>
<span class="fc" id="L753">    }</span>


    /**
     * Obsługuje akcje wywoływane po kliknięciu na nauczyciela w tabeli.
     */
    override fun setOnTeacherSelected() {
<span class="fc" id="L760">        CommonUtils.setOnItemSelected(teacherTableView, menu) { selectedRowIndex -&gt;</span>
<span class="nc" id="L761">            lastSelectedTeacher = teacherTableView.items[selectedRowIndex]</span>
<span class="nc" id="L762">            showContextMenu(selectedRowIndex, lastSelectedTeacher)</span>
<span class="nc" id="L763">        }</span>
<span class="fc" id="L764">    }</span>


    /**
     * Obsługuje akcje wywoływane po wyborze dnia w kroku 3 dodawania lub edycji nauczyciela.
     *
     * @param dayBox   Lista dni do wyboru.
     * @param hourBox  Lista godzin dyspozycyjności.
     */
    override fun setOnDaySelected(dayBox: MFXComboBox&lt;String&gt;, hourBox: MFXCheckListView&lt;String&gt;) {

<span class="fc" id="L775">        dayBox.valueProperty().addListener { _, oldItem, newItem -&gt;</span>
<span class="fc" id="L776">            allHoursCheckBox.isDisable = false</span>
<span class="fc" id="L777">            allHoursCheckBoxEdit.isDisable = false</span>

<span class="fc" id="L779">            allHoursCheckBox.isSelected = false</span>
<span class="fc" id="L780">            allHoursCheckBoxEdit.isSelected = false</span>

            //Dodaje do listy wszystkie godziny które były zaznaczone przed zmianą dnia
<span class="pc bpc" id="L783" title="1 of 4 branches missed.">            if (oldItem!=null &amp;&amp; newItem!=null) {</span>
<span class="pc bpc" id="L784" title="1 of 2 branches missed.">                val englishDay = if(MessageBundle.bundle.locale.equals(Locale(&quot;pl&quot;, &quot;PL&quot;))) EnglishDayConverter.fromPolishName(oldItem) else oldItem</span>
<span class="fc" id="L785">                availabilityList[englishDay]!!.clear()</span>
<span class="fc bfc" id="L786" title="All 2 branches covered.">                for (hour in hourBox.selectionModel.selectedValues) {</span>
<span class="fc" id="L787">                    availabilityList[englishDay]!!.add(hour)</span>
                }
            }
<span class="fc" id="L790">            hourBox.selectionModel.clearSelection()</span>

<span class="pc bpc" id="L792" title="1 of 2 branches missed.">            if (newItem!=null) {</span>
<span class="pc bpc" id="L793" title="1 of 2 branches missed.">                val englishDay = if(MessageBundle.bundle.locale.equals(Locale(&quot;pl&quot;, &quot;PL&quot;) )) EnglishDayConverter.fromPolishName(newItem) else newItem</span>
<span class="pc bpc" id="L794" title="1 of 2 branches missed.">                availabilityList[englishDay]?.forEach { item -&gt; hourBox.selectionModel.selectItem(item) }</span>
            }
<span class="fc" id="L796">        }</span>
<span class="fc" id="L797">    }</span>

    /**
     * Konfiguruje pierwszy krok formularza dodawania lub edycji nauczyciela.
     *
     * @param teacherLabel Etykieta nauczyciela.
     * @param firstName    Pole tekstowe do wprowadzania imienia.
     * @param lastName     Pole tekstowe do wprowadzania nazwiska.
     * @param email        Pole tekstowe do wprowadzania adresu email.
     * @param phone        Pole tekstowe do wprowadzania numeru telefonu.
     */
    override fun setUpFirstStepForm(teacherLabel: Label, firstName: MFXTextField, lastName: MFXTextField, email: MFXTextField, phone: MFXTextField)
    {
<span class="fc" id="L810">        teacherLabel.text = MessageBundle.getMess(&quot;label.fillData&quot;)</span>
<span class="fc" id="L811">        teacherLabel.styleClass.add(&quot;header-label&quot;)</span>
<span class="fc" id="L812">        firstName.floatingText = MessageBundle.getMess(&quot;label.firstname&quot;)</span>
<span class="fc" id="L813">        lastName.floatingText = MessageBundle.getMess(&quot;label.lastname&quot;)</span>
<span class="fc" id="L814">        email.floatingText = MessageBundle.getMess(&quot;label.email&quot;)</span>
<span class="fc" id="L815">        phone.floatingText = MessageBundle.getMess(&quot;label.phone&quot;)</span>
<span class="fc" id="L816">        phone.textLimit = 9</span>
<span class="fc" id="L817">        teacherLabel.text = MessageBundle.getMess(&quot;label.fillData&quot;)</span>
<span class="fc" id="L818">    }</span>

    /**
     * Konfiguruje drugi krok formularza dodawania lub edycji nauczyciela.
     *
     * @param subjects      Lista przedmiotów.
     * @param subjectLabel  Etykieta przedmiotów.
     */
    override fun setUpSecondStepForm(subjects: MFXCheckListView&lt;String&gt;, subjectLabel: Label)
    {
<span class="fc" id="L828">        subjects.items = subjectsModel.getSubjectsNames()</span>
<span class="fc" id="L829">        subjectLabel.text = MessageBundle.getMess(&quot;label.chooseSubjects&quot;)</span>
<span class="fc" id="L830">        subjectLabel.styleClass.add(&quot;header-label&quot;)</span>
<span class="fc" id="L831">        subjects.features().enableBounceEffect()</span>
<span class="fc" id="L832">        subjects.features().enableSmoothScrolling(0.5)</span>
<span class="fc" id="L833">        subjects.prefWidth = 450.0</span>
<span class="fc" id="L834">        subjects.depthLevel = DepthLevel.LEVEL0</span>
<span class="fc" id="L835">    }</span>

    /**
     * Konfiguruje trzeci krok formularza dodawania lub edycji nauczyciela.
     *
     * @param days              Lista dni do wyboru.
     * @param availabilityLabel Etykieta dyspozycyjności nauczyciela.
     * @param hours             Lista godzin do wyboru.
     * @param allHours          Przycisk do wyboru wszystkich godzin.
     */
    override fun setUpThirdStepForm(days: MFXComboBox&lt;String&gt;, availabilityLabel: Label, hours: MFXCheckListView&lt;String&gt;, allHours: MFXToggleButton)
    {
<span class="fc" id="L847">        days.floatingText = MessageBundle.getMess(&quot;label.chooseDay&quot;)</span>
<span class="fc" id="L848">        days.prefWidth = 150.0</span>
<span class="fc" id="L849">        days.prefHeight = 60.0</span>

<span class="fc" id="L851">        availabilityLabel.text = MessageBundle.getMess(&quot;label.addTeacherAvailability&quot;)</span>
<span class="fc" id="L852">        availabilityLabel.styleClass.add(&quot;header-label&quot;)</span>
<span class="fc" id="L853">        availabilityLabel.style = subjectLabelEdit.style</span>

<span class="fc" id="L855">        days.items = FXCollections.observableArrayList(</span>
<span class="fc" id="L856">            MessageBundle.getMess(&quot;label.friday&quot;),</span>
<span class="fc" id="L857">            MessageBundle.getMess(&quot;label.saturday&quot;),</span>
<span class="fc" id="L858">            MessageBundle.getMess(&quot;label.sunday&quot;)</span>
        )
<span class="fc" id="L860">        hours.items = hoursModel.getHours()</span>
<span class="fc" id="L861">        hours.features().enableBounceEffect()</span>
<span class="fc" id="L862">        hours.features().enableSmoothScrolling(0.5)</span>
<span class="fc" id="L863">        hours.depthLevel = DepthLevel.LEVEL0</span>

<span class="fc" id="L865">        allHours.text = MessageBundle.getMess(&quot;label.allHours&quot;)</span>
<span class="fc" id="L866">    }</span>


    /**
     * Konfiguruje formularz dodawania lub edycji nauczyciela.
     *
     * @param teacherLabel      Etykieta nauczyciela.
     * @param firstName         Pole tekstowe do wprowadzania imienia.
     * @param lastName          Pole tekstowe do wprowadzania nazwiska.
     * @param email             Pole tekstowe do wprowadzania adresu email.
     * @param phone             Pole tekstowe do wprowadzania numeru telefonu.
     * @param subjects          Lista przedmiotów nauczyciela.
     * @param subjectLabel      Etykieta przedmiotów.
     * @param availabilityLabel Etykieta dyspozycyjności nauczyciela.
     * @param hours             Lista godzin do wyboru.
     * @param days              Lista dni do wyboru.
     * @param allHours          Przycisk do wyboru wszystkich godzin.
     */
    override fun setupTeacherForm(teacherLabel: Label, firstName: MFXTextField, lastName: MFXTextField, email: MFXTextField, phone: MFXTextField, subjects: MFXCheckListView&lt;String&gt;, subjectLabel: Label, availabilityLabel: Label, hours: MFXCheckListView&lt;String&gt;, days: MFXComboBox&lt;String&gt;, allHours: MFXToggleButton) {

<span class="fc" id="L886">        setUpFirstStepForm(teacherLabel, firstName, lastName, email, phone)</span>
<span class="fc" id="L887">        setUpSecondStepForm(subjects,subjectLabel)</span>
<span class="fc" id="L888">        setUpThirdStepForm(days, availabilityLabel, hours, allHours)</span>
<span class="fc" id="L889">        CommonUtils.setTextFieldStyle(firstName, lastName, email, phone, days)</span>
<span class="fc" id="L890">    }</span>

    /**
     * Ustawia ograniczenia na pola tekstowe walidujące poprawność danych.
     *
     * @param firstName         Pole tekstowe do wprowadzania imienia.
     * @param lastName          Pole tekstowe do wprowadzania nazwiska.
     * @param email             Pole tekstowe do wprowadzania adresu email.
     * @param phone             Pole tekstowe do wprowadzania numeru telefonu.
     */
    override fun setConstraints(firstName: MFXTextField, lastName: MFXTextField, phone: MFXTextField, email: MFXTextField) {
<span class="fc" id="L901">        firstName.validator.constraint(</span>
<span class="fc" id="L902">            ValidatorUtil.createMoreThanOneLetterConstraint(</span>
<span class="fc" id="L903">                firstName.textProperty(),</span>
<span class="fc" id="L904">                MessageBundle.getMess(&quot;firstname.validation.moreThanOneLetter&quot;)</span>
            )
        )
<span class="fc" id="L907">        firstName.validator.constraint(</span>
<span class="fc" id="L908">            ValidatorUtil.createLettersSmallExceptFirstConstraint(</span>
<span class="fc" id="L909">                firstName.textProperty(),</span>
<span class="fc" id="L910">                MessageBundle.getMess(&quot;firstname.validation.allLettersLowercaseExceptFirst&quot;)</span>
            )
        )
<span class="fc" id="L913">        firstName.validator.constraint(</span>
<span class="fc" id="L914">            ValidatorUtil.createFirstLetterBigConstraint(</span>
<span class="fc" id="L915">                firstName.textProperty(),</span>
<span class="fc" id="L916">                MessageBundle.getMess(&quot;firstname.validation.startWithUppercase&quot;)</span>
            )
        )
<span class="fc" id="L919">        firstName.validator.constraint(</span>
<span class="fc" id="L920">            ValidatorUtil.createNoSpecialCharsConstraint(</span>
<span class="fc" id="L921">                firstName.textProperty(),</span>
<span class="fc" id="L922">                MessageBundle.getMess(&quot;firstname.validation.noSpecialChars&quot;)</span>
            )
        )

<span class="fc" id="L926">        lastName.validator.constraint(</span>
<span class="fc" id="L927">            ValidatorUtil.createMoreThanOneLetterConstraint(</span>
<span class="fc" id="L928">                lastName.textProperty(),</span>
<span class="fc" id="L929">                MessageBundle.getMess(&quot;lastname.validation.moreThanOneLetter&quot;)</span>
            )
        )
<span class="fc" id="L932">        lastName.validator.constraint(</span>
<span class="fc" id="L933">            ValidatorUtil.createFirstLetterBigConstraint(</span>
<span class="fc" id="L934">                lastName.textProperty(),</span>
<span class="fc" id="L935">                MessageBundle.getMess(&quot;lastname.validation.startWithUppercase&quot;)</span>
            )
        )
<span class="fc" id="L938">        lastName.validator.constraint(</span>
<span class="fc" id="L939">            ValidatorUtil.createNoSpecialCharsConstraint(</span>
<span class="fc" id="L940">                lastName.textProperty(),</span>
<span class="fc" id="L941">                MessageBundle.getMess(&quot;lastname.validation.noSpecialChars&quot;)</span>
            )
        )

<span class="fc" id="L945">        phone.validator.constraint(</span>
<span class="fc" id="L946">            ValidatorUtil.createOnlyDigitsAllowedConstraint(</span>
<span class="fc" id="L947">                phone.textProperty(),</span>
<span class="fc" id="L948">                MessageBundle.getMess(&quot;phone.validation.onlyNumbers&quot;)</span>
            )
        )
<span class="fc" id="L951">        phone.validator.constraint(</span>
<span class="fc" id="L952">            ValidatorUtil.createExactlyNineDigitsConstraint(</span>
<span class="fc" id="L953">                phone.textProperty(),</span>
<span class="fc" id="L954">                MessageBundle.getMess(&quot;phone.validation.nineDigits&quot;)</span>
            )
        )

<span class="fc" id="L958">        email.validator.constraint(</span>
<span class="fc" id="L959">            ValidatorUtil.createIncorrectEmailConstraint(</span>
<span class="fc" id="L960">                email.textProperty(),</span>
<span class="fc" id="L961">                MessageBundle.getMess(&quot;email.validation.incorrectEmail&quot;)</span>
            )
        )
<span class="fc" id="L964">        email.validator.constraint(</span>
<span class="fc" id="L965">            ValidatorUtil.createNotEmptyConstraint(</span>
<span class="fc" id="L966">                email.textProperty(),</span>
<span class="fc" id="L967">                MessageBundle.getMess(&quot;email.validation.notEmpty&quot;)</span>
            )
        )

<span class="fc" id="L971">    }</span>

    /**
     * Metoda wywoływana podczas zmiany zakładek przez użytkownika - czyści panel.
     */
    override fun onTabsChanged() {
<span class="fc" id="L977">        CommonUtils.removeStepDependencies(stepper, firstNameTextField, lastNameTextField, phoneTextField, emailTextField)</span>
<span class="fc" id="L978">        createSteps(firstNameTextField, lastNameTextField, phoneTextField, emailTextField, subjectCheckList, dayChoiceBox, hourCheckList, stepper, teacherLabel, subjectLabel, availabilityLabel, allHoursCheckBox)</span>
<span class="fc" id="L979">        clearBoxes()</span>
<span class="fc" id="L980">        teacherTableView.update()</span>
<span class="fc" id="L981">        teacherTableView.selectionModel.clearSelection()</span>
<span class="fc" id="L982">        teacherTableView.items.clear()</span>
<span class="fc" id="L983">    }</span>

    /**
     * Czyści pola tekstowe formularza.
     */
    override fun clearBoxes() {
<span class="fc" id="L989">        firstNameTextField.clear()</span>
<span class="fc" id="L990">        lastNameTextField.clear()</span>
<span class="fc" id="L991">        phoneTextField.clear()</span>
<span class="fc" id="L992">        emailTextField.clear()</span>
<span class="fc" id="L993">        subjectCheckList.selectionModel.clearSelection()</span>
<span class="fc" id="L994">        hourCheckList.selectionModel.clearSelection()</span>
<span class="fc" id="L995">        CommonUtils.clearBox(dayChoiceBox)</span>
<span class="fc" id="L996">    }</span>

    /**
     * Obsługuje akcje wywoływane po drugim kroku podczas dodawania lub edycji nauczyciela.
     *
     * @param stepper  Stepper dodawania lub edycji nauczyciela.
     * @param subjects Lista przedmiotów nauczyciela.
     */
    override fun handleActionsAfterSecondStep(stepper: MFXStepper, subjects: MFXCheckListView&lt;String&gt;)
    {
<span class="nc bnc" id="L1006" title="All 2 branches missed.">        if (stepper.currentStepperNode == stepper.stepperToggles[2])</span>
        {
            //Cofnij jeśli nie wybrano przedmiotów dla nauczyciela
<span class="nc bnc" id="L1009" title="All 2 branches missed.">            if (subjects.selectionModel.selectedValues.isEmpty())</span>
            {
<span class="nc" id="L1011">                stepper.previous()</span>
<span class="nc" id="L1012">                MessageUtil.showWarningMessage(MessageBundle.getMess(&quot;warning.teacherAddingError&quot;), MessageBundle.getMess(&quot;warning.shouldChooseSubjects&quot;))</span>
            }

<span class="nc bnc" id="L1015" title="All 4 branches missed.">            else if (stepper == stepperEdit &amp;&amp; !messageShownSubjects)</span>
            {
<span class="nc" id="L1017">                checkIfOldSubjectWasDeleted(subjects)</span>
            }
        }
<span class="nc" id="L1020">    }</span>

    /**
     * Sprawdza, które przedmioty z listy przedmiotów nauczyciela nie zostały wybrane na nowej liście
     * przedmiotów nauczyciela (trzeba będzie usunąć zajęcia z nimi związane) oraz informauje o tym użytkownika
     * @param subjects Nowa lista przedmiotów wybrana przez użytkownika
     */
    fun checkIfOldSubjectWasDeleted(subjects: MFXCheckListView&lt;String&gt;)
    {
<span class="fc" id="L1029">        val newSubjects = subjects.selectionModel.selectedValues</span>
<span class="fc" id="L1030">        val oldSubjects = teachersModel.getTeacherSubjects(lastSelectedTeacher)</span>
<span class="fc" id="L1031">        val deletedSubjects = oldSubjects-newSubjects.toSet()</span>
<span class="pc bpc" id="L1032" title="2 of 4 branches missed.">        if (deletedSubjects.isNotEmpty())</span>
        {
<span class="fc" id="L1034">            showDialogYesNoMessage(&quot;${MessageBundle.getMess(&quot;warning.askBeforeDeleteSubject&quot;)} $deletedSubjects&quot;, ActionType.EDIT)</span>
<span class="pc bpc" id="L1035" title="1 of 2 branches missed.">            if (!wantToEdit)</span>
            {
<span class="fc" id="L1037">                stepperEdit.previous()</span>
<span class="fc" id="L1038">                subjectCheckListEdit.selectionModel.clearSelection()</span>

<span class="fc bfc" id="L1040" title="All 2 branches covered.">                for (item in oldSubjects)</span>
                {
<span class="fc" id="L1042">                    subjectCheckListEdit.selectionModel.selectItem(item)</span>
                }
            }
<span class="nc" id="L1045">            else messageShownSubjects = true</span>
        }
<span class="fc" id="L1047">    }</span>

    /**
     * Sprawdza czy w bazie danych nie ma już podobnych lub takich samych danych podczas dodawania nauczyciela.
     *
     * @param teacher Dodawany nauczyciel.
     */
    override fun checkDBWhileAdding(teacher: Teacher)
    {
<span class="fc" id="L1056">        try {</span>
<span class="nc" id="L1057">            teachersModel.checkDBwhileAdding(teacher)</span>
<span class="fc" id="L1058">        }catch (e:DuplicatesException)</span>
        {
<span class="fc" id="L1060">            stepper.previous()</span>
<span class="fc" id="L1061">            MessageUtil.showWarningMessage(MessageBundle.getMess(&quot;warning.teacherAddingError&quot;), e.message!!)</span>
        }
<span class="fc" id="L1063">    }</span>

    /**
     * Sprawdza czy w bazie danych nie ma już podobnych lub takich samych danych podczas edycji nauczyciela.
     *
     * @param teacher Edytowany auczyciel.
     */
    override fun checkDBWhileEditing(teacher: Teacher)
    {
<span class="fc" id="L1072">        try {</span>
<span class="nc" id="L1073">            teachersModel.checkDBwhileEditing(teacher, lastSelectedTeacher, messageShown)</span>
<span class="fc" id="L1074">        }catch (e:DuplicatesException)</span>
        {
<span class="fc" id="L1076">            stepperEdit.previous()</span>
<span class="fc" id="L1077">            MessageUtil.showWarningMessage(MessageBundle.getMess(&quot;warning.teacherEditingError&quot;), e.message!!)</span>
        }
<span class="nc" id="L1079">        catch (e:IdenticalObjectExistsException)</span>
        {
<span class="nc" id="L1081">            showDialogYesNoMessage(e.message!!, ActionType.EDIT)</span>
<span class="nc bnc" id="L1082" title="All 2 branches missed.">            if (!wantToEdit) stepperEdit.previous()</span>
<span class="nc" id="L1083">            else messageShown = true</span>
        }
<span class="fc" id="L1085">    }</span>


    /**
     * Obsługuje akcje wywoływane po pierwszym kroku podczas dodawania lub edycji nauczyciela.
     *
     * @param stepper           Stepper dodawania lub edycji nauczyciela.
     * @param firstname         Pole tekstowe do wprowadzania imienia.
     * @param lastname          Pole tekstowe do wprowadzania nazwiska.
     * @param email             Pole tekstowe do wprowadzania adresu email.
     * @param phone             Pole tekstowe do wprowadzania numeru telefonu.
     */
    override fun handleActionsAfterFirstStep(stepper: MFXStepper, firstname: MFXTextField, lastname: MFXTextField, phone: MFXTextField, email: MFXTextField)
    {
<span class="nc bnc" id="L1099" title="All 2 branches missed.">        if (stepper.currentStepperNode == stepper.stepperToggles[1])</span>
        {
<span class="nc" id="L1101">            val teacher = Teacher(</span>
<span class="nc" id="L1102">                firstname = firstname.text,</span>
<span class="nc" id="L1103">                lastname = lastname.text,</span>
<span class="nc" id="L1104">                email = email.text,</span>
<span class="nc" id="L1105">                phone = phone.text</span>
            )

<span class="nc bnc" id="L1108" title="All 2 branches missed.">            if (!inEditMode) checkDBWhileAdding(teacher)</span>
<span class="nc" id="L1109">            else checkDBWhileEditing(teacher)</span>
        }
<span class="nc" id="L1111">    }</span>


    /**
     * Wykonuje akcje między krokami formularza.
     *
     * @param subjects          Lista przedmiotów.
     * @param firstname         Pole tekstowe do wprowadzania imienia.
     * @param lastname          Pole tekstowe do wprowadzania nazwiska.
     * @param email             Pole tekstowe do wprowadzania adresu email.
     * @param phone             Pole tekstowe do wprowadzania numeru telefonu.
     * @param stepper           Stepper dodawania lub edycji nauczyciela.
     */
    override fun performActionsBetweenSteps(subjects: MFXCheckListView&lt;String&gt;, firstname: MFXTextField, lastname: MFXTextField, phone: MFXTextField, email: MFXTextField, stepper: MFXStepper)
    {
<span class="fc" id="L1126">        stepper.addEventHandler(MFXStepper.MFXStepperEvent.NEXT_EVENT) {</span>
<span class="nc" id="L1127">            handleActionsAfterFirstStep(stepper, firstname, lastname, phone, email)</span>
<span class="nc" id="L1128">            handleActionsAfterSecondStep(stepper, subjects)</span>
<span class="nc" id="L1129">        }</span>

<span class="fc" id="L1131">        stepperEdit.addEventHandler(MFXStepper.MFXStepperEvent.BEFORE_PREVIOUS_EVENT) {</span>
<span class="pc bpc" id="L1132" title="1 of 2 branches missed.">            if (stepperEdit.currentStepperNode == stepperEdit.stepperToggles[2])</span>
            {
<span class="nc" id="L1134">                messageShownSubjects = false</span>
            }
<span class="fc" id="L1136">        }</span>
<span class="fc" id="L1137">    }</span>

    /**
     * Tworzy i wyświetla menu kontekstowe dla wybranego nauczyciela z tabeli.
     *
     * @param selectedRowIndex Indeks zaznaczonego wiersza w tabeli.
     * @param selectedItem       Wybrany nauczyciel.
     */
    override fun showContextMenu(selectedRowIndex: Int, selectedItem: Teacher) {

<span class="fc" id="L1147">        val deleteButton = MFXContextMenuItem(MessageBundle.getMess(&quot;label.delete&quot;))</span>
<span class="fc" id="L1148">        val editButton = MFXContextMenuItem(MessageBundle.getMess(&quot;label.editTeacher&quot;))</span>
<span class="fc" id="L1149">        val showSubjectsButton = MFXContextMenuItem(MessageBundle.getMess(&quot;label.showSubjects&quot;))</span>
<span class="fc" id="L1150">        val showAvailabilityButton = MFXContextMenuItem(MessageBundle.getMess(&quot;label.showAvailability&quot;))</span>

<span class="fc" id="L1152">        deleteButton.graphic =  MFXFontIcon(&quot;fas-trash-can&quot;, 16.0, Color.BLACK)</span>
<span class="fc" id="L1153">        editButton.graphic = MFXFontIcon(&quot;fas-wrench&quot;, 16.0, Color.BLACK)</span>
<span class="fc" id="L1154">        showAvailabilityButton.graphic = MFXFontIcon(&quot;fas-clock&quot;, 16.0, Color.BLACK)</span>
<span class="fc" id="L1155">        showSubjectsButton.graphic = MFXFontIcon(&quot;fas-file-pen&quot;, 16.0, Color.BLACK)</span>

<span class="fc" id="L1157">        deleteButton.setOnAction {</span>
<span class="nc" id="L1158">            showDialogYesNoMessage(MessageBundle.getMess(&quot;question.teacher.askBeforeDelete&quot;), ActionType.DELETE)</span>
<span class="nc" id="L1159">            deleteTeacher(selectedItem)</span>
<span class="nc" id="L1160">        }</span>

<span class="fc" id="L1162">        editButton.setOnAction {</span>
<span class="nc" id="L1163">            inEditMode = true</span>
<span class="nc" id="L1164">            editTeacher(selectedItem)</span>
<span class="nc" id="L1165">        }</span>

<span class="fc" id="L1167">        showAvailabilityButton.setOnAction {</span>
<span class="nc" id="L1168">            showAvailability(selectedItem)</span>
<span class="nc" id="L1169">        }</span>

<span class="fc" id="L1171">        showSubjectsButton.setOnAction {</span>
<span class="nc" id="L1172">            showSubjects(selectedItem)</span>
<span class="nc" id="L1173">        }</span>

<span class="fc" id="L1175">        CommonUtils.showContextMenu(selectedRowIndex, teacherTableView, menu, listOf(deleteButton, editButton, showAvailabilityButton, showSubjectsButton))</span>

<span class="fc" id="L1177">    }</span>


    /**
     * Wyświetla listę przedmiotów nauczyciela.
     *
     * @param teacher Wybrany nauczyciel.
     */
    override fun showSubjects(teacher: Teacher) {
<span class="fc" id="L1186">        val subjects = teachersModel.getTeacherSubjects(teacher)</span>

<span class="pc bpc" id="L1188" title="1 of 2 branches missed.">        val labeltext = if (subjects.isEmpty())</span>
        {
<span class="nc" id="L1190">            MessageBundle.getMess(&quot;label.noSubjects&quot;)</span>
        }
        else{
<span class="fc" id="L1193">            MessageBundle.getMess(&quot;label.subjects&quot;)</span>
        }

<span class="fc" id="L1196">        val vbox = DialogUtils.createListView(labeltext, subjects)</span>
<span class="fc" id="L1197">        vbox.maxWidth = Double.MAX_VALUE</span>

<span class="fc" id="L1199">        createAndShowDialog(vbox)</span>
<span class="fc" id="L1200">    }</span>

    /**
     * Wyświetla dyspozycyjność wybranego nauczyciela.
     *
     * @param teacher Wybrany nauczyciel.
     */
    override fun showAvailability(teacher: Teacher) {

<span class="fc" id="L1209">        val availabilityList = teachersModel.getAvailability(teacher)</span>
<span class="pc bpc" id="L1210" title="1 of 2 branches missed.">        val labelText = if (availabilityList.isEmpty()) {</span>
<span class="nc" id="L1211">            MessageBundle.getMess(&quot;label.noAvailability&quot;)</span>
        } else {
<span class="fc" id="L1213">            MessageBundle.getMess(&quot;label.availability&quot;)</span>
        }

<span class="fc" id="L1216">        val vbox = DialogUtils.createListView(labelText, availabilityList, 300.0)</span>
<span class="fc" id="L1217">        createAndShowDialog(vbox)</span>
<span class="fc" id="L1218">    }</span>


    /**
     * Wyświetla formularz pozwalający na edycję nauczyciela.
     *
     * @param teacherToEdit Wybrany nauczyciel.
     */
    override fun editTeacher(teacherToEdit: Teacher) {
<span class="fc" id="L1227">        val vbox = VBox()</span>
<span class="fc" id="L1228">        vbox.children.addAll(stepperEdit)</span>
<span class="fc" id="L1229">        stepperEdit.styleClass.add(&quot;stepper&quot;)</span>

<span class="fc" id="L1231">        firstNameTextFieldEdit.text = teacherToEdit.firstname</span>
<span class="fc" id="L1232">        lastNameTextFieldEdit.text = teacherToEdit.lastname</span>
<span class="fc" id="L1233">        phoneTextFieldEdit.text = teacherToEdit.phone</span>
<span class="fc" id="L1234">        emailTextFieldEdit.text = teacherToEdit.email</span>

<span class="fc" id="L1236">        subjectCheckListEdit.selectionModel.clearSelection()</span>
<span class="fc" id="L1237">        val subjectList = teachersModel.getTeacherSubjects(teacherToEdit)</span>

<span class="fc bfc" id="L1239" title="All 2 branches covered.">        for (item in subjectList)</span>
        {
<span class="fc" id="L1241">            subjectCheckListEdit.selectionModel.selectItem(item)</span>
        }

        //Jeśli nie wybrano żadnej dyspozycyjności
<span class="fc bfc" id="L1245" title="All 2 branches covered.">        for (day in listOf(&quot;Friday&quot;, &quot;Saturday&quot;, &quot;Sunday&quot;)) {</span>
<span class="fc" id="L1246">            availabilityList[day] = teachersModel.getAvailabilityByDay(lastSelectedTeacher, day.uppercase(Locale.getDefault())).toMutableList()</span>
        }

<span class="fc" id="L1249">        createAndShowDialog(vbox)</span>
<span class="fc" id="L1250">    }</span>

    /**
     * Wyświetla okno dialogowe z przyciskami &quot;Tak&quot; lub &quot;Nie&quot;.
     *
     * @param content Wiadomość do wyświetlenia.
     */
    override fun showDialogYesNoMessage(content: String, type: ActionType) {

<span class="fc" id="L1259">        val buttons = listOf(</span>
<span class="fc" id="L1260">            MessageBundle.getMess(&quot;label.yes&quot;) to {</span>
<span class="nc bnc" id="L1261" title="All 3 branches missed.">                when (type) {</span>
<span class="nc" id="L1262">                    ActionType.EDIT -&gt; wantToEdit = true</span>
<span class="nc" id="L1263">                    ActionType.DELETE -&gt; wantToDelete = true</span>
                }
<span class="nc" id="L1265">            },</span>
<span class="fc" id="L1266">            MessageBundle.getMess(&quot;label.no&quot;) to {</span>
<span class="nc bnc" id="L1267" title="All 3 branches missed.">                when (type) {</span>
<span class="nc" id="L1268">                    ActionType.EDIT -&gt; wantToEdit = false</span>
<span class="nc" id="L1269">                    ActionType.DELETE -&gt; wantToDelete = false</span>
                }
<span class="nc" id="L1271">            }</span>
        )

<span class="pc bpc" id="L1274" title="1 of 2 branches missed.">        dialogMess = DialogUtils.showMessageDialogWithButtons(content, showTeachersButton.scene.window as Stage, buttons)</span>
<span class="pc bpc" id="L1275" title="1 of 2 branches missed.">        if (dialogMess.owner.isShowing) dialogMess.showAndWait()</span>
<span class="fc" id="L1276">    }</span>

    /**
     * Tworzy layout dodawania nauczycieli z pliku
     */
    fun createAddTeacherFromFileVBox(): VBox {
<span class="fc" id="L1282">        val uploadButton = MFXButton()</span>
<span class="fc" id="L1283">        val uploadTeachersLabel = Label()</span>
<span class="fc" id="L1284">        val uploadTeachersToggle = MFXRectangleToggleNode()</span>
<span class="fc" id="L1285">        uploadTeachersLabel.styleClass.add(&quot;header-label_white&quot;)</span>
<span class="fc" id="L1286">        uploadTeachersToggle.labelTrailingIcon = MFXFontIcon(&quot;fas-list-ul&quot;, 16.0, Color.BLACK)</span>
<span class="fc" id="L1287">        uploadTeachersToggle.text = MessageBundle.getMess(&quot;label.chooseFile&quot;)</span>
<span class="fc" id="L1288">        uploadButton.text = MessageBundle.getMess(&quot;label.upload&quot;)</span>
<span class="fc" id="L1289">        uploadTeachersLabel.text = MessageBundle.getMess(&quot;label.loadFileWithTeachers&quot;)</span>
<span class="fc" id="L1290">        uploadTeachersToggle.id = &quot;comboWhite&quot;</span>
<span class="fc" id="L1291">        uploadButton.id = &quot;customButton&quot;</span>
<span class="fc" id="L1292">        MFXTooltip.of(uploadTeachersToggle, MessageBundle.getMess(&quot;label.patternInfo&quot;)).install()</span>
<span class="fc" id="L1293">        uploadTeachersLabel.prefWidth = 700.0</span>
<span class="fc" id="L1294">        uploadTeachersLabel.alignment = Pos.CENTER</span>
<span class="fc" id="L1295">        uploadTeachersToggle.prefWidth = 380.0</span>
<span class="pc bnc" id="L1296" title="All 2 branches missed.">        uploadTeachersToggle.setOnAction { ExcelUtils.searchFile(uploadTeachersToggle, showTeachersButton.scene.window as Stage) }</span>
<span class="pc" id="L1297">        uploadButton.setOnAction { uploadFileTeachers(uploadTeachersToggle.text) }</span>

<span class="fc" id="L1299">        val vbox = VBox(30.0, uploadTeachersLabel, uploadTeachersToggle, uploadButton)</span>
<span class="fc" id="L1300">        vbox.alignment = Pos.CENTER</span>

<span class="fc" id="L1302">        return vbox</span>
    }

    /**
     * Tworzy i wyświetla customowe okno dialogowe.
     *
     * @param vBox Kontener z zawartością okna dialogowego.
     */
    override fun createAndShowDialog(vBox: VBox) {
<span class="fc" id="L1311">        vBox.alignment = Pos.CENTER</span>

<span class="fc" id="L1313">        val shouldBeBigger = vBox.children.contains(stepperEdit)</span>
<span class="pc bpc" id="L1314" title="1 of 2 branches missed.">        dialog = DialogUtils.showCustomDialog(showTeachersButton.scene.window as Stage, vBox, shouldBeBigger) {</span>
<span class="nc" id="L1315">            setOnDialogClosing()</span>
<span class="nc" id="L1316">        }</span>

<span class="pc bpc" id="L1318" title="1 of 2 branches missed.">        if (dialog.owner.isShowing) dialog.showAndWait()</span>
<span class="fc" id="L1319">    }</span>

    /**
     * Obsługuje zdarzenie zamknięcia okna dialogowego.
     */
    override fun setOnDialogClosing()
    {
<span class="nc" id="L1326">        teacherTableView.selectionModel.clearSelection()</span>
<span class="nc" id="L1327">        menu.hide()</span>
<span class="nc" id="L1328">        messageShown=false</span>
<span class="nc" id="L1329">        messageShownSubjects=false</span>
<span class="nc" id="L1330">        inEditMode=false</span>
<span class="nc" id="L1331">        CommonUtils.removeStepDependencies(stepperEdit, firstNameTextFieldEdit, lastNameTextFieldEdit, phoneTextFieldEdit, emailTextFieldEdit)</span>
<span class="nc" id="L1332">        createSteps(firstNameTextFieldEdit, lastNameTextFieldEdit, phoneTextFieldEdit, emailTextFieldEdit, subjectCheckListEdit, dayChoiceBoxEdit, hourCheckListEdit, stepperEdit, teacherLabelEdit, subjectLabelEdit, availabilityLabelEdit, allHoursCheckBoxEdit)</span>
<span class="nc" id="L1333">    }</span>


    /**
     * Tworzy i konfiguruje tabelę z nauczycielami.
     */
    override fun setupTable() {
<span class="fc" id="L1340">        val columns = mapOf&lt;MFXTableColumn&lt;Teacher&gt;, KProperty1&lt;Teacher, *&gt;&gt;(</span>
<span class="pc" id="L1341">            MFXTableColumn(MessageBundle.getMess(&quot;label.firstname&quot;), false, Comparator.comparing(Teacher::firstname)) to Teacher::firstname,</span>
<span class="pc" id="L1342">            MFXTableColumn(MessageBundle.getMess(&quot;label.lastname&quot;), false, Comparator.comparing(Teacher::lastname)) to Teacher::lastname,</span>
<span class="pc" id="L1343">            MFXTableColumn(MessageBundle.getMess(&quot;label.email&quot;), false, Comparator.comparing(Teacher::email)) to Teacher::email,</span>
<span class="pc" id="L1344">            MFXTableColumn(MessageBundle.getMess(&quot;label.phone&quot;), false, Comparator.comparing(Teacher::phone)) to Teacher::phone</span>
        )
        
<span class="fc" id="L1347">        columns.forEach{ column -&gt;</span>
<span class="fc" id="L1348">            column.key.rowCellFactory = Function&lt;Teacher, MFXTableRowCell&lt;Teacher?, *&gt;&gt;</span>
            {
<span class="nc" id="L1350">                val cell = MFXTableRowCell&lt;Teacher?, Any?&gt;(column.value)</span>
<span class="nc" id="L1351">                cell.styleClass.add(&quot;table-cell&quot;)</span>
<span class="nc" id="L1352">                cell</span>
            }
<span class="fc" id="L1354">        }</span>

        //Ustawia filtry
<span class="fc" id="L1357">        teacherTableView.filters.addAll(</span>
<span class="pc" id="L1358">            StringFilter(MessageBundle.getMess(&quot;label.firstname&quot;), Teacher::firstname),</span>
<span class="pc" id="L1359">            StringFilter(MessageBundle.getMess(&quot;label.lastname&quot;), Teacher::lastname),</span>
<span class="pc" id="L1360">            StringFilter(MessageBundle.getMess(&quot;label.email&quot;), Teacher::email),</span>
<span class="pc" id="L1361">            StringFilter(MessageBundle.getMess(&quot;label.phone&quot;), Teacher::phone)</span>
        )

<span class="fc" id="L1364">        teacherTableView.tableColumns.addAll(columns.keys)</span>

<span class="fc bfc" id="L1366" title="All 2 branches covered.">        for (i in 0 until teacherTableView.tableColumns.size) {</span>
<span class="fc" id="L1367">            teacherTableView.tableColumns[i].styleClass.add(&quot;table-header&quot;)</span>
        }

<span class="fc" id="L1370">        teacherTableView.tableColumns[2].minWidth = 150.0</span>
<span class="fc" id="L1371">        teacherTableView.tableColumns[1].minWidth = 150.0</span>
<span class="fc" id="L1372">        teacherTableView.isFooterVisible = true</span>
<span class="fc" id="L1373">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>