<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FieldDAOImpl.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Scheduler</a> &gt; <a href="index.source.html" class="el_package">com.example.scheduler.db.dao</a> &gt; <span class="el_source">FieldDAOImpl.kt</span></div><h1>FieldDAOImpl.kt</h1><pre class="source lang-java linenums">package com.example.scheduler.db.dao

import com.example.scheduler.db.DBQueryExecutor
import com.example.scheduler.objects.Field
import com.example.scheduler.objects.Group
import com.example.scheduler.objects.Subject
import com.example.scheduler.objects.TeachingPlan
import javafx.collections.FXCollections
import javafx.collections.ObservableList
import java.sql.SQLException

/**
 * Implementacja interfejsu `FieldDAO` do obsługi operacji w bazie danych dla kierunków
 */
<span class="fc" id="L15">class FieldDAOImpl:FieldDAO {</span>

    /**
     * Dodaje przedmiot z podaną liczbą godzin do semestru dla podanego kierunku i semestru.
     *
     * @param subject     Nazwa przedmiotu.
     * @param field       Nazwa kierunku kształcenia.
     * @param sem         Numer semestru.
     * @param weeklyHours Liczba godzin w tygodniu.
     */
    @Throws(SQLException::class)
    override fun addSubjectToSem(subject: String, field:String, sem:Int, weeklyHours: Int)
    {
<span class="fc" id="L28">        val query = &quot;{ CALL addSubjectToSemester(?,?,?,?) }&quot;</span>
<span class="fc" id="L29">        DBQueryExecutor.executePreparedStatement(query, subject, field, sem, weeklyHours)</span>
<span class="fc" id="L30">    }</span>


    /**
     * Sprawdza, czy nazwa kierunku kształcenia, istnieje w bazie danych.
     *
     * @param fieldName         Nazwa kierunku do sprawdzenia
     * @return                  `true`, jeśli nazwa kierunku istnieje; `false` w przeciwnym razie.
     */
    override fun checkIfFieldNameInDb(fieldName: String): Boolean {
<span class="fc" id="L40">        val query = &quot;SELECT COUNT(*) FROM fields &quot; +</span>
                &quot;WHERE fieldName = ? &quot;

<span class="fc" id="L43">        return DBQueryExecutor.executeQuery(query,</span>
<span class="fc" id="L44">            fieldName</span>
        )
<span class="fc" id="L46">        {resultSet -&gt; resultSet.getBoolean(1)}.first()</span>
    }

    /**
     * Sprawdza, czy skrót kierunku kształcenia, który nie jest skrótem podanego kierunku, istnieje w bazie danych.
     *
     * @param fieldShort         Skrót kierunku do sprawdzenia
     * @param selectedField      Kierunek kształcenia do pominięcia
     * @return                  `true`, jeśli skrót kierunku istnieje; `false` w przeciwnym razie.
     */
    override fun checkIfFieldShortInDbEdit(fieldShort: String, selectedField: Field): Boolean {
<span class="fc" id="L57">        val query = &quot;SELECT COUNT(*) FROM fields &quot; +</span>
                &quot;WHERE fieldShort = ? AND fields.fieldID != (SELECT fieldID FROM fields WHERE fieldName = ? AND fieldShort = ? )&quot;

<span class="fc" id="L60">        return DBQueryExecutor.executeQuery(query,</span>
<span class="fc" id="L61">            fieldShort, selectedField.fieldName, selectedField.shortcut</span>
        )
<span class="fc" id="L63">        {resultSet -&gt; resultSet.getBoolean(1)}.first()</span>
    }

    /**
     * Sprawdza, czy nazwa kierunku kształcenia, która nie jest nazwą podanego kierunku, istnieje w bazie danych.
     *
     * @param fieldName          Nazwa kierunku do sprawdzenia
     * @param selectedField      Kierunek kształcenia do pominięcia
     * @return                  `true`, jeśli nazwa kierunku istnieje; `false` w przeciwnym razie.
     */
    override fun checkIfFieldNameInDbEdit(fieldName: String, selectedField: Field): Boolean {
<span class="fc" id="L74">        val query = &quot;SELECT COUNT(*) FROM fields &quot; +</span>
                &quot;WHERE fieldName = ? AND fields.fieldID != (SELECT fieldID FROM fields WHERE fieldName = ? AND fieldShort = ? )&quot;

<span class="fc" id="L77">        return DBQueryExecutor.executeQuery(query,</span>
<span class="fc" id="L78">            fieldName, selectedField.fieldName, selectedField.shortcut</span>
        )
<span class="fc" id="L80">        {resultSet -&gt; resultSet.getBoolean(1)}.first()</span>
    }

    /**
     * Sprawdza, czy skrót nazwy kierunku kształcenia, istnieje w bazie danych.
     *
     * @param shortcut           Skrót nazwy kierunku do sprawdzenia
     * @return                  `true`, jeśli skrót istnieje; `false` w przeciwnym razie.
     */
    override fun checkIfFieldShortcutInDb(shortcut: String): Boolean {
<span class="fc" id="L90">        val query = &quot;SELECT COUNT(*) FROM fields &quot; +</span>
                &quot;WHERE fieldShort = ? &quot;

<span class="fc" id="L93">        return DBQueryExecutor.executeQuery(query,</span>
<span class="fc" id="L94">            shortcut</span>
        )
<span class="fc" id="L96">        {resultSet -&gt; resultSet.getBoolean(1)}.first()</span>
    }

    /**
     * Sprawdza, czy kierunek, istnieje w bazie danych.
     *
     * @param fieldName         Nazwa kierunku
     * @param shortcut          Skrót nazwy kierunku
     * @return                  `true`, jeśli skrót istnieje; `false` w przeciwnym razie.
     */
    override fun checkIfFieldInDb(fieldName: String, shortcut: String): Boolean {
<span class="fc" id="L107">        val query = &quot;SELECT COUNT(*) FROM fields &quot; +</span>
                &quot;WHERE fieldName = ? AND fieldShort = ?&quot;

<span class="fc" id="L110">        return DBQueryExecutor.executeQuery(query,</span>
<span class="fc" id="L111">            fieldName, shortcut</span>
        )
<span class="fc" id="L113">        {resultSet -&gt; resultSet.getBoolean(1)}.first()</span>
    }

    /**
     * Sprawdza, czy kierunek kształcenia, który nie jest kierunkiem z danymi 'Old', istnieje w bazie danych.
     *
     * @param fieldName         Nazwa kierunku do sprawdzenia
     * @param shortcut          Skrót do sprawdzenia
     * @param fieldNameOld      Nazwa kierunku do pominięcia
     * @param shortcutOld       Skrót do pominięcia
     * @return                  `true`, jeśli kierunek istnieje; `false` w przeciwnym razie.
     */
    override fun checkIfFieldInDbEdit(
        fieldName: String,
        shortcut: String,
        fieldNameOld: String,
        shortcutOld: String
    ): Boolean {
<span class="nc" id="L131">        val query = &quot;SELECT COUNT(*) FROM fields &quot; +</span>
                &quot;WHERE fieldName = ? AND fieldShort = ? &quot; +
                &quot;AND fields.fieldID != (SELECT fieldID FROM fields WHERE fieldName = ? AND fieldShort = ? )&quot;

<span class="nc" id="L135">        return DBQueryExecutor.executeQuery(query,</span>
<span class="nc" id="L136">            fieldName, shortcut, fieldNameOld, shortcutOld</span>
        )
<span class="nc" id="L138">        {resultSet -&gt; resultSet.getBoolean(1)}.first()</span>
    }


    /**
     * Metoda dodająca kierunek do bazy danych przy użyciu procedury z bazy danych.
     *
     * @param field     Kierunek do dodania do bazy danych
     */
    @Throws(SQLException::class)
    override fun addField(field: Field) {
<span class="fc" id="L149">        val query = &quot;{ CALL addField(?,?,?) }&quot;</span>
<span class="fc" id="L150">        DBQueryExecutor.executePreparedStatement(</span>
<span class="fc" id="L151">            query,</span>
<span class="fc" id="L152">            field.fieldName,</span>
<span class="fc" id="L153">            field.shortcut,</span>
<span class="fc" id="L154">            field.semsNumber</span>
        )
<span class="fc" id="L156">    }</span>

    /**
     * Metoda dodająca grupę do bazy danych przy użyciu procedury z bazy danych.
     *
     * @param fieldName Nazwa kierunku, do którego ma zostać przypisana grupa
     * @param sem Numer semestru, do którego ma zostać przypisana grupa
     * @param romanNumber Liczba rzymska odpowiadająca numerowi semestru
     */
    @Throws(SQLException::class)
    override fun addGroup(fieldName: String, sem: Int, romanNumber: String) {

<span class="fc" id="L168">        val query = &quot;{ CALL addGroup(?,?,?) }&quot;</span>
<span class="fc" id="L169">        DBQueryExecutor.executePreparedStatement(query, fieldName, sem, romanNumber)</span>
<span class="fc" id="L170">    }</span>


    /**
     * Metoda pobierająca id podanego kierunku.
     *
     * @param lastSelectedField Obiekt Field, którego id chcemy uzyskać
     * @return Id kierunku
     */
    override fun getFieldID(lastSelectedField: Field): Int {
<span class="fc" id="L180">        val query = &quot;SELECT fieldID FROM fields AS f &quot; +</span>
                &quot;WHERE f.fieldName = ? AND f.fieldShort = ? AND f.semNumber = ? &quot;

<span class="fc" id="L183">        return DBQueryExecutor.executeQuery(query,</span>
<span class="fc" id="L184">            lastSelectedField.fieldName,</span>
<span class="fc" id="L185">            lastSelectedField.shortcut,</span>
<span class="fc" id="L186">            lastSelectedField.semsNumber</span>
        )
<span class="fc" id="L188">        {resultSet -&gt; resultSet.getInt(1)}.first()</span>
    }


    /**
     * Metoda pobierająca listę przedmiotów dla danego kierunku i semestru.
     *
     * @param field     Nazwa kierunku
     * @param semester Numer semestru
     * @return          Lista przedmiotów
     */
    override fun getSubjectsByFieldAndSem(field: String, semester: String): ObservableList&lt;Subject&gt; {
<span class="nc" id="L200">        val query = &quot;SELECT subjectName FROM subjects INNER JOIN field_subject fs on subjects.subjectID = fs.subjectID &quot; +</span>
                &quot;INNER JOIN fields f on fs.fieldID = f.fieldID WHERE fieldName = ? AND term = ? ORDER BY subjectName&quot;

<span class="nc" id="L203">        return DBQueryExecutor.executeQuery(query, field, semester){</span>
                resultSet -&gt;
<span class="nc" id="L205">            Subject(subjectName = resultSet.getString(1))</span>
        }

    }


    /**
     * Metoda pobierająca listę grup dla danego kierunku kształcenia i semestru.
     *
     * @param fieldName Nazwa kierunku
     * @param sem       Numer semestru
     * @return          Lista grup
     */
    override fun getGroups(fieldName: String, sem: Int): ObservableList&lt;String&gt; {
<span class="fc" id="L219">        val query = &quot;SELECT groupName FROM `groups` AS g INNER JOIN group_field AS gf ON gf.groupID = g.groupID\n&quot; +</span>
                &quot;INNER JOIN `fields` AS f ON f.fieldID = gf.fieldID\n&quot; +
                &quot;WHERE f.fieldName = ? AND g.term = ? ORDER BY RIGHT(groupName,1)&quot;

<span class="fc" id="L223">        return DBQueryExecutor.executeQuery(query, fieldName, sem){</span>
<span class="fc" id="L224">                resultSet -&gt; resultSet.getString(1)</span>
        }
    }


    /**
     * Metoda dodająca grupy do podanego kierunku i semestru do bazy danych.
     *
     * @param field Kierunek, do którego należy przypisać grupy
     * @param groupsNum Liczba grup
     * @param sem Numer semestru, na jaki należy przypisać grupy
     * @param shortcutRoman Liczba rzymska odpowiadająca numerowi semestru
     */
    @Throws(SQLException::class)
    override fun addGroups(field: Field, groupsNum: Int, sem: Int, shortcutRoman: String) {
<span class="fc" id="L239">        val query = &quot;{ CALL addGroups(?,?,?,?,?) }&quot;</span>
<span class="fc" id="L240">        DBQueryExecutor.executePreparedStatement(query, field.fieldName, field.shortcut, groupsNum, sem, shortcutRoman)</span>
<span class="fc" id="L241">    }</span>

    /**
     * Metoda aktualizująca kierunek kształcenia w bazie danych przy użyciu procedury z bazy danych.
     *
     * @param fieldID Id kierunku do aktualizacji
     * @param fieldName Nowa nazwa kierunku
     * @param shortcut Nowy skrót nazwy kierunku
     */
    @Throws(SQLException::class)
    override fun updateField(fieldID: Int, fieldName: String, shortcut: String) {
<span class="fc" id="L252">        val query = &quot;{ CALL updateField(?,?,?) }&quot;</span>
<span class="fc" id="L253">        DBQueryExecutor.executePreparedStatement(query, fieldID, fieldName, shortcut)</span>
<span class="fc" id="L254">    }</span>


    /**
     * Metoda usuwająca grupę z bazy danych
     *
     * @param group Grupa do usunięcia
     */
    @Throws(SQLException::class)
    override fun deleteGroup(group: Group) {
<span class="fc" id="L264">        val query = &quot;{ CALL deleteGroup(?,?,?) }&quot;</span>
<span class="fc" id="L265">        DBQueryExecutor.executePreparedStatement(query, group.groupName, group.sem, group.fieldName)</span>
<span class="fc" id="L266">    }</span>


    /**
     * Metoda usuwająca kierunek kształcenia z bazy danych.
     * Przy usuwaniu kierunku usuwane są także wszystkie grupy z nim związane
     * oraz wszystkie zajęcia związane z tymi grupami we wszystkich planach
     *
     * @param field Kierunek do usunięcia
     */
    @Throws(SQLException::class)
    override fun deleteField(field: Field) {
<span class="fc" id="L278">        val query = &quot;{ CALL deleteField(?,?,?) }&quot;</span>
<span class="fc" id="L279">        DBQueryExecutor.executePreparedStatement(query, field.fieldName, field.semsNumber, field.shortcut)</span>
<span class="fc" id="L280">    }</span>


    /**
     * Metoda pobierająca liczbę semestrów na danym kierunku.
     *
     * @param field Nazwa kierunku
     * @return Liczba semestrów na danym kierunku
     */
    override fun getSemesters(field: String): Int {
<span class="fc" id="L290">        val query = &quot;SELECT DISTINCT semNumber FROM fields WHERE fieldName = ?&quot;</span>

<span class="fc" id="L292">        return DBQueryExecutor.executeQuery(query, field){ resultSet -&gt; resultSet.getInt(1) }.first()</span>
    }

    /**
     * Pobiera szkolny plan nauczania dla określonego kierunku kształcenia.
     *
     * @param field kierunek, dla którego ma zostać pobrany szkolny plan nauczania.
     * @return Szkolny plan nauczania dla wybranego kierunku w formie listy obiektów TeachingPlan.
     */
    override fun showSPN(field: Field): ObservableList&lt;TeachingPlan&gt; {

<span class="fc" id="L303">        val columnSubquery = (1..field.semsNumber).joinToString(&quot;, &quot;) { &quot;MAX(CASE WHEN fs.term = $it THEN fs.weeklyHours END)&quot; }</span>

<span class="fc" id="L305">        val query = &quot;SELECT s.subjectName, $columnSubquery\n&quot; +</span>
                &quot;FROM field_subject AS fs\n&quot; +
                &quot;INNER JOIN `fields` AS f ON f.fieldID = fs.fieldID\n&quot; +
                &quot;INNER JOIN subjects AS s ON s.subjectID = fs.subjectID\n&quot; +
                &quot;WHERE f.fieldName = ?\n&quot; +
                &quot;GROUP BY s.subjectName\n&quot; +
                &quot;ORDER BY s.subjectID;&quot;


<span class="fc" id="L314">        return DBQueryExecutor.executeQuery(query,field.fieldName){</span>
                resultSet -&gt;
<span class="fc" id="L316">            TeachingPlan(</span>
<span class="fc" id="L317">                subjectName = resultSet.getString(1),</span>
<span class="fc" id="L318">                semesters = FXCollections.observableArrayList(</span>
<span class="fc" id="L319">                    (1..field.semsNumber).map { resultSet.getInt(it + 1)}</span>
                ))
        }


    }

    /**
     * Pobiera listę wszystkich kierunków kształcenia.
     *
     * @return Lista wszystkich kierunków kształcenia.
     */
    override fun getFields(): ObservableList&lt;Field&gt; {
<span class="fc" id="L332">        val query = &quot;SELECT fieldName, semNumber, fieldShort FROM fields ORDER BY fieldName&quot;</span>

<span class="fc" id="L334">        return DBQueryExecutor.executeQuery(query){</span>
                resultSet -&gt;
<span class="fc" id="L336">            Field(</span>
<span class="fc" id="L337">                fieldName = resultSet.getString(1),</span>
<span class="fc" id="L338">                semsNumber = resultSet.getInt(2),</span>
<span class="fc" id="L339">                shortcut = resultSet.getString(3))</span>
        }
    }

    /**
     * Pobiera wszystkie grupy dla określonego kierunku kształcenia.
     *
     * @param field Nazwa kierunku kształcenia.
     * @return Lista grup.
     */
    override fun getGroupsByField(field: String): ObservableList&lt;String&gt; {
<span class="fc" id="L350">        val query = &quot;SELECT groupName FROM `groups` INNER JOIN group_field ON group_field.groupID = `groups`.groupID \n&quot; +</span>
                &quot;INNER JOIN fields ON fields.fieldID = group_field.fieldID WHERE fieldName = ?\n&quot; +
                &quot;ORDER BY\n&quot; +
                &quot;  CASE\n&quot; +
                &quot;    WHEN groupName LIKE 'I%' THEN 1\n&quot; +
                &quot;    WHEN groupName LIKE 'II%' THEN 2\n&quot; +
                &quot;    WHEN groupName LIKE 'III%' THEN 3\n&quot; +
                &quot;    WHEN groupName LIKE 'IV%' THEN 4\n&quot; +
                &quot;    WHEN groupName LIKE 'V%' THEN 5\n&quot; +
                &quot;    WHEN groupName LIKE 'VI%' THEN 6\n&quot; +
                &quot;    WHEN groupName LIKE 'VII%' THEN 7\n&quot; +
                &quot;    WHEN groupName LIKE 'VIII%' THEN 8\n&quot; +
                &quot;    WHEN groupName LIKE 'IX%' THEN 9\n&quot; +
                &quot;    WHEN groupName LIKE 'X%' THEN 10\n&quot; +
                &quot;  END,\n&quot; +
                &quot;  groupName;&quot;
<span class="fc" id="L366">        return DBQueryExecutor.executeQuery(query, field){</span>
<span class="fc" id="L367">                resultSet -&gt; resultSet.getString(1) }</span>
    }

    /**
     * Usuwa szkolny plan nauczania związany z określonym kierunkiem kształcenia.
     *
     * @param fieldName Nazwa kierunku, dla którego należy usunąć szkolny plan nauczania.
     */
    @Throws(SQLException::class)
    override fun deleteSPN(fieldName: String) {
<span class="fc" id="L377">        val query = &quot;{ CALL deleteFromSPNByField(?) }&quot;</span>
<span class="fc" id="L378">        DBQueryExecutor.executePreparedStatement(query, fieldName)</span>
<span class="fc" id="L379">    }</span>

    /**
     * Sprawdza, czy kierunek kształcenia istnieje w bazie danych.
     *
     * @param fieldName Nazwa kierunku studiów do sprawdzenia.
     * @return `true`, jeśli kierunek istnieje; w przeciwnym razie `false`.
     */
    override fun checkIfFieldExists(fieldName: String):Boolean {
<span class="nc" id="L388">        val query = &quot;SELECT COUNT(*) FROM fields WHERE fieldName = ?&quot;</span>

<span class="nc" id="L390">        return DBQueryExecutor.executeQuery(query,</span>
<span class="nc" id="L391">            fieldName)</span>
<span class="nc" id="L392">        {resultSet -&gt; resultSet.getBoolean(1)}.first()</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>