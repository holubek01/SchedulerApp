<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LocationDAOImpl.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Scheduler</a> &gt; <a href="index.source.html" class="el_package">com.example.scheduler.db.dao</a> &gt; <span class="el_source">LocationDAOImpl.kt</span></div><h1>LocationDAOImpl.kt</h1><pre class="source lang-java linenums">package com.example.scheduler.db.dao

import com.example.scheduler.db.DBQueryExecutor
import com.example.scheduler.objects.Location
import javafx.collections.ObservableList
import java.sql.SQLException

/**
 * Implementacja interfejsu `LocationDAO` do obsługi operacji w bazie danych dla lokalizacji
 */
<span class="fc" id="L11">class LocationDAOImpl: LocationDAO {</span>

    /**
     * Metoda pobierająca listę wszystkich lokalizacji oprócz Platformy.
     *
     * @return Lista wszystkich lokalizacji
     */
    override fun getLocations(): ObservableList&lt;Location&gt; {
<span class="fc" id="L19">        val query = &quot;SELECT name, city, street, postcode FROM location AS l WHERE l.name != 'Platform' ORDER BY name&quot;</span>

<span class="fc" id="L21">        return DBQueryExecutor.executeQuery(query){</span>
                resultSet -&gt;
<span class="fc" id="L23">            Location(</span>
<span class="fc" id="L24">                locationName = resultSet.getString(1),</span>
<span class="fc" id="L25">                city = resultSet.getString(2),</span>
<span class="fc" id="L26">                street = resultSet.getString(3),</span>
<span class="fc" id="L27">                postcode = resultSet.getString(4)</span>
            )
        }
    }


    /**
     * Metoda dodająca lokalizację do bazy danych przy użyciu procedury z bazy danych.
     *
     * @param location Lokalizacja do dodania do bazy danych
     */
    @Throws(SQLException::class)
    override fun addLocation(location: Location) {
<span class="fc" id="L40">        val query = &quot;{ CALL addLocation(?,?,?,?) }&quot;</span>
<span class="fc" id="L41">        DBQueryExecutor.executePreparedStatement(</span>
<span class="fc" id="L42">            query,</span>
<span class="fc" id="L43">            location.locationName,</span>
<span class="fc" id="L44">            location.city,</span>
<span class="fc" id="L45">            location.street,</span>
<span class="fc" id="L46">            location.postcode</span>
        )
<span class="fc" id="L48">    }</span>


    /**
     * Metoda aktualizująca lokalizację w bazie danych przy użyciu procedury z bazy danych.
     *
     * @param locationID Id lokalizacji do aktualizacji
     * @param location Lokalizacja do aktualizacji
     */
    @Throws(SQLException::class)
    override fun updateLocation(locationID: Int, location: Location) {
<span class="nc" id="L59">        val query = &quot;{ CALL updateLocation(?,?,?,?,?) }&quot;</span>
<span class="nc" id="L60">        DBQueryExecutor.executePreparedStatement(</span>
<span class="nc" id="L61">            query,</span>
<span class="nc" id="L62">            locationID,</span>
<span class="nc" id="L63">            location.locationName,</span>
<span class="nc" id="L64">            location.city,</span>
<span class="nc" id="L65">            location.street,</span>
<span class="nc" id="L66">            location.postcode</span>
        )
<span class="nc" id="L68">    }</span>

    /**
     * Metoda usuwająca lokalizację z bazy danych.
     * Przy usuwaniu lokalizacji usuwane są także wszystkie sale z nią związane
     * a zajęcia, które planowo miały się odbyć w jednej z takich sal są zastępowane salą wirtualną
     *
     * @param location Lokalizacja do usunięcia
     */
    @Throws(SQLException::class)
    override fun deleteLocation(location: Location) {
<span class="fc" id="L79">        val query = &quot;{ CALL deleteLocation(?,?,?,?) }&quot;</span>
<span class="fc" id="L80">        DBQueryExecutor.executePreparedStatement(</span>
<span class="fc" id="L81">            query,</span>
<span class="fc" id="L82">            location.locationName,</span>
<span class="fc" id="L83">            location.city,</span>
<span class="fc" id="L84">            location.street,</span>
<span class="fc" id="L85">            location.postcode</span>
        )
<span class="fc" id="L87">    }</span>

    /**
     * Pobiera nazwy wszystkich lokalizacji z bazy danych, uporządkowane alfabetycznie.
     *
     * @return Lista nazw lokalizacji.
     */
    override fun getLocationsNames(): ObservableList&lt;String&gt; {
<span class="fc" id="L95">        val query = &quot;SELECT name FROM location ORDER BY name&quot;</span>
<span class="fc" id="L96">        return DBQueryExecutor.executeQuery(query){ resultSet -&gt; resultSet.getString(1) }</span>
    }


    /**
     * Sprawdza, czy lokalizacja, która nie jest lokalizacją 'selectedLocation' istnieje w bazie danych.
     *
     * @param location          Nazwa lokalizacji do sprawdzenia.
     * @param lastSelectedLocation   Wybrana lokalizacja do edycji (pomijana).
     * @return                  `true`, jeśli lokalizacja istnieje; `false` w przeciwnym razie.
     */
    override fun checkIfLocationInDbEdit(location: Location, lastSelectedLocation: Location): Boolean {
<span class="fc" id="L108">        val query = &quot;SELECT COUNT(*) FROM location AS l\n&quot; +</span>
                &quot;WHERE (l.name = ? AND l.city =\n&quot; +
                &quot;? AND l.street = ? AND l.postcode = ? )\n&quot; +
                &quot;AND l.locationId != (SELECT locationId FROM location AS l WHERE l.name =? AND l.city =? \n&quot; +
                &quot;AND l.street =? AND l.postcode = ?)&quot;

<span class="fc" id="L114">        return DBQueryExecutor.executeQuery(query,</span>
<span class="fc" id="L115">            location.locationName,</span>
<span class="fc" id="L116">            location.city,</span>
<span class="fc" id="L117">            location.street,</span>
<span class="fc" id="L118">            location.postcode,</span>
<span class="fc" id="L119">            lastSelectedLocation.locationName,</span>
<span class="fc" id="L120">            lastSelectedLocation.city,</span>
<span class="fc" id="L121">            lastSelectedLocation.street,</span>
<span class="fc" id="L122">            lastSelectedLocation.postcode)</span>
<span class="fc" id="L123">        {resultSet -&gt; resultSet.getBoolean(1)}.first()</span>
    }


    /**
     * Sprawdza, czy lokalizacja, istnieje w bazie danych.
     *
     * @param location          Nazwa lokalizacji
     * @return                 `true`, jeśli lokalizacja istnieje; `false` w przeciwnym razie.
     */
    override fun checkIfLocationInDb(location: Location): Boolean {
<span class="fc" id="L134">        val query = &quot;SELECT COUNT(*) FROM location AS l &quot; +</span>
                &quot;WHERE l.name = ? AND l.city = ? AND l.street = ? AND l.postcode = ?&quot;

<span class="fc" id="L137">        return DBQueryExecutor.executeQuery(query,</span>
<span class="fc" id="L138">            location.locationName,</span>
<span class="fc" id="L139">            location.city,</span>
<span class="fc" id="L140">            location.street,</span>
<span class="fc" id="L141">            location.postcode</span>
        )
<span class="fc" id="L143">        {resultSet -&gt; resultSet.getBoolean(1)}.first()</span>
    }

    /**
     * Sprawdza, czy nazwa lokalizacji lub miasto i ulica, które nie są przypisane do wybranej lokalizacji, istnieje w bazie danych
     * i jest różne od 'selectedLocation'.
     *
     * @param location          Lokalizacja do sprawdzenia
     * @param selectedLocation   Wybrana lokalizacja do edycji (pomijana).
     * @return                  `true`, jeśli dane istnieją, `false` w przeciwnym razie.
     */
    override fun checkIfLocationNameOrStreetInDbEdit(location: Location, selectedLocation: Location): Boolean {
<span class="fc" id="L155">        val query = &quot;SELECT COUNT(*) FROM location AS l\n&quot; +</span>
                &quot;WHERE (l.name = ? OR (l.city = ? AND l.street = ? ))\n&quot; +
                &quot;AND l.locationId != (SELECT locationId FROM location WHERE \n&quot; +
                &quot;location.name = ? AND location.city = ? AND location.street = ? AND location.postcode = ? )&quot;

<span class="fc" id="L160">        return DBQueryExecutor.executeQuery(query,</span>
<span class="fc" id="L161">            location.locationName,</span>
<span class="fc" id="L162">            location.city,</span>
<span class="fc" id="L163">            location.street,</span>
<span class="fc" id="L164">            selectedLocation.locationName,</span>
<span class="fc" id="L165">            selectedLocation.city,</span>
<span class="fc" id="L166">            selectedLocation.street,</span>
<span class="fc" id="L167">            selectedLocation.postcode</span>
        )
<span class="fc" id="L169">        {resultSet -&gt; resultSet.getBoolean(1)}.first()</span>
    }

    /**
     * Sprawdza, czy nazwa lokalizacji lub miasto i ulica, istnieje w bazie danych.
     *
     * @param locationName      Nazwa lokalizacji
     * @param city              Nazwa miasta
     * @param street            Nazwa ulicy
     * @return                  `true`, jeśli dane istnieją; `false` w przeciwnym razie.
     */
    override fun checkIfLocationNameOrStreetInDb(locationName: String, city: String, street: String): Boolean {
<span class="fc" id="L181">        val query = &quot;SELECT COUNT(*) FROM location AS l &quot; +</span>
                &quot;WHERE l.name = ? OR ( l.city = ? AND l.street = ? ) &quot;

<span class="fc" id="L184">        return DBQueryExecutor.executeQuery(query, locationName, city, street)</span>
<span class="fc" id="L185">        {resultSet -&gt; resultSet.getBoolean(1)}.first()</span>
    }


    /**
     * Metoda pobierająca id podanej lokalizacji.
     *
     * @param lastSelectedLocation Obiekt Location, którego id chcemy uzyskać
     * @return Id lokalizacji
     */
    override fun getLocationID(lastSelectedLocation: Location): Int {
<span class="fc" id="L196">        val query = &quot;SELECT locationID FROM location AS l &quot; +</span>
                &quot;WHERE l.name = ? AND l.city = ? AND l.street = ? AND l.postcode = ?&quot;

<span class="fc" id="L199">        return DBQueryExecutor.executeQuery(query,</span>
<span class="fc" id="L200">            lastSelectedLocation.locationName,</span>
<span class="fc" id="L201">            lastSelectedLocation.city,</span>
<span class="fc" id="L202">            lastSelectedLocation.street,</span>
<span class="fc" id="L203">            lastSelectedLocation.postcode</span>
        )
<span class="fc" id="L205">        {resultSet -&gt; resultSet.getInt(1)}.first()</span>
    }

    /**
     * Metoda pobierająca lokalizację o podanym id.
     *
     * @param id    Id lokalizacji
     * @return      Obiekt Location reprezentujący lokalizację
     */
    override fun getLocationById(id: Int): Location {
<span class="fc" id="L215">        val query = &quot;SELECT name, city, street, postcode FROM location AS l WHERE l.locationID = ?&quot;</span>

<span class="fc" id="L217">        return DBQueryExecutor.executeQuery(query, id){</span>
                resultSet -&gt;
<span class="fc" id="L219">            Location(</span>
<span class="fc" id="L220">                locationName = resultSet.getString(1),</span>
<span class="fc" id="L221">                city = resultSet.getString(2),</span>
<span class="fc" id="L222">                street = resultSet.getString(3),</span>
<span class="fc" id="L223">                postcode = resultSet.getString(4)</span>
            )
<span class="fc" id="L225">        }.first()</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>